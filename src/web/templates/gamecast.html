{% extends "base.html" %}
{% set active = "gamecast" %}
{% block title %}Gamecast â€” NBA Predictor{% endblock %}

{% block content %}
<h1 class="section-header">Gamecast</h1>

<!-- Game Selector -->
<div class="card mb-4 game-selector" id="game-selector" style="padding:0; overflow:hidden;">
    <h2 class="game-selector-toggle" onclick="toggleGameSelector()" style="margin:0; padding:16px; cursor:pointer; display:flex; justify-content:space-between; align-items:center;">
        <span>Select Game</span>
        <span class="toggle-icon" id="gameSelectorIcon">&#9660;</span>
    </h2>
    <div id="gameList" class="games-list stagger-in" style="display:flex; flex-direction:column; padding:0 16px 16px 16px; gap:8px;">
        <div class="skeleton skeleton-card"></div>
        <div class="skeleton skeleton-card"></div>
        <div class="skeleton skeleton-card"></div>
    </div>
</div>

    <div id="gameDetail" class="hidden">
    <!-- Timeout Overlay (click to dismiss) -->
    <div id="timeoutOverlay" class="timeout-overlay" onclick="dismissTimeout()">
        <span>TIMEOUT:</span><span id="timeoutSeconds">75</span><span>s</span>
    </div>

    <!-- Substitution Overlay (click to dismiss) -->
    <div id="subOverlay" class="sub-overlay" onclick="dismissSub()">
        <div class="sub-player">
            <span class="sub-label sub-label-in">IN</span>
            <img id="subInImg" src="" class="sub-photo sub-photo-in" onerror="this.onerror=null; this.style.display='none';">
            <span id="subInName" class="sub-name"></span>
            <span id="subInStats" class="sub-stats"></span>
        </div>
        <div class="sub-arrows">
            <span style="transform: scaleX(-1);">&#10148;</span>
            <span>&#10148;</span>
        </div>
        <div class="sub-player">
            <span class="sub-label sub-label-out">OUT</span>
            <img id="subOutImg" src="" class="sub-photo sub-photo-out" onerror="this.onerror=null; this.style.display='none';">
            <span id="subOutName" class="sub-name"></span>
            <span id="subOutStats" class="sub-stats"></span>
        </div>
    </div>

    <!-- Live Score -->
    <div class="score-card" id="score-card">
        <!-- Skewed Backgrounds -->
        <div id="awayBgAccent" class="score-bg-accent score-bg-away"></div>
        <div id="homeBgAccent" class="score-bg-accent score-bg-home"></div>

        <!-- Top Status Banner -->
        <div class="score-status-banner">
            <div id="statusBadge" class="live-badge" style="display:none; margin: 0 auto 4px auto; width: fit-content;">LIVE</div>
            <div id="finalBadge" class="final-badge" style="display:none; margin: 0 auto 4px auto; width: fit-content;">FINAL</div>
            <div id="clockContainer" style="display:flex; justify-content:center; align-items:center; gap: 8px;">
                <span id="period" style="font-weight:bold; font-size:0.8rem;"></span>
                <span id="clock" style="font-size:0.9rem; font-weight:700;"></span>
            </div>
            <div id="statusText" class="text-xs text-muted font-bold" style="display:none;"></div>
        </div>

        <!-- Side Glowing Borders -->
        <div id="awayGlow" class="score-glow score-glow-away"></div>
        <div id="homeGlow" class="score-glow score-glow-home"></div>

        <!-- Score Content -->
        <div class="score-display">
            <!-- AWAY TEAM -->
            <div class="score-team">
                <div class="score-team-info">
                    <img id="awayLogo" src="" class="team-logo-lg drop-shadow" alt="" onerror="this.style.display='none'">
                    <div class="team-abbr drop-shadow" id="awayTeam">AWY</div>
                    <div class="team-extras">
                        <div id="awayBonus" class="bonus-text">BONUS</div>
                        <div id="awayTimeouts" class="timeout-dots"></div>
                    </div>
                </div>
                <span class="team-score drop-shadow" id="awayScore">0</span>
            </div>

            <!-- CENTER VS -->
            <div class="score-center">
                <span id="vsText" class="vs-text">VS</span>
            </div>

            <!-- HOME TEAM -->
            <div class="score-team">
                <div class="score-team-info">
                    <img id="homeLogo" src="" class="team-logo-lg drop-shadow" alt="" onerror="this.style.display='none'">
                    <div class="team-abbr drop-shadow" id="homeTeam">HOM</div>
                    <div class="team-extras">
                        <div id="homeBonus" class="bonus-text">BONUS</div>
                        <div id="homeTimeouts" class="timeout-dots"></div>
                    </div>
                </div>
                <span class="team-score drop-shadow" id="homeScore">0</span>
            </div>
        </div>

        <!-- Quarter Scores -->
        <div class="quarter-scores-wrap">
            <div class="quarter-scores-inner" id="quarterScores"></div>
        </div>

        <!-- Animated Score Banner -->
        <div id="scoreBanner" class="score-banner">TEAM SCORE!</div>

        <!-- Flash Overlays -->
        <div id="awayFlash" class="score-flash score-flash-away"></div>
        <div id="homeFlash" class="score-flash score-flash-home"></div>
    </div>

    <!-- Desktop: sidebar + main layout / Mobile: stacked -->
    <div class="gamecast-body">

        <!-- SIDEBAR: Prediction, Odds, Flow Stats -->
        <div class="gamecast-sidebar">
            <!-- Prediction -->
            <div class="card">
                <h2>Model Prediction</h2>

                <!-- Win Probability -->
                <div class="win-prob-container mt-2 mb-4">
                    <div class="win-prob-labels">
                        <span><span id="awayLabelWp">AWAY</span> <span id="wpAway">50%</span></span>
                        <span><span id="wpHome">50%</span> <span id="homeLabelWp">HOME</span></span>
                    </div>
                    <div class="win-prob-bar">
                        <div class="win-prob-away" id="wpBarAway" style="width: 50%"></div>
                        <div class="win-prob-home" id="wpBarHome" style="width: 50%"></div>
                    </div>
                </div>

                <div id="predictionInfo" class="pred-summary">
                    <div class="text-muted text-sm" style="grid-column: 1 / -1;">Waiting for prediction...</div>
                </div>
            </div>

            <!-- Vegas Odds -->
            <div class="card">
                <h2>Vegas Odds</h2>
                <div id="oddsInfo" class="odds-grid mt-2">
                    <div class="text-muted text-sm" style="grid-column: 1 / -1;">Loading...</div>
                </div>
            </div>

            <!-- Game Flow Stats -->
            <div class="card">
                <h2>Game Flow Stats</h2>
                <div class="flow-stats">
                    <div class="flow-stat">
                        <span class="flow-stat-label">Drives Scored</span>
                        <div class="flow-stat-value">
                            <span id="awayDrives" style="color: var(--team-away);">0</span> - <span id="homeDrives" style="color: var(--team-home);">0</span>
                        </div>
                    </div>
                    <div class="flow-stat">
                        <span class="flow-stat-label">Poss Scored</span>
                        <div class="flow-stat-value">
                            <span id="awayPoss" style="color: var(--team-away);">0</span> - <span id="homePoss" style="color: var(--team-home);">0</span>
                        </div>
                    </div>
                    <div class="flow-stat">
                        <span class="flow-stat-label">Current Run</span>
                        <div id="currentRun" class="flow-stat-value">None</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MAIN: Shot Chart, Play-by-Play, Box Score -->
        <div class="gamecast-main">
            <!-- Play-by-Play & Court Visualization -->
            <div class="gamecast-court-plays">
                <div class="card court-card">
                    <div class="court-header">
                        <h2>Shot Chart</h2>
                        <div class="court-toggle" id="courtToggle">
                            <button class="court-toggle-btn" data-filter="away" onclick="setCourtFilter('away')">
                                <span class="court-toggle-dot" id="courtDotAway"></span>
                                <span id="courtLabelAway">Away</span>
                            </button>
                            <button class="court-toggle-btn active" data-filter="both" onclick="setCourtFilter('both')">Both</button>
                            <button class="court-toggle-btn" data-filter="home" onclick="setCourtFilter('home')">
                                <span id="courtLabelHome">Home</span>
                                <span class="court-toggle-dot" id="courtDotHome"></span>
                            </button>
                        </div>
                    </div>
                    <div class="court-wrap">
                        <canvas id="courtCanvas" width="600" height="564"></canvas>
                        <div class="court-stats" id="courtStats"></div>
                        <div class="court-tooltip" id="courtTooltip"></div>
                    </div>
                </div>

                <div class="card">
                    <h2>Play-by-Play</h2>
                    <div class="play-feed" id="plays"></div>
                </div>
            </div>

            <!-- Box Score -->
            <div class="card">
                <h2>Box Score</h2>
                <div class="tabs" id="boxTabs" style="margin-bottom: 12px; display:flex; gap: 8px;">
                    <button class="btn btn-primary" id="btnBoxAway" onclick="switchBoxTab('away')"><span id="boxAwayLabel">Away</span></button>
                    <button class="btn btn-outline" id="btnBoxHome" onclick="switchBoxTab('home')"><span id="boxHomeLabel">Home</span></button>
                </div>
                <div id="boxAway" class="tab-content active">
                    <div class="scroll-x" style="max-height: 400px; overflow-y: auto;">
                        <table class="box-table" id="boxAwayTable" style="width:100%;text-align:left;">
                            <thead style="position: sticky; top: 0; background: var(--bg-card); z-index: 1;"><tr><th style="width:32px"></th><th>Player</th><th>MIN</th><th>PTS</th><th>REB</th><th>AST</th><th>STL</th><th>BLK</th><th>FG</th><th>3PT</th><th>PF</th><th>+/-</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                <div id="boxHome" class="tab-content" style="display:none;">
                    <div class="scroll-x" style="max-height: 400px; overflow-y: auto;">
                        <table class="box-table" id="boxHomeTable" style="width:100%;text-align:left;">
                            <thead style="position: sticky; top: 0; background: var(--bg-card); z-index: 1;"><tr><th style="width:32px"></th><th>Player</th><th>MIN</th><th>PTS</th><th>REB</th><th>AST</th><th>STL</th><th>BLK</th><th>FG</th><th>3PT</th><th>PF</th><th>+/-</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
/* Game Selector Styles */
.game-selector-toggle {
    user-select: none;
    font-size: 1rem;
    transition: background 0.2s;
}
.game-selector-toggle:hover {
    background: rgba(255,255,255,0.03);
}
.toggle-icon {
    font-size: 0.75rem;
    color: var(--text-muted);
}
.game-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    border-radius: 8px;
    background: rgba(255,255,255,0.02);
    text-decoration: none;
    color: var(--text);
    transition: background 0.2s, transform 0.1s, border 0.2s;
    border: 1px solid transparent;
}
.game-row:hover {
    background: rgba(255,255,255,0.05);
}
.game-row.active {
    border-color: var(--accent);
    background: rgba(59, 130, 246, 0.1);
}
.game-teams {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 700;
}
.team-logo-small {
    width: 24px;
    height: 24px;
    object-fit: contain;
    filter: drop-shadow(0 1px 2px rgba(0,0,0,0.5));
}
.at {
    color: var(--text-muted);
    font-weight: 400;
    font-size: 0.8rem;
    margin: 0 4px;
}
.game-status {
    font-size: 0.85rem;
    font-weight: 600;
    text-align: right;
}

/* Score Display */
.drop-shadow {
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
}
.score-display {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 0;
}

.score-team {
  display: flex;
  flex-direction: column;
  flex: 1;
}

.team-score {
  font-family: var(--font-heading);
  font-size: 3rem;
  font-weight: 700;
  line-height: 1;
}

.score-status {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  min-width: 80px;
}

.live-badge {
  background: var(--danger);
  color: white;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 0.75rem;
  font-weight: 800;
  letter-spacing: 1px;
  animation: pulse 2s infinite;
  box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
}

.final-badge {
  background: var(--border);
  color: var(--text);
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 0.75rem;
  font-weight: 800;
  letter-spacing: 1px;
}

@keyframes pulse {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.8; transform: scale(1.05); }
}

/* Win Probability */
.win-prob-container {
  margin-bottom: 20px;
}

.win-prob-labels {
  display: flex;
  justify-content: space-between;
  font-size: 0.875rem;
  font-weight: 600;
  margin-bottom: 8px;
}

.win-prob-bar {
  display: flex;
  height: 12px;
  border-radius: 6px;
  overflow: hidden;
  background: var(--bg-dark);
}

.win-prob-away {
  background: var(--danger);
  transition: width 0.5s ease;
}

.win-prob-home {
  background: var(--accent);
  transition: width 0.5s ease;
}

/* Odds Grid */
.odds-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
}

.odds-item {
  background: var(--bg-dark);
  border-radius: 8px;
  padding: 12px;
  text-align: center;
  box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
}

.odds-label {
  display: block;
  font-size: 0.75rem;
  color: var(--text-muted);
  text-transform: uppercase;
  margin-bottom: 4px;
  font-weight: 600;
}

.odds-value {
  display: block;
  font-size: 1.25rem;
  font-weight: 800;
  color: var(--text);
}

/* Prediction Summary */
.pred-summary {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 8px;
  margin-top: 12px;
}

.pred-item {
  background: var(--bg-dark);
  border-radius: 6px;
  padding: 10px;
  text-align: center;
  box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
}

.pred-label {
  display: block;
  font-size: 0.7rem;
  color: var(--text-muted);
  text-transform: uppercase;
  margin-bottom: 4px;
  font-weight: 600;
}

.pred-value {
  font-size: 1rem;
  font-weight: 800;
}

/* Play Feed */
.play-feed {
  max-height: 400px;
  overflow-y: auto;
  border-radius: 6px;
  background: var(--bg-dark);
  box-shadow: inset 0 2px 8px rgba(0,0,0,0.2);
}

.play-item {
  padding: 12px;
  border-bottom: 1px solid var(--border);
  transition: background 0.3s;
}

.play-item:last-child {
  border-bottom: none;
}

.play-item.new {
  background: rgba(255, 255, 255, 0.05);
}

.play-meta {
  display: flex;
  gap: 8px;
  font-size: 0.75rem;
  color: var(--text-muted);
  margin-bottom: 4px;
}

.play-period {
  font-weight: 800;
  color: var(--text);
}

.play-body {
  display: flex;
  align-items: flex-start;
  gap: 8px;
}

.play-team-badge {
  display: inline-block;
  flex-shrink: 0;
  min-width: 38px;
  text-align: center;
  font-size: 0.75rem;
  font-weight: 800;
  padding: 3px 6px;
  border-radius: 4px;
  letter-spacing: 0.3px;
  background: rgba(255,255,255,0.1);
  color: var(--text);
}

.play-text {
  font-size: 0.9rem;
  line-height: 1.4;
  flex: 1;
}

.play-score {
  font-size: 0.875rem;
  font-weight: 800;
  color: var(--text-muted);
  margin-top: 4px;
}

/* Team-colored play borders */
.play-item.play-home {
  border-left: 4px solid var(--team-home);
}
.play-item.play-away {
  border-left: 4px solid var(--team-away);
}
.play-item.scoring {
  border-left-color: var(--success) !important;
  background: rgba(34, 197, 94, 0.05);
}
.play-item.foul-play {
  background: rgba(239, 68, 68, 0.05);
}

/* Foul tags */
.foul-tag {
  display: inline-block;
  font-size: 0.65rem;
  font-weight: 800;
  text-transform: uppercase;
  padding: 1px 5px;
  border-radius: 3px;
  background: rgba(239, 68, 68, 0.2);
  color: #ef4444;
  letter-spacing: 0.5px;
}
.foul-tag.foul-shooting {
  background: rgba(245, 158, 11, 0.2);
  color: #f59e0b;
}
.foul-tag.foul-flagrant {
  background: rgba(220, 38, 38, 0.3);
  color: #dc2626;
}
.foul-tag.foul-technical {
  background: rgba(168, 85, 247, 0.2);
  color: #a855f7;
}

/* Box Score Table */
.scroll-x {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  margin: 0 -16px;
  padding: 0 16px;
}
.box-table {
  font-size: 0.85rem;
  min-width: 600px;
}

.box-table th {
  font-size: 0.75rem;
  padding: 10px 8px;
  color: var(--text-muted);
  font-weight: 700;
  border-bottom: 2px solid var(--border);
}

.box-table td {
  padding: 10px 8px;
  border-bottom: 1px solid var(--border);
}

/* ---- Shot Chart Court Card ---- */
.court-card {
  padding: 0 !important;
  overflow: hidden;
}

.court-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 20px 12px;
}

.court-header h2 {
  margin: 0;
}

.court-toggle {
  display: flex;
  background: rgba(0,0,0,0.3);
  border-radius: 8px;
  padding: 3px;
  gap: 2px;
}

.court-toggle-btn {
  background: none;
  border: none;
  color: var(--text-muted);
  font-size: 0.75rem;
  font-weight: 700;
  padding: 5px 12px;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 5px;
  text-transform: uppercase;
  letter-spacing: 0.04em;
}

.court-toggle-btn:hover {
  color: var(--text);
  background: rgba(255,255,255,0.05);
}

.court-toggle-btn.active {
  background: rgba(255,255,255,0.12);
  color: var(--text);
}

.court-toggle-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  display: inline-block;
}

#courtDotAway { background: var(--team-away, #ef4444); }
#courtDotHome { background: var(--team-home, #3b82f6); }

.court-wrap {
  position: relative;
  width: 100%;
  background: #2a1a0e;
}

.court-wrap canvas {
  display: block;
  width: 100%;
  height: auto;
}

.court-stats {
  position: absolute;
  bottom: 10px;
  left: 10px;
  display: flex;
  gap: 12px;
  font-size: 0.7rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  pointer-events: none;
}

.court-stat-pill {
  background: rgba(0,0,0,0.6);
  backdrop-filter: blur(4px);
  padding: 4px 10px;
  border-radius: 4px;
  color: #e2e8f0;
  display: flex;
  align-items: center;
  gap: 6px;
}

.court-stat-pill .cs-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
}

.court-stat-pill .cs-val {
  font-family: var(--font-heading);
  font-size: 0.85rem;
}

.court-tooltip {
  display: none;
  position: absolute;
  pointer-events: none;
  background: rgba(10,15,25,0.92);
  backdrop-filter: blur(6px);
  border: 1px solid rgba(255,255,255,0.15);
  border-radius: 6px;
  padding: 8px 12px;
  font-size: 0.78rem;
  color: #e2e8f0;
  max-width: 240px;
  line-height: 1.4;
  z-index: 10;
  box-shadow: 0 4px 16px rgba(0,0,0,0.5);
  transform: translate(-50%, -100%);
  margin-top: -10px;
}

.court-tooltip .ct-result {
  font-weight: 800;
  font-size: 0.65rem;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  margin-bottom: 3px;
}

.court-tooltip .ct-text {
  font-weight: 500;
}

.court-tooltip .ct-clock {
  color: rgba(255,255,255,0.45);
  font-size: 0.7rem;
  margin-top: 2px;
}

.court-wrap canvas {
  cursor: crosshair;
}

/* Responsive adjustments */
@media (max-width: 600px) {
  .team-score { font-size: 3rem !important; }
  .team-abbr { font-size: 1.25rem !important; }
  .team-logo-lg { width: 45px !important; height: 45px !important; }
  .score-center { width: 30px !important; margin: 0 2px !important; }
}

@media (min-width: 768px) {
  .team-score { font-size: 3.5rem; }
  .odds-grid { grid-template-columns: repeat(4, 1fr); }
  .pred-summary { grid-template-columns: repeat(4, 1fr); }
}
</style>

<script>
// ---- Team Colors ----
const TEAM_COLORS = {
    1610612737:["#E03A3E","#C1D32F"],1610612738:["#007A33","#BA9653"],1610612739:["#860038","#041E42"],
    1610612740:["#0C2340","#C8102E"],1610612741:["#CE1141","#000000"],1610612742:["#00538C","#002B5E"],
    1610612743:["#0E2240","#FEC524"],1610612744:["#1D428A","#FFC72C"],1610612745:["#CE1141","#000000"],
    1610612746:["#C8102E","#1D428A"],1610612747:["#552583","#FDB927"],1610612748:["#98002E","#F9A01B"],
    1610612749:["#00471B","#EEE1C6"],1610612750:["#0C2340","#236192"],1610612751:["#000000","#FFFFFF"],
    1610612752:["#006BB6","#F58426"],1610612753:["#0077C0","#000000"],1610612754:["#002D62","#FDBB30"],
    1610612755:["#006BB6","#ED174C"],1610612756:["#1D1160","#E56020"],1610612757:["#E03A3E","#000000"],
    1610612758:["#5A2D81","#63727A"],1610612759:["#C4CED4","#000000"],1610612760:["#007AC1","#EF6100"],
    1610612761:["#CE1141","#000000"],1610612762:["#002B5C","#00471B"],1610612763:["#5D76A9","#12173F"],
    1610612764:["#002B5C","#E31837"],1610612765:["#C8102E","#1D42BA"],1610612766:["#1D1160","#00788C"],
};

let gameES = null;
let currentSummary = null;
let previousHomeScore = null;
let previousAwayScore = null;
const _failedImages = new Set();  // track 404'd headshot URLs to avoid re-requesting

function closeGameES() {
    if (gameES) {
        gameES.close();
        if (typeof _activeEventSources !== 'undefined') {
            var idx = _activeEventSources.indexOf(gameES);
            if (idx > -1) _activeEventSources.splice(idx, 1);
        }
        gameES = null;
    }
}

function toggleGameSelector() {
    const list = document.getElementById('gameList');
    const icon = document.getElementById('gameSelectorIcon');
    if (list.style.display === 'none') {
        list.style.display = 'flex';
        icon.innerHTML = '&#9660;'; // down arrow
    } else {
        list.style.display = 'none';
        icon.innerHTML = '&#9654;'; // right arrow
    }
}

async function loadGames() {
    try {
        const r = await fetch('/api/gamecast/games');
        const games = await r.json();
        const el = document.getElementById('gameList');
        if (!games || games.error || !Array.isArray(games) || games.length === 0) {
            el.innerHTML = '<div style="padding: 12px; text-align:center;" class="text-muted">No games today</div>';
            return;
        }
        
        el.innerHTML = games.map(g => {
            const id = g.espn_id || g.id || g.game_id;
            
            let statusHtml = '';
            const state = g.state || g.status_state || '';
            if (state === 'in') {
                statusHtml = `
                    <span class="text-success" style="animation:pulse 2s infinite;">LIVE Q${g.period || '?'} ${g.clock || ''}</span>
                    <span style="margin-left: 8px;">${g.away_score || 0} - ${g.home_score || 0}</span>
                `;
            } else if (state === 'post') {
                statusHtml = `
                    <span class="text-muted">FINAL</span>
                    <span style="margin-left: 8px;">${g.away_score || 0} - ${g.home_score || 0}</span>
                `;
            } else {
                statusHtml = `<span class="text-muted">${g.short_detail || g.status || 'Upcoming'}</span>`;
            }
            
            return `
                <a href="#" class="game-row" onclick="event.preventDefault(); selectGame('${id}', this);">
                    <div class="game-teams">
                        <img src="/images/logos/${g.away_team_id || ''}.svg" class="team-logo-small" onerror="this.style.display='none'">
                        <span>${g.away_team || 'AWAY'}</span>
                        <span class="at">@</span>
                        <img src="/images/logos/${g.home_team_id || ''}.svg" class="team-logo-small" onerror="this.style.display='none'">
                        <span class="home">${g.home_team || 'HOME'}</span>
                    </div>
                    <div class="game-status">
                        ${statusHtml}
                    </div>
                </a>
            `;
        }).join('');
        
        // Only run after elements are rendered
        setTimeout(() => {
            {% if game_id %}
            // Pre-select if URL has ID
            const preSelected = document.querySelector(`.game-row[onclick*="{{ game_id }}"]`);
            if (preSelected) selectGame('{{ game_id }}', preSelected);
            {% endif %}
        }, 100);
    } catch(e) {
        document.getElementById('gameList').innerHTML = '<div style="padding: 12px; text-align:center;" class="text-muted">Error loading games</div>';
    }
}

function selectGame(gameId, element = null) {
    // UI state
    if (element) {
        document.querySelectorAll('.game-row').forEach(row => row.classList.remove('active'));
        element.classList.add('active');
        const list = document.getElementById('gameList');
        const icon = document.getElementById('gameSelectorIcon');
        list.style.display = 'none';
        icon.innerHTML = '&#9654;'; // right arrow
    }

    document.getElementById('gameDetail').classList.remove('hidden');
    
    // Background preload images just to be safe
    fetch('/api/sync/images').catch(() => {});
    
    closeGameES();
    gameES = new EventSource('/api/gamecast/stream/' + gameId);
    if (typeof _activeEventSources !== 'undefined') _activeEventSources.push(gameES);

    gameES.onmessage = function(e) {
        if (e.data === '[DONE]') { closeGameES(); return; }
        try {
            const data = JSON.parse(e.data);
            if (data.error) return;
            currentSummary = data.summary;
            updateScoreboard(data.summary);
            applyTeamColors(data.summary);
            updateWinProb(data.prediction, data.summary);
            updatePrediction(data.prediction, data.summary);
            updateOdds(data.odds);
            currentBoxscore = data.boxscore;
            updateBoxScore(data.boxscore, data.summary);
            updatePlays(data.plays, data.summary);
            updateCourt(data.plays);

            if (data.summary && data.summary.status_state === 'post') {
                closeGameES();
            }
        } catch(err) { console.error(err); }
    };

    gameES.onerror = function() {
        if (currentSummary && currentSummary.status_state === 'post') {
            closeGameES();
        }
    };
}

function showScoreBanner(teamName, points, teamId) {
    const banner = document.getElementById('scoreBanner');
    if (!banner) return;
    const color = TEAM_COLORS[teamId] ? TEAM_COLORS[teamId][0] : 'var(--accent)';
    banner.style.background = color;
    banner.innerHTML = `${teamName} SCORE! +${points}`;
    banner.style.top = '0';
    setTimeout(() => {
        banner.style.top = '-60px';
    }, 4000);
}

function updateScoreboard(s) {
    if (!s) return;
    
    // Check for score updates to trigger banner and flash
    if (previousHomeScore !== null && s.home_score > previousHomeScore) {
        showScoreBanner(s.home_team, s.home_score - previousHomeScore, s.home_team_id);
        const flash = document.getElementById('homeFlash');
        if(flash) {
            flash.style.transition = 'none';
            flash.style.opacity = '0.6';
            setTimeout(() => {
                flash.style.transition = 'opacity 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                flash.style.opacity = '0';
            }, 50);
        }
    } else if (previousAwayScore !== null && s.away_score > previousAwayScore) {
        showScoreBanner(s.away_team, s.away_score - previousAwayScore, s.away_team_id);
        const flash = document.getElementById('awayFlash');
        if(flash) {
            flash.style.transition = 'none';
            flash.style.opacity = '0.6';
            setTimeout(() => {
                flash.style.transition = 'opacity 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                flash.style.opacity = '0';
            }, 50);
        }
    }
    previousHomeScore = s.home_score;
    previousAwayScore = s.away_score;
    
    document.getElementById('homeTeam').textContent = s.home_team || 'HOME';
    document.getElementById('awayTeam').textContent = s.away_team || 'AWAY';
    document.getElementById('homeScore').textContent = s.home_score || '0';
    document.getElementById('awayScore').textContent = s.away_score || '0';
    document.getElementById('boxAwayLabel').textContent = s.away_team;
    document.getElementById('boxHomeLabel').textContent = s.home_team;
    document.getElementById('awayLabelWp').textContent = s.away_team;
    document.getElementById('homeLabelWp').textContent = s.home_team;

    // Court toggle labels
    var cla = document.getElementById('courtLabelAway');
    var clh = document.getElementById('courtLabelHome');
    if (cla) cla.textContent = s.away_team || 'Away';
    if (clh) clh.textContent = s.home_team || 'Home';

    const st = s.status_state;
    if (st === 'in') {
        document.getElementById('statusBadge').style.display = 'block';
        document.getElementById('finalBadge').style.display = 'none';
        document.getElementById('statusText').style.display = 'none';
        document.getElementById('clockContainer').style.display = 'flex';
        document.getElementById('period').textContent = 'Q' + s.period;
        document.getElementById('clock').textContent = s.clock;
    } else if (st === 'post') {
        document.getElementById('statusBadge').style.display = 'none';
        document.getElementById('finalBadge').style.display = 'block';
        document.getElementById('statusText').style.display = 'none';
        document.getElementById('clockContainer').style.display = 'none';
        // Hide overlays on finished games
        dismissTimeout();
        dismissSub();
    } else {
        document.getElementById('statusBadge').style.display = 'none';
        document.getElementById('finalBadge').style.display = 'none';
        document.getElementById('clockContainer').style.display = 'none';
        document.getElementById('statusText').style.display = 'block';
        document.getElementById('statusText').textContent = s.status || '';
    }

    // Logos
    if (s.home_team_id) {
        const hl = document.getElementById('homeLogo');
        hl.src = '/images/logos/' + s.home_team_id + '.svg';
        hl.style.display = 'block';
    }
    if (s.away_team_id) {
        const al = document.getElementById('awayLogo');
        al.src = '/images/logos/' + s.away_team_id + '.svg';
        al.style.display = 'block';
    }

    // Bonus
    document.getElementById('homeBonus').style.visibility = s.home_bonus ? 'visible' : 'hidden';
    document.getElementById('awayBonus').style.visibility = s.away_bonus ? 'visible' : 'hidden';

    // Game Stats
    if (document.getElementById('homeDrives')) {
        const hScored = s.home_drives_scored || 0;
        const hTotal = s.home_drives || 0;
        const aScored = s.away_drives_scored || 0;
        const aTotal = s.away_drives || 0;
        
        document.getElementById('homeDrives').textContent = `${hScored}/${hTotal}`;
        document.getElementById('awayDrives').textContent = `${aScored}/${aTotal}`;
        
        const hPossScored = s.home_poss_scored || 0;
        const hPossTotal = s.home_poss || 0;
        const aPossScored = s.away_poss_scored || 0;
        const aPossTotal = s.away_poss || 0;
        
        document.getElementById('homePoss').textContent = `${hPossScored}/${hPossTotal}`;
        document.getElementById('awayPoss').textContent = `${aPossScored}/${aPossTotal}`;
        
        const runEl = document.getElementById('currentRun');
        if (s.current_run) {
            runEl.textContent = s.current_run;
            runEl.style.color = 'var(--warning)';
        } else {
            runEl.textContent = 'None';
            runEl.style.color = 'var(--text)';
        }
    }

    // Timeouts
    const renderTimeouts = (containerId, count) => {
        const container = document.getElementById(containerId);
        if(!container) return;
        if(count < 0) {
            container.innerHTML = '';
            return;
        }
        let html = '';
        for(let i=0; i<7; i++) {
            const opacity = i < count ? '1' : '0.2';
            html += `<div style="width:6px; height:3px; background:rgba(255,255,255,${opacity}); border-radius:1px;"></div>`;
        }
        container.innerHTML = html;
    };
    renderTimeouts('homeTimeouts', s.home_timeouts !== undefined ? s.home_timeouts : -1);
    renderTimeouts('awayTimeouts', s.away_timeouts !== undefined ? s.away_timeouts : -1);

    // Quarter scores table
    const hq = s.home_quarters || [];
    const aq = s.away_quarters || [];
    if (hq.length > 0) {
        let headers = hq.map(function(_, i) { return i < 4 ? 'Q' + (i+1) : 'OT' + (i-3); }).join('</th><th style="padding:4px 6px;text-align:center;">');
        let html = '<table style="width:auto;margin:0 auto;font-size:0.8rem;border-collapse:collapse;white-space:nowrap;">' +
            '<tr><th></th><th style="padding:4px 6px;text-align:center;">' + headers + '</th><th style="padding:4px 6px;text-align:center;">T</th></tr>' +
            '<tr style="border-bottom:1px solid var(--border);"><td class="font-bold" style="padding:4px 8px;text-align:right;">' + s.away_team + '<span style="margin-left:6px;font-size:0.65rem;color:var(--text-muted);font-weight:600;">F:' + (s.away_fouls||0) + '</span></td>' +
            aq.map(function(q) { return '<td style="padding:4px 6px;text-align:center;">' + q + '</td>'; }).join('') +
            '<td class="font-bold" style="padding:4px 6px;text-align:center;color:var(--team-away);">' + s.away_score + '</td></tr>' +
            '<tr><td class="font-bold" style="padding:4px 8px;text-align:right;">' + s.home_team + '<span style="margin-left:6px;font-size:0.65rem;color:var(--text-muted);font-weight:600;">F:' + (s.home_fouls||0) + '</span></td>' +
            hq.map(function(q) { return '<td style="padding:4px 6px;text-align:center;">' + q + '</td>'; }).join('') +
            '<td class="font-bold" style="padding:4px 6px;text-align:center;color:var(--team-home);">' + s.home_score + '</td></tr>' +
            '</table>';
        document.getElementById('quarterScores').innerHTML = html;
        document.getElementById('quarterScores').parentElement.style.display = 'flex';
    } else {
        document.getElementById('quarterScores').innerHTML = '';
        document.getElementById('quarterScores').parentElement.style.display = 'none';
    }
}

// ---- Team Colors ----
function applyTeamColors(s) {
    if (!s) return;
    const hc = TEAM_COLORS[s.home_team_id] || ["#3b82f6","#1e293b"];
    const ac = TEAM_COLORS[s.away_team_id] || ["#ef4444","#1e293b"];
    
    // Apply colors to win probability bar
    document.getElementById('wpBarHome').style.background = hc[0];
    document.getElementById('wpBarAway').style.background = ac[0];
    
    // Set CSS variables for gradients and plays
    document.documentElement.style.setProperty('--team-home', hc[0]);
    document.documentElement.style.setProperty('--team-away', ac[0]);
}

function updateWinProb(pred, s) {
    let homeWP = 50;
    if (pred && pred.home_win_prob != null) homeWP = pred.home_win_prob;
    const awayWP = Math.round(100 - homeWP);
    document.getElementById('wpHome').textContent = Math.round(homeWP) + '%';
    document.getElementById('wpAway').textContent = awayWP + '%';
    document.getElementById('wpBarHome').style.width = homeWP + '%';
    document.getElementById('wpBarAway').style.width = awayWP + '%';
}

function updatePrediction(pred, s) {
    const el = document.getElementById('predictionInfo');
    if (!pred) {
        el.innerHTML = '<div class="text-muted text-sm" style="grid-column: 1 / -1;">No prediction available</div>';
        return;
    }
    const sp = pred.spread || 0;
    const spSign = sp > 0 ? '+' : '';
    const hAbbr = s ? s.home_team : 'Home';
    const aAbbr = s ? s.away_team : 'Away';
    
    el.innerHTML = `
        <div class="pred-item">
            <span class="pred-label">Spread</span>
            <span class="pred-value text-success">${hAbbr} ${spSign}${sp.toFixed(1)}</span>
        </div>
        <div class="pred-item">
            <span class="pred-label">Total</span>
            <span class="pred-value">${(pred.total || 0).toFixed(1)}</span>
        </div>
        <div class="pred-item">
            <span class="pred-label">Proj ${aAbbr}</span>
            <span class="pred-value">${(pred.away_score || 0).toFixed(1)}</span>
        </div>
        <div class="pred-item">
            <span class="pred-label">Proj ${hAbbr}</span>
            <span class="pred-value">${(pred.home_score || 0).toFixed(1)}</span>
        </div>
    `;
}

function updateOdds(odds) {
    const el = document.getElementById('oddsInfo');
    if (!odds || (!odds.spread && !odds.away_moneyline && !odds.home_moneyline)) {
        el.innerHTML = '<div class="text-muted text-sm" style="grid-column: 1 / -1;">No live odds available right now.</div>';
        return;
    }

    // Sharp money signal
    let sharpHtml = '';
    const spPub = odds.spread_home_public;
    const spMon = odds.spread_home_money;
    const mlPub = odds.ml_home_public;
    const mlMon = odds.ml_home_money;
    if (spPub != null && spMon != null) {
        const edge = spMon - spPub;
        let signalText = 'No strong signal';
        let signalColor = 'var(--text-muted)';
        if (Math.abs(edge) >= 5) {
            const side = edge > 0 ? 'HOME' : 'AWAY';
            signalText = `Sharps on ${side} (${Math.abs(edge)}pp)`;
            signalColor = Math.abs(edge) >= 10 ? '#22c55e' : '#eab308';
        }
        sharpHtml = `
        <div style="grid-column: 1 / -1; margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1);">
            <div style="color: var(--accent); font-size: 11px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 8px;">Sharp Money</div>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                <div class="odds-item">
                    <span class="odds-label">Spread Public</span>
                    <span class="odds-value">H ${spPub}% / A ${100 - spPub}%</span>
                </div>
                <div class="odds-item">
                    <span class="odds-label">Spread Money</span>
                    <span class="odds-value">H ${spMon}% / A ${100 - spMon}%</span>
                </div>
                ${mlPub != null ? `
                <div class="odds-item">
                    <span class="odds-label">ML Public</span>
                    <span class="odds-value">H ${mlPub}% / A ${100 - mlPub}%</span>
                </div>
                <div class="odds-item">
                    <span class="odds-label">ML Money</span>
                    <span class="odds-value">H ${mlMon}% / A ${100 - mlMon}%</span>
                </div>` : ''}
            </div>
            <div style="text-align: center; margin-top: 8px; font-weight: 700; font-size: 13px; color: ${signalColor};">${signalText}</div>
        </div>`;
    }

    el.innerHTML = `
        <div class="odds-item">
            <span class="odds-label">Spread</span>
            <span class="odds-value">${odds.spread || 'N/A'}</span>
        </div>
        <div class="odds-item">
            <span class="odds-label">Over/Under</span>
            <span class="odds-value">${odds.over_under || 'N/A'}</span>
        </div>
        <div class="odds-item">
            <span class="odds-label">Away ML</span>
            <span class="odds-value">${odds.away_moneyline || 'N/A'}</span>
        </div>
        <div class="odds-item">
            <span class="odds-label">Home ML</span>
            <span class="odds-value">${odds.home_moneyline || 'N/A'}</span>
        </div>
        ${odds.provider ? `<div class="text-xs text-muted" style="grid-column: 1 / -1; text-align: right; margin-top: 8px;">Via ${odds.provider}</div>` : ''}
        ${sharpHtml}
    `;
}

function switchBoxTab(side) {
    if (side === 'home') {
        document.getElementById('btnBoxHome').className = 'btn btn-primary';
        document.getElementById('btnBoxAway').className = 'btn btn-outline';
        document.getElementById('boxHome').style.display = 'block';
        document.getElementById('boxAway').style.display = 'none';
    } else {
        document.getElementById('btnBoxAway').className = 'btn btn-primary';
        document.getElementById('btnBoxHome').className = 'btn btn-outline';
        document.getElementById('boxAway').style.display = 'block';
        document.getElementById('boxHome').style.display = 'none';
    }
}

function updateBoxScore(box, s) {
    if (!box) return;
    fillBoxTable('boxAwayTable', box.away || []);
    fillBoxTable('boxHomeTable', box.home || []);
}

function fillBoxTable(tableId, players) {
    const tbody = document.querySelector('#' + tableId + ' tbody');
    if (!tbody) return;
    tbody.innerHTML = players.map(function(p) {
        const placeholder = '<div style="width:30px;height:30px;border-radius:50%;background-color:#1e293b;box-shadow:0 2px 4px rgba(0,0,0,0.3); display:inline-block; vertical-align:middle;"></div>';
        const photo = (p.headshot && !_failedImages.has(p.headshot)) ?
            '<img src="' + p.headshot + '" style="width:30px;height:30px;border-radius:50%;object-fit:cover;box-shadow:0 2px 4px rgba(0,0,0,0.3);" onerror="this.onerror=null; _failedImages.add(this.src); this.style.display=\'none\';">' :
            placeholder;
        const activeDot = p.active ? '<span style="display:inline-block;width:8px;height:8px;border-radius:50%;background-color:#22c55e;box-shadow:0 0 6px #22c55e;margin-right:6px;vertical-align:middle;"></span>' : '';
        return '<tr>' +
            '<td style="width:32px;">' + photo + '</td>' +
            '<td class="font-bold">' + activeDot + (p.name || '') + '</td>' +
            '<td class="font-mono text-center">' + (p.min || '') + '</td>' +
            '<td class="font-mono text-center font-bold" style="color:var(--text);">' + (p.pts || '') + '</td>' +
            '<td class="font-mono text-center">' + (p.reb || '') + '</td>' +
            '<td class="font-mono text-center">' + (p.ast || '') + '</td>' +
            '<td class="font-mono text-center">' + (p.stl || '') + '</td>' +
            '<td class="font-mono text-center">' + (p.blk || '') + '</td>' +
            '<td class="font-mono text-center">' + (p.fg || '') + '</td>' +
            '<td class="font-mono text-center">' + (p.threept || '') + '</td>' +
            '<td class="font-mono text-center" style="color:var(--danger);">' + (p.pf || '') + '</td>' +
            '<td class="font-mono text-center font-bold ' + (parseInt(p.plusminus)>0?'text-success':(parseInt(p.plusminus)<0?'text-danger':'')) + '">' + (p.plusminus || '') + '</td>' +
        '</tr>';
    }).join('');
}

let lastPlayText = "";
let timeoutInterval = null;
let subTimeout = null;

function dismissTimeout() {
    if (timeoutInterval) clearInterval(timeoutInterval);
    timeoutInterval = null;
    document.getElementById('timeoutOverlay').style.display = 'none';
}

function dismissSub() {
    if (subTimeout) clearTimeout(subTimeout);
    subTimeout = null;
    document.getElementById('subOverlay').style.display = 'none';
}

function startTimeoutTimer(seconds) {
    const overlay = document.getElementById('timeoutOverlay');
    const secondsSpan = document.getElementById('timeoutSeconds');
    
    if (timeoutInterval) clearInterval(timeoutInterval);
    
    let remaining = seconds;
    overlay.style.display = 'flex';
    secondsSpan.textContent = remaining;
    
    timeoutInterval = setInterval(() => {
        remaining--;
        if (remaining <= 0) {
            clearInterval(timeoutInterval);
            timeoutInterval = null;
            overlay.style.display = 'none';
        } else {
            secondsSpan.textContent = remaining;
        }
    }, 1000);
}

function matchPlayerName(playName, boxName) {
    if (!playName || !boxName) return false;
    let pn = playName.toLowerCase().replace(/[^a-z \-]/g, '');
    let bn = boxName.toLowerCase().replace(/[^a-z \-]/g, '');
    if (pn === bn) return true;
    if (bn.includes(pn) || pn.includes(bn)) return true;
    let pParts = pn.split(' ');
    let bParts = bn.split(' ');
    if (pParts.length > 0 && bParts.length > 0 && pParts[pParts.length-1] === bParts[bParts.length-1]) {
        if (pParts.length > 1 && bParts.length > 1) {
            return pParts[0][0] === bParts[0][0];
        }
        return true;
    }
    return false;
}

function showSubstitution(text, boxscore) {
    // text format: "Player A enters the game for Player B"
    const match = text.match(/(.+?)\s+enters the game for\s+(.+)/i);
    if (!match) return;
    
    const pInName = match[1].trim();
    const pOutName = match[2].replace('.', '').trim();
    
    let pIn = null, pOut = null;
    
    // Find players in boxscore
    if (boxscore) {
        ['home', 'away'].forEach(side => {
            if (!boxscore[side]) return;
            boxscore[side].forEach(p => {
                const name = p.name || '';
                if (name.includes(pInName) || pInName.includes(name)) pIn = p;
                if (name.includes(pOutName) || pOutName.includes(name)) pOut = p;
            });
        });
    }
    
    const overlay = document.getElementById('subOverlay');
    
    // In
    document.getElementById('subInName').textContent = pIn ? pIn.name : pInName;
    const inImg = document.getElementById('subInImg');
    if (pIn && pIn.headshot) {
        inImg.src = pIn.headshot;
        inImg.style.display = 'block';
        document.getElementById('subInStats').textContent = `${pIn.pts||0} PTS | ${pIn.reb||0} REB | ${pIn.ast||0} AST`;
    } else {
        inImg.style.display = 'none';
        document.getElementById('subInStats').textContent = '';
    }
    
    // Out
    document.getElementById('subOutName').textContent = pOut ? pOut.name : pOutName;
    const outImg = document.getElementById('subOutImg');
    if (pOut && pOut.headshot) {
        outImg.src = pOut.headshot;
        outImg.style.display = 'block';
        document.getElementById('subOutStats').textContent = `${pOut.pts||0} PTS | ${pOut.reb||0} REB | ${pOut.ast||0} AST`;
    } else {
        outImg.style.display = 'none';
        document.getElementById('subOutStats').textContent = '';
    }
    
    overlay.style.display = 'flex';
    
    if (subTimeout) clearTimeout(subTimeout);
    subTimeout = setTimeout(() => {
        overlay.style.display = 'none';
    }, 6000);
}

// Ensure latest boxscore is available for plays
let currentBoxscore = null;

function updatePlays(plays, s) {
    if (!plays) return;
    
    // Check for timeout or sub
    if (plays.length > 0) {
        const latestPlay = plays[plays.length - 1].text;
        if (latestPlay !== lastPlayText) {
            if (latestPlay.toLowerCase().includes("timeout") && s.status_state === 'in') {
                startTimeoutTimer(75);
            } else if (latestPlay.toLowerCase().includes("enters the game")) {
                showSubstitution(latestPlay, currentBoxscore);
            }
            lastPlayText = latestPlay;
        }
    }

    const el = document.getElementById('plays');
    const homeTid = s ? s.home_team_id : null;
    const homeAbbr = s ? s.home_team : null;
    const awayAbbr = s ? s.away_team : null;
    
    // Show newest first
    const reversed = plays.slice().reverse();
    el.innerHTML = reversed.map(function(p) {
        const isHome = p.team_id === homeTid;
        const isAway = p.team_id && p.team_id !== homeTid;
        
        let playClass = 'play-item';
        if (isHome) playClass += ' play-home';
        else if (isAway) playClass += ' play-away';
        
        if (p.scoring) playClass += ' scoring';
        if (p.text && p.text.toLowerCase().includes('foul')) playClass += ' foul-play';
        
        const badgeColor = isHome ? `var(--team-home)` : (isAway ? `var(--team-away)` : 'rgba(255,255,255,0.1)');
        const badgeStyle = `background:${badgeColor}; color:white; filter:drop-shadow(0 1px 2px rgba(0,0,0,0.5));`;
        const teamAbbr = isHome ? homeAbbr : (isAway ? awayAbbr : '');
        
        const perLabel = p.period <= 4 ? 'Q' + p.period : 'OT' + (p.period - 4);
        
        let foulTag = '';
        if (p.text && p.text.toLowerCase().includes('foul')) {
            const txt = p.text.toLowerCase();
            if (txt.includes('shooting')) foulTag = '<span class="foul-tag foul-shooting">FTs</span>';
            else if (txt.includes('flagrant')) foulTag = '<span class="foul-tag foul-flagrant">FLAGRANT</span>';
            else if (txt.includes('technical')) foulTag = '<span class="foul-tag foul-technical">TECH</span>';
            else if (txt.includes('offensive')) foulTag = '<span class="foul-tag foul-offensive">OFF</span>';
            else foulTag = '<span class="foul-tag">FOUL</span>';
        }
        
        return `
            <div class="${playClass}">
                <div class="play-meta">
                    <span class="play-period">${perLabel}</span>
                    <span class="play-clock">${p.clock || ''}</span>
                    ${foulTag}
                </div>
                <div class="play-body">
                    ${p.team_id ? `<img src="/images/logos/${p.team_id}.svg" style="width:24px;height:24px;object-fit:contain;filter:drop-shadow(0 1px 2px rgba(0,0,0,0.3));" onerror="this.style.display='none'">` : ''}
                    <span class="play-text" style="${p.scoring ? 'font-weight:600;color:var(--text);' : ''}">${p.text || ''}</span>
                </div>
                ${(p.away_score || p.home_score) ? `<div class="play-score">${awayAbbr || 'AWAY'} ${p.away_score} - ${p.home_score} ${homeAbbr || 'HOME'}</div>` : ''}
            </div>
        `;
    }).join('');
}

// ---- Court Visualization ----
const COURT_W = 50, COURT_H = 47, HOOP_X = 25, HOOP_Y = 5.25;
let courtShots = [];
let courtFilter = 'both'; // 'away', 'home', 'both'
let _courtLogoImg = null;
let _courtLogoTeamId = null;

function setCourtFilter(f) {
    courtFilter = f;
    document.querySelectorAll('.court-toggle-btn').forEach(function(b) {
        b.classList.toggle('active', b.getAttribute('data-filter') === f);
    });
    drawCourt();
}

function _getFilteredShots() {
    if (!currentSummary || courtFilter === 'both') return courtShots;
    const tid = courtFilter === 'home' ? currentSummary.home_team_id : currentSummary.away_team_id;
    return courtShots.filter(function(s) { return String(s.team_id) === String(tid); });
}

function _getCourtTeamColors() {
    if (!currentSummary) return { primary: '#3b82f6', secondary: '#1e3a5f' };
    var tid;
    if (courtFilter === 'home') tid = currentSummary.home_team_id;
    else if (courtFilter === 'away') tid = currentSummary.away_team_id;
    else tid = currentSummary.home_team_id; // default to home for court theme
    const c = TEAM_COLORS[tid] || ['#3b82f6', '#1e3a5f'];
    return { primary: c[0], secondary: c[1], teamId: tid };
}

function _loadCourtLogo(teamId, callback) {
    if (_courtLogoTeamId === teamId && _courtLogoImg) { callback(_courtLogoImg); return; }
    var img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = function() { _courtLogoImg = img; _courtLogoTeamId = teamId; callback(img); };
    img.onerror = function() { callback(null); };
    img.src = '/images/logos/' + teamId + '.svg';
}

function _hexToRgb(hex) {
    hex = hex.replace('#', '');
    return {
        r: parseInt(hex.substring(0, 2), 16),
        g: parseInt(hex.substring(2, 4), 16),
        b: parseInt(hex.substring(4, 6), 16)
    };
}

function drawCourt() {
    const canvas = document.getElementById('courtCanvas');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const W = canvas.width, H = canvas.height;
    const pad = 12;
    const cw = W - 2 * pad, ch = H - 2 * pad;
    const tc = _getCourtTeamColors();
    const rgb = _hexToRgb(tc.primary);

    ctx.clearRect(0, 0, W, H);

    // ---- Hardwood floor ----
    // Base warm wood color
    const woodBase = ctx.createLinearGradient(0, 0, W, H);
    woodBase.addColorStop(0, '#c4893b');
    woodBase.addColorStop(0.3, '#b87a30');
    woodBase.addColorStop(0.6, '#d49a48');
    woodBase.addColorStop(1, '#b07328');
    ctx.fillStyle = woodBase;
    ctx.fillRect(0, 0, W, H);

    // Wood plank lines (vertical)
    ctx.save();
    ctx.globalAlpha = 0.12;
    ctx.strokeStyle = '#6b4226';
    ctx.lineWidth = 1;
    const plankW = W / 14;
    for (var i = 0; i <= 14; i++) {
        var px = i * plankW + (i % 3) * 2;
        ctx.beginPath();
        ctx.moveTo(px, 0);
        ctx.lineTo(px, H);
        ctx.stroke();
    }
    ctx.restore();

    // Wood grain texture (subtle horizontal streaks)
    ctx.save();
    ctx.globalAlpha = 0.06;
    for (var gy = 0; gy < H; gy += 3) {
        var gAlpha = 0.03 + Math.sin(gy * 0.7) * 0.03 + Math.sin(gy * 2.3) * 0.02;
        ctx.fillStyle = 'rgba(60,30,10,' + gAlpha + ')';
        ctx.fillRect(0, gy, W, 1.5);
    }
    ctx.restore();

    // Slight vignette
    var vig = ctx.createRadialGradient(W/2, H/2, W*0.2, W/2, H/2, W*0.7);
    vig.addColorStop(0, 'rgba(0,0,0,0)');
    vig.addColorStop(1, 'rgba(0,0,0,0.25)');
    ctx.fillStyle = vig;
    ctx.fillRect(0, 0, W, H);

    function cx(x) { return pad + (x / COURT_W) * cw; }
    function cy(y) { return pad + (y / COURT_H) * ch; }

    // ---- Team-colored paint area ----
    const keyL = cx(17), keyR = cx(33), keyTop = cy(0), keyBot = cy(19);
    ctx.fillStyle = 'rgba(' + rgb.r + ',' + rgb.g + ',' + rgb.b + ',0.18)';
    ctx.fillRect(keyL, keyTop, keyR - keyL, keyBot - keyTop);

    // Center circle fill (half, at bottom of half-court)
    ctx.save();
    ctx.beginPath();
    ctx.arc(cx(25), cy(COURT_H), (6/COURT_W)*cw, Math.PI, 0);
    ctx.closePath();
    ctx.fillStyle = 'rgba(' + rgb.r + ',' + rgb.g + ',' + rgb.b + ',0.15)';
    ctx.fill();
    ctx.restore();

    // ---- Team logo watermark at center court ----
    var logoTeam = tc.teamId || (currentSummary && currentSummary.home_team_id);
    if (logoTeam) {
        _loadCourtLogo(logoTeam, function(img) {
            if (!img) return;
            ctx.save();
            var logoSize = cw * 0.28;
            var lx = cx(25) - logoSize / 2;
            var ly = cy(COURT_H) - logoSize * 0.85;
            ctx.globalAlpha = 0.10;
            ctx.drawImage(img, lx, ly, logoSize, logoSize);
            ctx.restore();
            // Redraw lines and shots on top (deferred)
            _drawCourtLines(ctx, W, H, pad, cw, ch, cx, cy, rgb);
            _drawShots(ctx, cx, cy, tc);
            _updateCourtStats();
        });
    }

    _drawCourtLines(ctx, W, H, pad, cw, ch, cx, cy, rgb);
    _drawShots(ctx, cx, cy, tc);
    _updateCourtStats();
}

function _drawCourtLines(ctx, W, H, pad, cw, ch, cx, cy, rgb) {
    // NBA official dimensions (in feet, half-court view)
    // Court: 50ft wide Ã— 47ft half-length
    // Basket: 5.25ft from baseline, centered at 25ft
    // Key: 16ft wide (17â€“33), 19ft deep from baseline
    // FT circle: 6ft radius at 19ft from baseline
    // 3PT arc: 23.75ft radius from basket center
    // Corner 3: 3ft from sideline, straight until arc junction
    // Restricted area: 4ft radius from basket center
    // Center circle: 6ft radius at half-court

    var lineColor = 'rgba(255,255,255,0.85)';
    var lineWidth = 2;
    var r3 = 23.75;

    // Compute exact corner-three junction y-coordinate
    // where the 23.75ft arc reaches 3ft from sideline (x=3 or x=47)
    var cornerDx = HOOP_X - 3; // 22ft
    var junctionY = HOOP_Y + Math.sqrt(r3 * r3 - cornerDx * cornerDx); // â‰ˆ14.2ft

    ctx.strokeStyle = lineColor;
    ctx.lineWidth = lineWidth;
    ctx.lineCap = 'round';
    ctx.setLineDash([]);

    // ---- Court outline ----
    ctx.beginPath();
    ctx.rect(cx(0), cy(0), cw, ch);
    ctx.stroke();

    // ---- Half-court line ----
    ctx.beginPath();
    ctx.moveTo(cx(0), cy(COURT_H));
    ctx.lineTo(cx(COURT_W), cy(COURT_H));
    ctx.stroke();

    // ---- Center circle (visible half â€” semicircle into our half-court) ----
    ctx.beginPath();
    ctx.arc(cx(25), cy(COURT_H), (6 / COURT_W) * cw, Math.PI, 0);
    ctx.stroke();

    // ---- Paint / key outline ----
    var keyL = cx(17), keyR = cx(33), keyTop = cy(0), keyBot = cy(19);
    ctx.beginPath();
    ctx.rect(keyL, keyTop, keyR - keyL, keyBot - keyTop);
    ctx.stroke();

    // ---- Free throw circle ----
    var ftRadius = (6 / COURT_W) * cw;
    // Solid half â€” inside the key (toward baseline = ABOVE the FT line in canvas)
    // From 0 (right) counterclockwise to Ï€ (left), sweeping upward through 3Ï€/2
    ctx.beginPath();
    ctx.arc(cx(25), cy(19), ftRadius, Math.PI, 0, true);
    ctx.stroke();
    // Dashed half â€” outside the key (toward half-court = BELOW the FT line in canvas)
    // From Ï€ (left) counterclockwise to 0 (right), sweeping downward through Ï€/2
    ctx.beginPath();
    ctx.setLineDash([6, 6]);
    ctx.arc(cx(25), cy(19), ftRadius, Math.PI, 0, false);
    ctx.stroke();
    ctx.setLineDash([]);

    // ---- Restricted area arc ----
    // 4ft semicircle below the hoop (toward half-court)
    ctx.beginPath();
    ctx.strokeStyle = lineColor;
    ctx.lineWidth = lineWidth;
    ctx.arc(cx(HOOP_X), cy(HOOP_Y), (4 / COURT_W) * cw, 0, Math.PI);
    ctx.stroke();

    // ---- Three-point line ----
    // Angles from hoop center to the junction points
    var ang3Left = Math.atan2(junctionY - HOOP_Y, 3 - HOOP_X);       // â‰ˆ2.77 rad (down-left)
    var ang3Right = Math.atan2(junctionY - HOOP_Y, 47 - HOOP_X);     // â‰ˆ0.39 rad (down-right)
    var r3px = (r3 / COURT_W) * cw;

    ctx.strokeStyle = lineColor;
    ctx.lineWidth = lineWidth;

    // Left corner straight line (baseline to arc junction)
    ctx.beginPath();
    ctx.moveTo(cx(3), cy(0));
    ctx.lineTo(cx(3), cy(junctionY));
    ctx.stroke();

    // Three-point arc â€” counterclockwise from left junction to right junction
    // This sweeps downward through Ï€/2, which is the correct direction (away from baseline)
    ctx.beginPath();
    ctx.arc(cx(HOOP_X), cy(HOOP_Y), r3px, ang3Left, ang3Right, true);
    ctx.stroke();

    // Right corner straight line (arc junction to baseline)
    ctx.beginPath();
    ctx.moveTo(cx(47), cy(junctionY));
    ctx.lineTo(cx(47), cy(0));
    ctx.stroke();

    // ---- Lane tick marks ----
    // NBA lane marks at 7ft, 8ft, 11ft, 14ft from baseline
    ctx.strokeStyle = lineColor;
    ctx.lineWidth = 1.5;
    var ticks = [7, 8, 11, 14];
    var tickLen = (0.5 / COURT_W) * cw; // ~0.5ft tick length
    ticks.forEach(function(ty) {
        ctx.beginPath();
        ctx.moveTo(keyL - tickLen, cy(ty));
        ctx.lineTo(keyL + tickLen, cy(ty));
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(keyR - tickLen, cy(ty));
        ctx.lineTo(keyR + tickLen, cy(ty));
        ctx.stroke();
    });

    // ---- Backboard ----
    // 6ft wide backboard at 4ft from baseline
    ctx.beginPath();
    ctx.moveTo(cx(22), cy(4));
    ctx.lineTo(cx(28), cy(4));
    ctx.strokeStyle = 'rgba(255,255,255,0.7)';
    ctx.lineWidth = 3;
    ctx.stroke();

    // ---- Hoop (rim) ----
    ctx.beginPath();
    ctx.arc(cx(HOOP_X), cy(HOOP_Y), 4, 0, Math.PI * 2);
    ctx.strokeStyle = '#ff6b2b';
    ctx.lineWidth = 2.5;
    ctx.stroke();

    // ---- Net suggestion ----
    ctx.strokeStyle = 'rgba(255,255,255,0.3)';
    ctx.lineWidth = 0.8;
    for (var ni = -2; ni <= 2; ni++) {
        ctx.beginPath();
        ctx.moveTo(cx(HOOP_X) + ni * 2.5, cy(HOOP_Y) + 4);
        ctx.lineTo(cx(HOOP_X) + ni * 1.8, cy(HOOP_Y) + 10);
        ctx.stroke();
    }
}

function _drawShots(ctx, cx, cy, tc) {
    var shots = _getFilteredShots();
    var homeId = currentSummary ? String(currentSummary.home_team_id) : '';
    var awayId = currentSummary ? String(currentSummary.away_team_id) : '';
    var hc = currentSummary ? (TEAM_COLORS[currentSummary.home_team_id] || ['#3b82f6'])[0] : '#3b82f6';
    var ac = currentSummary ? (TEAM_COLORS[currentSummary.away_team_id] || ['#ef4444'])[0] : '#ef4444';

    shots.forEach(function(shot) {
        var sx = cx(shot.x), sy = cy(shot.y);
        var isHome = String(shot.team_id) === homeId;
        var shotColor = isHome ? hc : ac;
        var srgb = _hexToRgb(shotColor);

        if (shot.made) {
            // Glow
            ctx.save();
            ctx.beginPath();
            ctx.arc(sx, sy, 10, 0, Math.PI * 2);
            ctx.fillStyle = 'rgba(' + srgb.r + ',' + srgb.g + ',' + srgb.b + ',0.25)';
            ctx.fill();
            ctx.restore();
            // Filled circle
            ctx.beginPath();
            ctx.arc(sx, sy, 5, 0, Math.PI * 2);
            ctx.fillStyle = shotColor;
            ctx.fill();
            ctx.strokeStyle = 'rgba(255,255,255,0.6)';
            ctx.lineWidth = 1.2;
            ctx.stroke();
        } else {
            // Missed â€” X mark in team color
            ctx.save();
            var r = 4;
            ctx.strokeStyle = shotColor;
            ctx.lineWidth = 2.5;
            ctx.globalAlpha = 0.55;
            ctx.beginPath();
            ctx.moveTo(sx - r, sy - r); ctx.lineTo(sx + r, sy + r);
            ctx.moveTo(sx + r, sy - r); ctx.lineTo(sx - r, sy + r);
            ctx.stroke();
            ctx.restore();
        }
    });
}

function _updateCourtStats() {
    var el = document.getElementById('courtStats');
    if (!el) return;
    var shots = _getFilteredShots();
    if (shots.length === 0) { el.innerHTML = ''; return; }

    var made = shots.filter(function(s) { return s.made; }).length;
    var pct = shots.length > 0 ? Math.round((made / shots.length) * 100) : 0;

    var homeId = currentSummary ? String(currentSummary.home_team_id) : '';
    var awayId = currentSummary ? String(currentSummary.away_team_id) : '';

    if (courtFilter === 'both' && currentSummary) {
        var hShots = shots.filter(function(s) { return String(s.team_id) === homeId; });
        var aShots = shots.filter(function(s) { return String(s.team_id) === awayId; });
        var hMade = hShots.filter(function(s) { return s.made; }).length;
        var aMade = aShots.filter(function(s) { return s.made; }).length;
        var hPct = hShots.length > 0 ? Math.round((hMade / hShots.length) * 100) : 0;
        var aPct = aShots.length > 0 ? Math.round((aMade / aShots.length) * 100) : 0;
        var hc = (TEAM_COLORS[currentSummary.home_team_id] || ['#3b82f6'])[0];
        var ac = (TEAM_COLORS[currentSummary.away_team_id] || ['#ef4444'])[0];
        el.innerHTML =
            '<div class="court-stat-pill"><span class="cs-dot" style="background:' + ac + '"></span>' +
            (currentSummary.away_team || 'AWY') + ' <span class="cs-val">' + aMade + '/' + aShots.length + '</span> ' + aPct + '%</div>' +
            '<div class="court-stat-pill"><span class="cs-dot" style="background:' + hc + '"></span>' +
            (currentSummary.home_team || 'HOM') + ' <span class="cs-val">' + hMade + '/' + hShots.length + '</span> ' + hPct + '%</div>';
    } else {
        var label = courtFilter === 'home' ? (currentSummary && currentSummary.home_team || 'Home') :
                    courtFilter === 'away' ? (currentSummary && currentSummary.away_team || 'Away') : 'All';
        el.innerHTML = '<div class="court-stat-pill">FG <span class="cs-val">' + made + '/' + shots.length + '</span> ' + pct + '%</div>';
    }
}

function updateCourt(plays) {
    if (!plays) return;
    const newShots = [];
    plays.forEach(function(p) {
        if ((p.shootingPlay || p.scoring) && p.coordinate && typeof p.coordinate.x === 'number' && typeof p.coordinate.y === 'number') {
            if (Math.abs(p.coordinate.x) < 200 && Math.abs(p.coordinate.y) < 200) {
                newShots.push({ x: p.coordinate.x, y: p.coordinate.y, made: !!p.scoring, team_id: p.team_id, text: p.text || '', clock: p.clock || '', period: p.period || '' });
            }
        }
    });
    if (newShots.length > 0) {
        courtShots = newShots;
        drawCourt();
    }
}

// Initial court draw
setTimeout(drawCourt, 100);

// ---- Court Tooltip on Hover ----
(function() {
    var tooltip = document.getElementById('courtTooltip');
    var canvas = document.getElementById('courtCanvas');
    if (!canvas || !tooltip) return;

    canvas.addEventListener('mousemove', function(e) {
        var rect = canvas.getBoundingClientRect();
        var scaleX = canvas.width / rect.width;
        var scaleY = canvas.height / rect.height;
        var mx = (e.clientX - rect.left) * scaleX;
        var my = (e.clientY - rect.top) * scaleY;

        var pad = 12;
        var cw = canvas.width - 2 * pad;
        var ch = canvas.height - 2 * pad;
        var shots = _getFilteredShots();
        var hit = null;
        var hitDist = 15; // pixel radius for detection

        for (var i = shots.length - 1; i >= 0; i--) {
            var s = shots[i];
            var sx = pad + (s.x / COURT_W) * cw;
            var sy = pad + (s.y / COURT_H) * ch;
            var d = Math.sqrt((mx - sx) * (mx - sx) + (my - sy) * (my - sy));
            if (d < hitDist) { hit = s; hitDist = d; }
        }

        if (hit) {
            var homeId = currentSummary ? String(currentSummary.home_team_id) : '';
            var isHome = String(hit.team_id) === homeId;
            var teamColor = isHome
                ? (TEAM_COLORS[currentSummary.home_team_id] || ['#3b82f6'])[0]
                : (TEAM_COLORS[currentSummary.away_team_id] || ['#ef4444'])[0];
            var resultLabel = hit.made ? 'Made' : 'Missed';
            var resultColor = hit.made ? '#4ade80' : '#f87171';

            tooltip.innerHTML =
                '<div class="ct-result" style="color:' + resultColor + '">' + resultLabel + '</div>' +
                '<div class="ct-text">' + hit.text + '</div>' +
                (hit.clock ? '<div class="ct-clock">Q' + hit.period + ' ' + hit.clock + '</div>' : '');
            tooltip.style.borderColor = teamColor;

            // Position relative to court-wrap
            var pctX = ((e.clientX - rect.left) / rect.width) * 100;
            var pctY = ((e.clientY - rect.top) / rect.height) * 100;
            tooltip.style.left = pctX + '%';
            tooltip.style.top = pctY + '%';
            tooltip.style.display = 'block';
        } else {
            tooltip.style.display = 'none';
        }
    });

    canvas.addEventListener('mouseleave', function() {
        tooltip.style.display = 'none';
    });
})();

loadGames();
</script>
{% endblock %}