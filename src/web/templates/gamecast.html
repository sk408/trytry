{% extends "base.html" %}
{% set active = "gamecast" %}
{% block title %}Gamecast â€” NBA Predictor{% endblock %}

{% block content %}
<h1 class="section-header">Gamecast</h1>

<div class="card mb-4">
    <div class="card-header">Select Game</div>
    <div id="gameList" class="btn-group">Loading games...</div>
</div>

<div id="gameDetail" class="hidden">
    <!-- Scoreboard with quarter scores -->
    <div class="scoreboard mb-4" id="scoreboard">
        <div class="team">
            <img id="awayLogo" src="" alt="" class="team-logo-pred" style="display:none;">
            <div class="name" id="awayTeam">Away</div>
            <div class="score" id="awayScore">0</div>
        </div>
        <div class="text-center">
            <div id="statusText" class="text-muted text-sm mb-2"></div>
            <div id="quarterScores" class="quarter-scores"></div>
        </div>
        <div class="team">
            <img id="homeLogo" src="" alt="" class="team-logo-pred" style="display:none;">
            <div class="name" id="homeTeam">Home</div>
            <div class="score" id="homeScore">0</div>
        </div>
    </div>

    <!-- Win Probability Bar -->
    <div class="card mb-4 wp-card" id="winProbCard">
        <div class="wp-header">
            <span id="wpAway" class="font-bold">50%</span>
            <span class="text-muted">WIN PROBABILITY</span>
            <span id="wpHome" class="font-bold">50%</span>
        </div>
        <div class="wp-bar-track">
            <div id="wpBarAway" class="wp-bar wp-bar-away"></div>
            <div id="wpBarHome" class="wp-bar wp-bar-home"></div>
        </div>
    </div>

    <!-- Prediction + Odds -->
    <div class="grid-2">
        <div class="card">
            <div class="card-header">Model Prediction</div>
            <div id="predictionInfo">
                <div class="text-muted text-sm">Waiting for data...</div>
            </div>
        </div>
        <div class="card">
            <div class="card-header">Vegas Odds</div>
            <div id="oddsInfo">Loading...</div>
        </div>
    </div>

    <!-- Box Score -->
    <div class="card mt-4">
        <div class="card-header">Box Score</div>
        <div class="tabs" id="boxTabs">
            <div class="tab active" onclick="switchBoxTab('away')"><span id="boxAwayLabel">Away</span></div>
            <div class="tab" onclick="switchBoxTab('home')"><span id="boxHomeLabel">Home</span></div>
        </div>
        <div id="boxAway" class="tab-content active">
            <div class="table-wrap"><table id="boxAwayTable">
                <thead><tr><th style="width:32px"></th><th>Player</th><th>MIN</th><th>PTS</th><th>REB</th><th>AST</th><th>STL</th><th>BLK</th><th>FG</th><th>3PT</th><th>+/-</th></tr></thead>
                <tbody></tbody>
            </table></div>
        </div>
        <div id="boxHome" class="tab-content">
            <div class="table-wrap"><table id="boxHomeTable">
                <thead><tr><th style="width:32px"></th><th>Player</th><th>MIN</th><th>PTS</th><th>REB</th><th>AST</th><th>STL</th><th>BLK</th><th>FG</th><th>3PT</th><th>+/-</th></tr></thead>
                <tbody></tbody>
            </table></div>
        </div>
    </div>

    <!-- Court Visualization -->
    <div class="card mt-4">
        <div class="card-header">Shot Chart</div>
        <div class="court-container">
            <canvas id="courtCanvas" width="500" height="470" class="court-canvas"></canvas>
        </div>
    </div>

    <!-- Play-by-Play -->
    <div class="card mt-4">
        <div class="card-header">Play-by-Play</div>
        <div class="play-by-play" id="plays"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let gameES = null;
let currentSummary = null;

async function loadGames() {
    try {
        const r = await fetch('/api/gamecast/games');
        const games = await r.json();
        const el = document.getElementById('gameList');
        if (!games || games.error || !Array.isArray(games) || games.length === 0) {
            el.innerHTML = '<span class="text-muted">No games today</span>';
            return;
        }
        el.innerHTML = games.map(g => {
            const id = g.espn_id || g.id || g.game_id;
            const label = (g.away_team || '???') + ' @ ' + (g.home_team || '???');
            return `<button class="btn btn-outline btn-sm" onclick="selectGame('${id}')">${label}</button>`;
        }).join('');
        {% if game_id %}
        selectGame('{{ game_id }}');
        {% endif %}
    } catch(e) {
        document.getElementById('gameList').innerHTML = '<span class="text-muted">Error loading games</span>';
    }
}

function selectGame(gameId) {
    document.getElementById('gameDetail').classList.remove('hidden');
    if (gameES) { gameES.close(); }
    gameES = new EventSource('/api/gamecast/stream/' + gameId);
    if (typeof _activeEventSources !== 'undefined') _activeEventSources.push(gameES);
    gameES.onmessage = function(e) {
        try {
            const data = JSON.parse(e.data);
            if (data.error) return;
            currentSummary = data.summary;
            updateScoreboard(data.summary);
            applyTeamColors(data.summary);
            updateWinProb(data.prediction, data.summary);
            updatePrediction(data.prediction, data.summary);
            updateOdds(data.odds);
            updateBoxScore(data.boxscore, data.summary);
            updatePlays(data.plays, data.summary);
            updateCourt(data.plays);
        } catch(err) { console.error(err); }
    };
}

function updateScoreboard(s) {
    if (!s) return;
    document.getElementById('homeTeam').textContent = s.home_team || 'Home';
    document.getElementById('awayTeam').textContent = s.away_team || 'Away';
    document.getElementById('homeScore').textContent = s.home_score || '0';
    document.getElementById('awayScore').textContent = s.away_score || '0';
    document.getElementById('boxAwayLabel').textContent = s.away_team;
    document.getElementById('boxHomeLabel').textContent = s.home_team;

    // Status
    let st = s.status || '';
    if (s.status_state === 'in') st = 'Q' + s.period + ' ' + s.clock;
    document.getElementById('statusText').textContent = st;

    // Logos
    if (s.home_team_id) {
        const hl = document.getElementById('homeLogo');
        hl.src = '/images/logos/' + s.home_team_id + '.png';
        hl.style.display = 'block';
        hl.onerror = function() { this.style.display='none'; };
    }
    if (s.away_team_id) {
        const al = document.getElementById('awayLogo');
        al.src = '/images/logos/' + s.away_team_id + '.png';
        al.style.display = 'block';
        al.onerror = function() { this.style.display='none'; };
    }

    // Quarter scores table
    const hq = s.home_quarters || [];
    const aq = s.away_quarters || [];
    if (hq.length > 0) {
        let headers = hq.map(function(_, i) { return i < 4 ? 'Q' + (i+1) : 'OT' + (i-3); }).join('</th><th>');
        let html = '<table>' +
            '<tr><th></th><th>' + headers + '</th><th>T</th></tr>' +
            '<tr><td class="qs-label">' + s.away_team + '</td>' +
            aq.map(function(q) { return '<td>' + q + '</td>'; }).join('') +
            '<td class="qs-label">' + s.away_score + '</td></tr>' +
            '<tr><td class="qs-label">' + s.home_team + '</td>' +
            hq.map(function(q) { return '<td>' + q + '</td>'; }).join('') +
            '<td class="qs-label">' + s.home_score + '</td></tr>' +
            '</table>';
        document.getElementById('quarterScores').innerHTML = html;
    }
}

function updateWinProb(pred, s) {
    let homeWP = 50;
    if (pred && pred.home_win_prob != null) homeWP = pred.home_win_prob;
    const awayWP = Math.round(100 - homeWP);
    document.getElementById('wpHome').textContent = (s ? s.home_team + ' ' : '') + Math.round(homeWP) + '%';
    document.getElementById('wpAway').textContent = (s ? s.away_team + ' ' : '') + awayWP + '%';
    document.getElementById('wpBarHome').style.width = homeWP + '%';
    document.getElementById('wpBarAway').style.width = awayWP + '%';
}

function updatePrediction(pred, s) {
    const el = document.getElementById('predictionInfo');
    if (!pred) {
        el.innerHTML = '<div class="text-muted text-sm">No prediction available</div>';
        return;
    }
    const sp = pred.spread || 0;
    const spSign = sp > 0 ? '+' : '';
    el.innerHTML =
        '<div class="pred-grid">' +
        '<div class="stat-card stat-card-sm">' +
            '<div class="stat-value stat-value-md text-success">' + spSign + sp.toFixed(1) + '</div>' +
            '<div class="stat-label">Spread</div>' +
        '</div>' +
        '<div class="stat-card stat-card-sm">' +
            '<div class="stat-value stat-value-md">' + (pred.total || 0).toFixed(1) + '</div>' +
            '<div class="stat-label">Total</div>' +
        '</div>' +
        '<div class="stat-card stat-card-sm">' +
            '<div class="stat-value stat-value-sm">' + (pred.away_score || 0).toFixed(1) + '</div>' +
            '<div class="stat-label">' + (s ? s.away_team : 'Away') + '</div>' +
        '</div>' +
        '<div class="stat-card stat-card-sm">' +
            '<div class="stat-value stat-value-sm">' + (pred.home_score || 0).toFixed(1) + '</div>' +
            '<div class="stat-label">' + (s ? s.home_team : 'Home') + '</div>' +
        '</div>' +
        '</div>';
}

function updateOdds(odds) {
    if (!odds) return;
    const el = document.getElementById('oddsInfo');
    let html = '';
    if (odds.spread != null) html += '<p>Spread: <span class="font-bold">' + odds.spread + '</span></p>';
    if (odds.over_under != null) html += '<p>O/U: <span class="font-bold">' + odds.over_under + '</span></p>';
    if (odds.home_moneyline != null) html += '<p>Home ML: <span class="font-mono">' + odds.home_moneyline + '</span></p>';
    if (odds.away_moneyline != null) html += '<p>Away ML: <span class="font-mono">' + odds.away_moneyline + '</span></p>';
    if (odds.provider) html += '<p class="text-xs text-muted">' + odds.provider + '</p>';
    if (!html) html = '<span class="text-muted">No odds available</span>';
    el.innerHTML = html;
}

function switchBoxTab(side) {
    document.querySelectorAll('#boxTabs .tab').forEach(function(t) { t.classList.remove('active'); });
    document.getElementById('boxAway').classList.remove('active');
    document.getElementById('boxHome').classList.remove('active');
    if (side === 'home') {
        document.querySelectorAll('#boxTabs .tab')[1].classList.add('active');
        document.getElementById('boxHome').classList.add('active');
    } else {
        document.querySelectorAll('#boxTabs .tab')[0].classList.add('active');
        document.getElementById('boxAway').classList.add('active');
    }
}

function updateBoxScore(box, s) {
    if (!box) return;
    fillBoxTable('boxAwayTable', box.away || []);
    fillBoxTable('boxHomeTable', box.home || []);
}

function fillBoxTable(tableId, players) {
    const tbody = document.querySelector('#' + tableId + ' tbody');
    if (!tbody) return;
    tbody.innerHTML = players.map(function(p) {
        const photo = p.headshot ?
            '<img src="' + p.headshot + '" class="box-player-photo" onerror="this.style.display=\'none\'">' :
            '';
        return '<tr>' +
            '<td class="player-thumb-cell">' + photo + '</td>' +
            '<td class="font-bold">' + (p.name || '') + '</td>' +
            '<td class="font-mono text-center">' + (p.min || '') + '</td>' +
            '<td class="font-mono text-center font-bold">' + (p.pts || '') + '</td>' +
            '<td class="font-mono text-center">' + (p.reb || '') + '</td>' +
            '<td class="font-mono text-center">' + (p.ast || '') + '</td>' +
            '<td class="font-mono text-center">' + (p.stl || '') + '</td>' +
            '<td class="font-mono text-center">' + (p.blk || '') + '</td>' +
            '<td class="font-mono text-center">' + (p.fg || '') + '</td>' +
            '<td class="font-mono text-center">' + (p.threept || '') + '</td>' +
            '<td class="font-mono text-center">' + (p.plusminus || '') + '</td>' +
        '</tr>';
    }).join('');
}

function updatePlays(plays, s) {
    if (!plays) return;
    const el = document.getElementById('plays');
    const homeTid = s ? s.home_team_id : null;
    // Show newest first
    const reversed = plays.slice().reverse();
    el.innerHTML = reversed.map(function(p) {
        let borderClass = '';
        let scoringClass = p.scoring ? ' play-scoring' : '';
        let logoHtml = '';
        if (p.team_id) {
            logoHtml = '<img src="/images/logos/' + p.team_id + '.png" class="play-logo" onerror="this.style.display=\'none\'">';
            borderClass = p.team_id === homeTid ? ' play-home' : ' play-away';
        }
        const perLabel = p.period <= 4 ? 'Q' + p.period : 'OT' + (p.period - 4);
        const scoreText = (p.away_score || p.home_score) ?
            '<span class="play-score">' + p.away_score + '-' + p.home_score + '</span>' : '';
        return '<div class="play-item' + borderClass + scoringClass + '">' +
            '<span class="play-logo-cell">' + logoHtml + '</span>' +
            '<span class="time">' + perLabel + ' ' + (p.clock || '') + '</span>' +
            '<span class="play-text' + (p.scoring ? ' text-success font-bold' : '') + '">' + (p.text || '') + '</span>' +
            scoreText +
        '</div>';
    }).join('');
}

// ---- Team Colors ----
const TEAM_COLORS = {
    1610612737:["#E03A3E","#C1D32F"],1610612738:["#007A33","#BA9653"],1610612739:["#860038","#041E42"],
    1610612740:["#0C2340","#C8102E"],1610612741:["#CE1141","#000000"],1610612742:["#00538C","#002B5E"],
    1610612743:["#0E2240","#FEC524"],1610612744:["#1D428A","#FFC72C"],1610612745:["#CE1141","#000000"],
    1610612746:["#C8102E","#1D428A"],1610612747:["#552583","#FDB927"],1610612748:["#98002E","#F9A01B"],
    1610612749:["#00471B","#EEE1C6"],1610612750:["#0C2340","#236192"],1610612751:["#000000","#FFFFFF"],
    1610612752:["#006BB6","#F58426"],1610612753:["#0077C0","#000000"],1610612754:["#002D62","#FDBB30"],
    1610612755:["#006BB6","#ED174C"],1610612756:["#1D1160","#E56020"],1610612757:["#E03A3E","#000000"],
    1610612758:["#5A2D81","#63727A"],1610612759:["#C4CED4","#000000"],1610612760:["#007AC1","#EF6100"],
    1610612761:["#CE1141","#000000"],1610612762:["#002B5C","#00471B"],1610612763:["#5D76A9","#12173F"],
    1610612764:["#002B5C","#E31837"],1610612765:["#C8102E","#1D42BA"],1610612766:["#1D1160","#00788C"],
};

function applyTeamColors(s) {
    if (!s) return;
    const hc = TEAM_COLORS[s.home_team_id] || ["#3b82f6","#1e293b"];
    const ac = TEAM_COLORS[s.away_team_id] || ["#ef4444","#1e293b"];
    document.getElementById('wpBarHome').style.background = hc[0];
    document.getElementById('wpBarAway').style.background = ac[0];
    document.getElementById('homeScore').style.color = hc[0];
    document.getElementById('awayScore').style.color = ac[0];
    document.documentElement.style.setProperty('--team-home', hc[0]);
    document.documentElement.style.setProperty('--team-away', ac[0]);
}

// ---- Court Visualization ----
const COURT_W = 50, COURT_H = 47, HOOP_X = 25, HOOP_Y = 5.25;
let courtShots = [];

function drawCourt() {
    const canvas = document.getElementById('courtCanvas');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const W = canvas.width, H = canvas.height;
    const margin = 10;
    const cw = W - 2*margin, ch = H - 2*margin;

    ctx.clearRect(0, 0, W, H);
    ctx.fillStyle = '#1a2744';
    ctx.fillRect(0, 0, W, H);

    function cx(x) { return margin + (x / COURT_W) * cw; }
    function cy(y) { return margin + (y / COURT_H) * ch; }

    ctx.strokeStyle = '#ffffff40';
    ctx.lineWidth = 1.5;

    // Court outline
    ctx.beginPath();
    ctx.rect(cx(0), cy(0), cw, ch);
    ctx.stroke();

    // Paint / key (16ft wide)
    const keyL = cx(17), keyR = cx(33), keyTop = cy(0), keyBot = cy(19);
    ctx.beginPath();
    ctx.rect(keyL, keyTop, keyR - keyL, keyBot - keyTop);
    ctx.stroke();

    // Free throw circle
    ctx.beginPath();
    ctx.arc(cx(25), cy(19), (6/COURT_W)*cw, 0, Math.PI*2);
    ctx.stroke();

    // Hoop
    ctx.beginPath();
    ctx.arc(cx(HOOP_X), cy(HOOP_Y), 3, 0, Math.PI*2);
    ctx.strokeStyle = '#ff6b35';
    ctx.lineWidth = 2;
    ctx.stroke();

    // Backboard
    ctx.beginPath();
    ctx.moveTo(cx(22), cy(4));
    ctx.lineTo(cx(28), cy(4));
    ctx.strokeStyle = '#ffffff60';
    ctx.lineWidth = 2;
    ctx.stroke();

    // Three-point arc
    ctx.beginPath();
    ctx.strokeStyle = '#ffffff40';
    ctx.lineWidth = 1.5;
    // Corner 3s (14ft straight lines from baseline at x=3 and x=47)
    ctx.moveTo(cx(3), cy(0));
    ctx.lineTo(cx(3), cy(14));
    // Arc from (3,14) around hoop (25,5.25) radius 23.75
    const r3 = 23.75;
    const startAng = Math.atan2(14 - HOOP_Y, 3 - HOOP_X);
    const endAng = Math.atan2(14 - HOOP_Y, 47 - HOOP_X);
    ctx.arc(cx(HOOP_X), cy(HOOP_Y), (r3/COURT_W)*cw, startAng, endAng);
    ctx.lineTo(cx(47), cy(0));
    ctx.stroke();

    // Restricted area arc
    ctx.beginPath();
    ctx.arc(cx(HOOP_X), cy(HOOP_Y), (4/COURT_W)*cw, Math.PI, 0);
    ctx.stroke();

    // Draw shots
    courtShots.forEach(function(shot) {
        const sx = cx(shot.x), sy = cy(shot.y);
        if (shot.made) {
            ctx.beginPath();
            ctx.arc(sx, sy, 4, 0, Math.PI*2);
            ctx.fillStyle = 'rgba(34,197,94,0.8)';
            ctx.fill();
        } else {
            ctx.beginPath();
            ctx.moveTo(sx-3, sy-3); ctx.lineTo(sx+3, sy+3);
            ctx.moveTo(sx+3, sy-3); ctx.lineTo(sx-3, sy+3);
            ctx.strokeStyle = 'rgba(239,68,68,0.7)';
            ctx.lineWidth = 2;
            ctx.stroke();
        }
    });
}

function updateCourt(plays) {
    if (!plays) return;
    const newShots = [];
    plays.forEach(function(p) {
        if (p.coordinate && typeof p.coordinate.x === 'number' && typeof p.coordinate.y === 'number') {
            if (Math.abs(p.coordinate.x) < 200 && Math.abs(p.coordinate.y) < 200) {
                newShots.push({ x: p.coordinate.x, y: p.coordinate.y, made: !!p.scoring, team_id: p.team_id });
            }
        }
    });
    if (newShots.length > 0) {
        courtShots = newShots.slice(-30);
        drawCourt();
    }
}

// Initial court draw
setTimeout(drawCourt, 100);

loadGames();
</script>
{% endblock %}
