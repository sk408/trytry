{% extends "base.html" %}
{% set active = "gamecast" %}
{% block title %}Gamecast â€” NBA Predictor{% endblock %}

{% block content %}
<h1 class="page-title">Gamecast</h1>

<!-- Game Selector -->
<div class="card mb-4 game-selector" id="game-selector">
    <h2 class="game-selector-toggle" onclick="toggleGameSelector()" style="margin:0; padding:16px; cursor:pointer; display:flex; justify-content:space-between; align-items:center;">
        <span>Select Game</span>
        <span class="toggle-icon" id="gameSelectorIcon">&#9660;</span>
    </h2>
    <div id="gameList" class="games-list" style="display:flex; flex-direction:column; padding:0 16px 16px 16px; gap:8px;">
        <div style="padding:12px;text-align:center;color:var(--text-muted);">Loading games...</div>
    </div>
</div>

<div id="gameDetail" class="hidden">
    <!-- Live Score -->
    <div class="card" id="score-card">
        <div class="score-display">
            <div class="score-team">
                <img id="awayLogo" src="" width="48" height="48" class="team-logo-lg" alt="" onerror="this.style.display='none'">
                <span class="team-name" id="awayTeamName">Away Name</span>
                <span class="team-abbr" id="awayTeam">Away</span>
                <span class="team-score" id="awayScore">0</span>
            </div>
            <div class="score-status">
                <div id="statusBadge" class="live-badge" style="display:none;">LIVE</div>
                <div id="finalBadge" class="final-badge" style="display:none;">FINAL</div>
                <span id="period" style="font-weight:bold;margin-top:4px;"></span>
                <span id="clock" style="font-size:1.2rem;"></span>
            </div>
            <div class="score-team">
                <img id="homeLogo" src="" width="48" height="48" class="team-logo-lg" alt="" onerror="this.style.display='none'">
                <span class="team-name" id="homeTeamName">Home Name</span>
                <span class="team-abbr" id="homeTeam">Home</span>
                <span class="team-score" id="homeScore">0</span>
            </div>
        </div>
        <div class="quarter-scores" id="quarterScores" style="text-align:center;font-size:0.8rem;color:var(--text-muted);margin-bottom:12px;"></div>
    </div>

    <!-- Live Odds & Prediction (Grid) -->
    <div class="grid-2">
        <!-- Prediction -->
        <div class="card">
            <h2>Model Prediction</h2>
            
            <!-- Win Probability -->
            <div class="win-prob-container mt-2 mb-4">
                <div class="win-prob-labels">
                    <span><span id="awayLabelWp">AWAY</span> <span id="wpAway">50%</span></span>
                    <span><span id="wpHome">50%</span> <span id="homeLabelWp">HOME</span></span>
                </div>
                <div class="win-prob-bar">
                    <div class="win-prob-away" id="wpBarAway" style="width: 50%"></div>
                    <div class="win-prob-home" id="wpBarHome" style="width: 50%"></div>
                </div>
            </div>

            <div id="predictionInfo" class="pred-summary">
                <div class="text-muted text-sm" style="grid-column: 1 / -1;">Waiting for prediction...</div>
            </div>
        </div>

        <!-- Vegas Odds -->
        <div class="card">
            <h2>Vegas Odds</h2>
            <div id="oddsInfo" class="odds-grid mt-2">
                <div class="text-muted text-sm" style="grid-column: 1 / -1;">Loading...</div>
            </div>
        </div>
    </div>

    <!-- Play-by-Play & Court Visualization -->
    <div class="grid-2 mt-4">
        <div class="card">
            <h2>Shot Chart</h2>
            <div style="position:relative;width:100%;max-width:500px;margin:0 auto;">
                <canvas id="courtCanvas" width="500" height="470" style="width:100%;background:#1a2744;border-radius:8px;"></canvas>
            </div>
        </div>
        
        <div class="card">
            <h2>Play-by-Play</h2>
            <div class="play-feed" id="plays"></div>
        </div>
    </div>

    <!-- Box Score -->
    <div class="card mt-4">
        <h2>Box Score</h2>
        <div class="tabs" id="boxTabs" style="margin-bottom: 12px; display:flex; gap: 8px;">
            <button class="btn btn-primary" id="btnBoxAway" onclick="switchBoxTab('away')"><span id="boxAwayLabel">Away</span></button>
            <button class="btn btn-outline" id="btnBoxHome" onclick="switchBoxTab('home')"><span id="boxHomeLabel">Home</span></button>
        </div>
        <div id="boxAway" class="tab-content active scroll-x">
            <table class="box-table" id="boxAwayTable" style="width:100%;text-align:left;">
                <thead><tr><th style="width:32px"></th><th>Player</th><th>MIN</th><th>PTS</th><th>REB</th><th>AST</th><th>STL</th><th>BLK</th><th>FG</th><th>3PT</th><th>+/-</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
        <div id="boxHome" class="tab-content" style="display:none;" class="scroll-x">
            <table class="box-table" id="boxHomeTable" style="width:100%;text-align:left;">
                <thead><tr><th style="width:32px"></th><th>Player</th><th>MIN</th><th>PTS</th><th>REB</th><th>AST</th><th>STL</th><th>BLK</th><th>FG</th><th>3PT</th><th>+/-</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
/* Game Selector Styles */
.game-selector-toggle {
    user-select: none;
    font-size: 1rem;
}
.game-selector-toggle:hover {
    background: rgba(255,255,255,0.03);
}
.toggle-icon {
    font-size: 0.75rem;
    color: var(--text-muted);
}
.game-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    margin-bottom: 8px;
    border-radius: 8px;
    background: var(--bg-dark);
    text-decoration: none;
    color: var(--text);
    transition: background 0.2s, transform 0.1s;
    border: 1px solid transparent;
}
.game-row:hover {
    background: rgba(255,255,255,0.05);
}
.game-row.active {
    border-color: var(--accent);
    background: rgba(59, 130, 246, 0.1);
}
.game-teams {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 700;
}
.team-logo-small {
    width: 24px;
    height: 24px;
    object-fit: contain;
}
.at {
    color: var(--text-muted);
    font-weight: 400;
    font-size: 0.8rem;
}
.game-status {
    font-size: 0.85rem;
    font-weight: 600;
    text-align: right;
}

/* Score Display */
.score-display {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 0;
}

.score-team {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  flex: 1;
}

.team-name {
  font-size: 0.75rem;
  color: var(--text-muted);
  text-align: center;
}

.team-abbr {
  font-size: 1rem;
  font-weight: 700;
}

.team-score {
  font-size: 2.5rem;
  font-weight: 800;
  color: var(--accent);
}

.score-status {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  padding: 0 16px;
}

.live-badge {
  background: var(--danger);
  color: white;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 0.75rem;
  font-weight: 700;
  animation: pulse 2s infinite;
}

.final-badge {
  background: var(--border);
  color: var(--text);
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 0.75rem;
  font-weight: 700;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

/* Win Probability */
.win-prob-container {
  margin-bottom: 20px;
}

.win-prob-labels {
  display: flex;
  justify-content: space-between;
  font-size: 0.875rem;
  font-weight: 600;
  margin-bottom: 8px;
}

.win-prob-bar {
  display: flex;
  height: 12px;
  border-radius: 6px;
  overflow: hidden;
  background: var(--bg-dark);
}

.win-prob-away {
  background: var(--danger);
  transition: width 0.5s ease;
}

.win-prob-home {
  background: var(--accent);
  transition: width 0.5s ease;
}

/* Odds Grid */
.odds-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
}

.odds-item {
  background: var(--bg-dark);
  border-radius: 8px;
  padding: 12px;
  text-align: center;
}

.odds-label {
  display: block;
  font-size: 0.75rem;
  color: var(--text-muted);
  text-transform: uppercase;
  margin-bottom: 4px;
}

.odds-value {
  display: block;
  font-size: 1.25rem;
  font-weight: 700;
  color: var(--text);
}

.odds-sub {
  display: block;
  font-size: 0.75rem;
  color: var(--text-muted);
  margin-top: 4px;
}

/* Prediction Summary */
.pred-summary {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 8px;
  margin-top: 12px;
}

.pred-item {
  background: var(--bg-dark);
  border-radius: 6px;
  padding: 10px;
  text-align: center;
}

.pred-label {
  display: block;
  font-size: 0.7rem;
  color: var(--text-muted);
  text-transform: uppercase;
  margin-bottom: 4px;
}

.pred-value {
  font-size: 1rem;
  font-weight: 700;
}

/* Play Feed */
.play-feed {
  max-height: 400px;
  overflow-y: auto;
}

.play-item {
  padding: 12px;
  border-bottom: 1px solid var(--border);
  transition: background 0.3s;
}

.play-item:last-child {
  border-bottom: none;
}

.play-item.new {
  background: rgba(59, 130, 246, 0.15);
}

.play-meta {
  display: flex;
  gap: 8px;
  font-size: 0.75rem;
  color: var(--text-muted);
  margin-bottom: 4px;
}

.play-period {
  font-weight: 700;
}

.play-body {
  display: flex;
  align-items: flex-start;
  gap: 8px;
}

.play-team-badge {
  display: inline-block;
  flex-shrink: 0;
  min-width: 38px;
  text-align: center;
  font-size: 0.75rem;
  font-weight: 800;
  padding: 3px 6px;
  border-radius: 4px;
  letter-spacing: 0.3px;
  background: var(--bg-dark);
  color: var(--text-muted);
}
.play-team-badge.badge-home {
  background: rgba(59, 130, 246, 0.18);
  color: #3b82f6;
}
.play-team-badge.badge-away {
  background: rgba(231, 76, 60, 0.15);
  color: #e74c3c;
}

.play-text {
  font-size: 0.9rem;
  line-height: 1.4;
  flex: 1;
}

.play-score {
  font-size: 0.875rem;
  font-weight: 700;
  color: var(--text-muted);
  margin-top: 4px;
}

/* Team-colored play borders */
.play-item.play-home {
  border-left: 3px solid var(--accent);
}
.play-item.play-away {
  border-left: 3px solid var(--danger);
}
.play-item.scoring {
  border-left: 3px solid var(--success);
}
.play-item.scoring.play-home {
  border-left: 3px solid var(--success);
}
.play-item.scoring.play-away {
  border-left: 3px solid var(--success);
}
.play-item.foul-play {
  background: rgba(231, 76, 60, 0.06);
}

/* Foul tags */
.foul-tag {
  display: inline-block;
  font-size: 0.65rem;
  font-weight: 700;
  text-transform: uppercase;
  padding: 1px 5px;
  border-radius: 3px;
  background: rgba(231, 76, 60, 0.15);
  color: var(--danger);
  letter-spacing: 0.3px;
}
.foul-tag.foul-shooting {
  background: rgba(241, 196, 15, 0.2);
  color: #f39c12;
}
.foul-tag.foul-flagrant {
  background: rgba(231, 76, 60, 0.25);
  color: #e74c3c;
  font-weight: 800;
}
.foul-tag.foul-technical {
  background: rgba(155, 89, 182, 0.2);
  color: #9b59b6;
}
.foul-tag.foul-offensive {
  background: rgba(149, 165, 166, 0.2);
  color: var(--text-muted);
}

/* Box Score Table */
.box-table {
  font-size: 0.85rem;
}

.box-table th {
  font-size: 0.75rem;
  padding: 8px 6px;
  color: var(--text-muted);
}

.box-table td {
  padding: 8px 6px;
  border-bottom: 1px solid var(--border);
}

/* Desktop */
@media (min-width: 768px) {
  .team-score {
    font-size: 3.5rem;
  }
  .team-name {
    font-size: 0.875rem;
  }
}
</style>

<script>
let gameES = null;
let currentSummary = null;

function toggleGameSelector() {
    const list = document.getElementById('gameList');
    const icon = document.getElementById('gameSelectorIcon');
    if (list.style.display === 'none') {
        list.style.display = 'block';
        icon.innerHTML = '&#9660;'; // down arrow
    } else {
        list.style.display = 'none';
        icon.innerHTML = '&#9654;'; // right arrow
    }
}

async function loadGames() {
    try {
        const r = await fetch('/api/gamecast/games');
        const games = await r.json();
        const el = document.getElementById('gameList');
        if (!games || games.error || !Array.isArray(games) || games.length === 0) {
            el.innerHTML = '<div style="padding: 12px; text-align:center;" class="text-muted">No games today</div>';
            return;
        }
        
        el.innerHTML = games.map(g => {
            const id = g.espn_id || g.id || g.game_id;
            
            let statusHtml = '';
            if (g.status_state === 'in') {
                statusHtml = `
                    <span class="text-success" style="animation:pulse 2s infinite;">LIVE Q${g.period || '?'} ${g.clock || ''}</span>
                    <span style="margin-left: 8px;">${g.away_score || 0} - ${g.home_score || 0}</span>
                `;
            } else if (g.status_state === 'post') {
                statusHtml = `
                    <span class="text-muted">FINAL</span>
                    <span style="margin-left: 8px;">${g.away_score || 0} - ${g.home_score || 0}</span>
                `;
            } else {
                statusHtml = `<span class="text-muted">${g.status || 'Upcoming'}</span>`;
            }
            
            return `
                <a href="#" class="game-row" onclick="event.preventDefault(); selectGame('${id}', this);">
                    <div class="game-teams">
                        <img src="/images/logos/${g.away_team_id || g.home_team_id}.png" class="team-logo-small" onerror="this.style.display='none'">
                        <span>${g.away_team || 'AWAY'}</span>
                        <span class="at">@</span>
                        <img src="/images/logos/${g.home_team_id}.png" class="team-logo-small" onerror="this.style.display='none'">
                        <span class="home">${g.home_team || 'HOME'}</span>
                    </div>
                    <div class="game-status">
                        ${statusHtml}
                    </div>
                </a>
            `;
        }).join('');
        
        // Only run after elements are rendered
        setTimeout(() => {
            {% if game_id %}
            // Pre-select if URL has ID
            const preSelected = document.querySelector(`.game-row[onclick*="{{ game_id }}"]`);
            if (preSelected) selectGame('{{ game_id }}', preSelected);
            {% endif %}
        }, 100);
    } catch(e) {
        document.getElementById('gameList').innerHTML = '<div style="padding: 12px; text-align:center;" class="text-muted">Error loading games</div>';
    }
}

function selectGame(gameId, element = null) {
    // UI state
    if (element) {
        document.querySelectorAll('.game-row').forEach(row => row.classList.remove('active'));
        element.classList.add('active');
        const list = document.getElementById('gameList');
        const icon = document.getElementById('gameSelectorIcon');
        list.style.display = 'none';
        icon.innerHTML = '&#9654;'; // right arrow
    }

    document.getElementById('gameDetail').classList.remove('hidden');
    if (gameES) gameES.close();
    gameES = new EventSource('/api/gamecast/stream/' + gameId);
    gameES.onmessage = function(e) {
        try {
            const data = JSON.parse(e.data);
            if (data.error) return;
            currentSummary = data.summary;
            updateScoreboard(data.summary);
            applyTeamColors(data.summary);
            updateWinProb(data.prediction, data.summary);
            updatePrediction(data.prediction, data.summary);
            updateOdds(data.odds);
            updateBoxScore(data.boxscore, data.summary);
            updatePlays(data.plays, data.summary);
            updateCourt(data.plays);
        } catch(err) { console.error(err); }
    };
}

function updateScoreboard(s) {
    if (!s) return;
    document.getElementById('homeTeam').textContent = s.home_team || 'Home';
    document.getElementById('awayTeam').textContent = s.away_team || 'Away';
    document.getElementById('homeTeamName').textContent = s.home_team || '';
    document.getElementById('awayTeamName').textContent = s.away_team || '';
    document.getElementById('homeScore').textContent = s.home_score || '0';
    document.getElementById('awayScore').textContent = s.away_score || '0';
    document.getElementById('boxAwayLabel').textContent = s.away_team;
    document.getElementById('boxHomeLabel').textContent = s.home_team;
    document.getElementById('awayLabelWp').textContent = s.away_team;
    document.getElementById('homeLabelWp').textContent = s.home_team;

    const st = s.status_state;
    if (st === 'in') {
        document.getElementById('statusBadge').style.display = 'inline-block';
        document.getElementById('finalBadge').style.display = 'none';
        document.getElementById('period').textContent = 'Q' + s.period;
        document.getElementById('clock').textContent = s.clock;
    } else if (st === 'post') {
        document.getElementById('statusBadge').style.display = 'none';
        document.getElementById('finalBadge').style.display = 'inline-block';
        document.getElementById('period').textContent = '';
        document.getElementById('clock').textContent = '';
    } else {
        document.getElementById('statusBadge').style.display = 'none';
        document.getElementById('finalBadge').style.display = 'none';
        document.getElementById('period').textContent = s.status || '';
        document.getElementById('clock').textContent = s.clock || '';
    }

    // Logos
    if (s.home_team_id) {
        const hl = document.getElementById('homeLogo');
        hl.src = '/images/logos/' + s.home_team_id + '.png';
        hl.style.display = 'block';
        hl.onerror = function() { this.style.display='none'; };
    }
    if (s.away_team_id) {
        const al = document.getElementById('awayLogo');
        al.src = '/images/logos/' + s.away_team_id + '.png';
        al.style.display = 'block';
        al.onerror = function() { this.style.display='none'; };
    }

    // Quarter scores table
    const hq = s.home_quarters || [];
    const aq = s.away_quarters || [];
    if (hq.length > 0) {
        let headers = hq.map(function(_, i) { return i < 4 ? 'Q' + (i+1) : 'OT' + (i-3); }).join('</th><th>');
        let html = '<table style="width:auto;margin:0 auto;font-size:0.8rem;">' +
            '<tr><th></th><th>' + headers + '</th><th>T</th></tr>' +
            '<tr><td class="font-bold" style="padding:4px 8px;text-align:right;">' + s.away_team + '</td>' +
            aq.map(function(q) { return '<td style="padding:4px 8px;text-align:center;">' + q + '</td>'; }).join('') +
            '<td class="font-bold" style="padding:4px 8px;">' + s.away_score + '</td></tr>' +
            '<tr><td class="font-bold" style="padding:4px 8px;text-align:right;">' + s.home_team + '</td>' +
            hq.map(function(q) { return '<td style="padding:4px 8px;text-align:center;">' + q + '</td>'; }).join('') +
            '<td class="font-bold" style="padding:4px 8px;">' + s.home_score + '</td></tr>' +
            '</table>';
        document.getElementById('quarterScores').innerHTML = html;
    }
}

function updateWinProb(pred, s) {
    let homeWP = 50;
    if (pred && pred.home_win_prob != null) homeWP = pred.home_win_prob;
    const awayWP = Math.round(100 - homeWP);
    document.getElementById('wpHome').textContent = Math.round(homeWP) + '%';
    document.getElementById('wpAway').textContent = awayWP + '%';
    document.getElementById('wpBarHome').style.width = homeWP + '%';
    document.getElementById('wpBarAway').style.width = awayWP + '%';
}

function updatePrediction(pred, s) {
    const el = document.getElementById('predictionInfo');
    if (!pred) {
        el.innerHTML = '<div class="text-muted text-sm" style="grid-column: 1 / -1;">No prediction available</div>';
        return;
    }
    const sp = pred.spread || 0;
    const spSign = sp > 0 ? '+' : '';
    const hAbbr = s ? s.home_team : 'Home';
    const aAbbr = s ? s.away_team : 'Away';
    
    el.innerHTML = `
        <div class="pred-item">
            <span class="pred-label">Spread</span>
            <span class="pred-value text-success">${hAbbr} ${spSign}${sp.toFixed(1)}</span>
        </div>
        <div class="pred-item">
            <span class="pred-label">Total</span>
            <span class="pred-value">${(pred.total || 0).toFixed(1)}</span>
        </div>
        <div class="pred-item">
            <span class="pred-label">Proj ${aAbbr}</span>
            <span class="pred-value">${(pred.away_score || 0).toFixed(1)}</span>
        </div>
        <div class="pred-item">
            <span class="pred-label">Proj ${hAbbr}</span>
            <span class="pred-value">${(pred.home_score || 0).toFixed(1)}</span>
        </div>
    `;
}

function updateOdds(odds) {
    const el = document.getElementById('oddsInfo');
    if (!odds || (!odds.spread && !odds.away_moneyline && !odds.home_moneyline)) {
        el.innerHTML = '<div class="text-muted text-sm" style="grid-column: 1 / -1;">No odds available</div>';
        return;
    }
    el.innerHTML = `
        <div class="odds-item">
            <span class="odds-label">Spread</span>
            <span class="odds-value">${odds.spread || 'N/A'}</span>
        </div>
        <div class="odds-item">
            <span class="odds-label">Over/Under</span>
            <span class="odds-value">${odds.over_under || 'N/A'}</span>
        </div>
        <div class="odds-item">
            <span class="odds-label">Away ML</span>
            <span class="odds-value">${odds.away_moneyline || 'N/A'}</span>
        </div>
        <div class="odds-item">
            <span class="odds-label">Home ML</span>
            <span class="odds-value">${odds.home_moneyline || 'N/A'}</span>
        </div>
        ${odds.provider ? `<div class="text-xs text-muted" style="grid-column: 1 / -1; text-align: right; margin-top: 8px;">Via ${odds.provider}</div>` : ''}
    `;
}

function switchBoxTab(side) {
    if (side === 'home') {
        document.getElementById('btnBoxHome').className = 'btn btn-primary';
        document.getElementById('btnBoxAway').className = 'btn btn-outline';
        document.getElementById('boxHome').style.display = 'block';
        document.getElementById('boxAway').style.display = 'none';
    } else {
        document.getElementById('btnBoxAway').className = 'btn btn-primary';
        document.getElementById('btnBoxHome').className = 'btn btn-outline';
        document.getElementById('boxAway').style.display = 'block';
        document.getElementById('boxHome').style.display = 'none';
    }
}

function updateBoxScore(box, s) {
    if (!box) return;
    fillBoxTable('boxAwayTable', box.away || []);
    fillBoxTable('boxHomeTable', box.home || []);
}

function fillBoxTable(tableId, players) {
    const tbody = document.querySelector('#' + tableId + ' tbody');
    if (!tbody) return;
    tbody.innerHTML = players.map(function(p) {
        const photo = p.headshot ?
            '<img src="' + p.headshot + '" style="width:24px;height:24px;border-radius:50%;object-fit:cover;" onerror="this.style.display=\'none\'">' :
            '';
        return '<tr>' +
            '<td style="width:32px;padding:4px;">' + photo + '</td>' +
            '<td class="font-bold">' + (p.name || '') + '</td>' +
            '<td class="font-mono text-center">' + (p.min || '') + '</td>' +
            '<td class="font-mono text-center font-bold">' + (p.pts || '') + '</td>' +
            '<td class="font-mono text-center">' + (p.reb || '') + '</td>' +
            '<td class="font-mono text-center">' + (p.ast || '') + '</td>' +
            '<td class="font-mono text-center">' + (p.stl || '') + '</td>' +
            '<td class="font-mono text-center">' + (p.blk || '') + '</td>' +
            '<td class="font-mono text-center">' + (p.fg || '') + '</td>' +
            '<td class="font-mono text-center">' + (p.threept || '') + '</td>' +
            '<td class="font-mono text-center">' + (p.plusminus || '') + '</td>' +
        '</tr>';
    }).join('');
}

function updatePlays(plays, s) {
    if (!plays) return;
    const el = document.getElementById('plays');
    const homeTid = s ? s.home_team_id : null;
    const homeAbbr = s ? s.home_team : null;
    const awayAbbr = s ? s.away_team : null;
    
    // Show newest first
    const reversed = plays.slice().reverse();
    el.innerHTML = reversed.map(function(p) {
        const isHome = p.team_id === homeTid;
        const isAway = p.team_id && p.team_id !== homeTid;
        
        let playClass = 'play-item';
        if (isHome) playClass += ' play-home';
        else if (isAway) playClass += ' play-away';
        
        if (p.scoring) playClass += ' scoring';
        if (p.text && p.text.toLowerCase().includes('foul')) playClass += ' foul-play';
        
        const badgeClass = 'play-team-badge' + (isHome ? ' badge-home' : (isAway ? ' badge-away' : ''));
        const teamAbbr = isHome ? homeAbbr : (isAway ? awayAbbr : '');
        
        const perLabel = p.period <= 4 ? 'Q' + p.period : 'OT' + (p.period - 4);
        
        let foulTag = '';
        if (p.text && p.text.toLowerCase().includes('foul')) {
            const txt = p.text.toLowerCase();
            if (txt.includes('shooting')) foulTag = '<span class="foul-tag foul-shooting">FTs</span>';
            else if (txt.includes('flagrant')) foulTag = '<span class="foul-tag foul-flagrant">FLAGRANT</span>';
            else if (txt.includes('technical')) foulTag = '<span class="foul-tag foul-technical">TECH</span>';
            else if (txt.includes('offensive')) foulTag = '<span class="foul-tag foul-offensive">OFF</span>';
            else foulTag = '<span class="foul-tag">FOUL</span>';
        }
        
        return `
            <div class="${playClass}">
                <div class="play-meta">
                    <span class="play-period">${perLabel}</span>
                    <span class="play-clock">${p.clock || ''}</span>
                    ${foulTag}
                </div>
                <div class="play-body">
                    ${teamAbbr ? `<span class="${badgeClass}">${teamAbbr}</span>` : ''}
                    <span class="play-text" style="${p.scoring ? 'font-weight:600;color:var(--text);' : ''}">${p.text || ''}</span>
                </div>
                ${(p.away_score || p.home_score) ? `<div class="play-score">${awayAbbr || 'AWAY'} ${p.away_score} - ${p.home_score} ${homeAbbr || 'HOME'}</div>` : ''}
            </div>
        `;
    }).join('');
}

// ---- Team Colors ----
const TEAM_COLORS = {
    1610612737:["#E03A3E","#C1D32F"],1610612738:["#007A33","#BA9653"],1610612739:["#860038","#041E42"],
    1610612740:["#0C2340","#C8102E"],1610612741:["#CE1141","#000000"],1610612742:["#00538C","#002B5E"],
    1610612743:["#0E2240","#FEC524"],1610612744:["#1D428A","#FFC72C"],1610612745:["#CE1141","#000000"],
    1610612746:["#C8102E","#1D428A"],1610612747:["#552583","#FDB927"],1610612748:["#98002E","#F9A01B"],
    1610612749:["#00471B","#EEE1C6"],1610612750:["#0C2340","#236192"],1610612751:["#000000","#FFFFFF"],
    1610612752:["#006BB6","#F58426"],1610612753:["#0077C0","#000000"],1610612754:["#002D62","#FDBB30"],
    1610612755:["#006BB6","#ED174C"],1610612756:["#1D1160","#E56020"],1610612757:["#E03A3E","#000000"],
    1610612758:["#5A2D81","#63727A"],1610612759:["#C4CED4","#000000"],1610612760:["#007AC1","#EF6100"],
    1610612761:["#CE1141","#000000"],1610612762:["#002B5C","#00471B"],1610612763:["#5D76A9","#12173F"],
    1610612764:["#002B5C","#E31837"],1610612765:["#C8102E","#1D42BA"],1610612766:["#1D1160","#00788C"],
};

function applyTeamColors(s) {
    if (!s) return;
    const hc = TEAM_COLORS[s.home_team_id] || ["#3b82f6","#1e293b"];
    const ac = TEAM_COLORS[s.away_team_id] || ["#ef4444","#1e293b"];
    document.getElementById('wpBarHome').style.background = hc[0];
    document.getElementById('wpBarAway').style.background = ac[0];
    document.getElementById('homeScore').style.color = hc[0];
    document.getElementById('awayScore').style.color = ac[0];
    document.documentElement.style.setProperty('--team-home', hc[0]);
    document.documentElement.style.setProperty('--team-away', ac[0]);
}

// ---- Court Visualization ----
const COURT_W = 50, COURT_H = 47, HOOP_X = 25, HOOP_Y = 5.25;
let courtShots = [];

function drawCourt() {
    const canvas = document.getElementById('courtCanvas');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const W = canvas.width, H = canvas.height;
    const margin = 10;
    const cw = W - 2*margin, ch = H - 2*margin;

    ctx.clearRect(0, 0, W, H);
    ctx.fillStyle = '#1a2744';
    ctx.fillRect(0, 0, W, H);

    function cx(x) { return margin + (x / COURT_W) * cw; }
    function cy(y) { return margin + (y / COURT_H) * ch; }

    ctx.strokeStyle = '#ffffff40';
    ctx.lineWidth = 1.5;

    // Court outline
    ctx.beginPath();
    ctx.rect(cx(0), cy(0), cw, ch);
    ctx.stroke();

    // Paint / key (16ft wide)
    const keyL = cx(17), keyR = cx(33), keyTop = cy(0), keyBot = cy(19);
    ctx.beginPath();
    ctx.rect(keyL, keyTop, keyR - keyL, keyBot - keyTop);
    ctx.stroke();

    // Free throw circle
    ctx.beginPath();
    ctx.arc(cx(25), cy(19), (6/COURT_W)*cw, 0, Math.PI*2);
    ctx.stroke();

    // Hoop
    ctx.beginPath();
    ctx.arc(cx(HOOP_X), cy(HOOP_Y), 3, 0, Math.PI*2);
    ctx.strokeStyle = '#ff6b35';
    ctx.lineWidth = 2;
    ctx.stroke();

    // Backboard
    ctx.beginPath();
    ctx.moveTo(cx(22), cy(4));
    ctx.lineTo(cx(28), cy(4));
    ctx.strokeStyle = '#ffffff60';
    ctx.lineWidth = 2;
    ctx.stroke();

    // Three-point arc
    ctx.beginPath();
    ctx.strokeStyle = '#ffffff40';
    ctx.lineWidth = 1.5;
    // Corner 3s (14ft straight lines from baseline at x=3 and x=47)
    ctx.moveTo(cx(3), cy(0));
    ctx.lineTo(cx(3), cy(14));
    // Arc from (3,14) around hoop (25,5.25) radius 23.75
    const r3 = 23.75;
    const startAng = Math.atan2(14 - HOOP_Y, 3 - HOOP_X);
    const endAng = Math.atan2(14 - HOOP_Y, 47 - HOOP_X);
    ctx.arc(cx(HOOP_X), cy(HOOP_Y), (r3/COURT_W)*cw, startAng, endAng);
    ctx.lineTo(cx(47), cy(0));
    ctx.stroke();

    // Restricted area arc
    ctx.beginPath();
    ctx.arc(cx(HOOP_X), cy(HOOP_Y), (4/COURT_W)*cw, Math.PI, 0);
    ctx.stroke();

    // Draw shots
    courtShots.forEach(function(shot) {
        const sx = cx(shot.x), sy = cy(shot.y);
        if (shot.made) {
            ctx.beginPath();
            ctx.arc(sx, sy, 4, 0, Math.PI*2);
            ctx.fillStyle = 'rgba(34,197,94,0.8)';
            ctx.fill();
        } else {
            ctx.beginPath();
            ctx.moveTo(sx-3, sy-3); ctx.lineTo(sx+3, sy+3);
            ctx.moveTo(sx+3, sy-3); ctx.lineTo(sx-3, sy+3);
            ctx.strokeStyle = 'rgba(239,68,68,0.7)';
            ctx.lineWidth = 2;
            ctx.stroke();
        }
    });
}

function updateCourt(plays) {
    if (!plays) return;
    const newShots = [];
    plays.forEach(function(p) {
        if (p.coordinate && typeof p.coordinate.x === 'number' && typeof p.coordinate.y === 'number') {
            if (Math.abs(p.coordinate.x) < 200 && Math.abs(p.coordinate.y) < 200) {
                newShots.push({ x: p.coordinate.x, y: p.coordinate.y, made: !!p.scoring, team_id: p.team_id });
            }
        }
    });
    if (newShots.length > 0) {
        courtShots = newShots.slice(-30);
        drawCourt();
    }
}

// Initial court draw
setTimeout(drawCourt, 100);

loadGames();
</script>
{% endblock %}