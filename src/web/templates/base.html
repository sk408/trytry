<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#3b82f6">
    <link rel="manifest" href="/static/manifest.json">
    <title>{% block title %}NBA Predictor{% endblock %}</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&display=swap" rel="stylesheet">
    {% block head %}{% endblock %}
</head>
<body>
    <script>
        if (localStorage.getItem('oledMode') === 'true') {
            document.body.classList.add('oled-mode');
        }
    </script>
    <nav class="navbar" role="navigation" aria-label="Main navigation">
        <div class="nav-brand" style="display: flex; align-items: center; gap: 8px;">
            <button class="hamburger" onclick="toggleNav()" aria-label="Toggle navigation menu" aria-expanded="false" style="margin-right: 4px; padding: 4px;">
                <span></span><span></span><span></span>
            </button>
            <a href="/dashboard">NBA Predictor</a>
        </div>
        <ul class="nav-links" id="navLinks">
            <li><a href="/dashboard" {% if active == 'dashboard' %}class="active" aria-current="page"{% endif %}>Dashboard</a></li>
            <li><a href="/gamecast" {% if active == 'gamecast' %}class="active" aria-current="page"{% endif %}>Gamecast</a></li>
            <li><a href="/players" {% if active == 'players' %}class="active" aria-current="page"{% endif %}>Players</a></li>
            <li><a href="/matchups" {% if active == 'matchups' %}class="active" aria-current="page"{% endif %}>Matchups</a></li>
            <li><a href="/schedule" {% if active == 'schedule' %}class="active" aria-current="page"{% endif %}>Schedule</a></li>
            <li style="position:relative;">
                <button onclick="toggleNotifications(event)" aria-label="Notifications" aria-expanded="false" id="notifToggle"
                        style="background:none;border:none;cursor:pointer;padding:0.5rem 0.75rem;position:relative;font-size:1rem;">
                    <span aria-hidden="true">&#x1F514;</span>
                    <span class="sr-only">Notifications</span>
                    <span id="notifBadge" class="notif-badge" style="display:none;position:absolute;top:0;right:-4px;" aria-live="polite">0</span>
                </button>
                <div id="notifPanel" style="display:none;position:absolute;right:0;top:100%;width:320px;max-height:400px;overflow-y:auto;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:0 4px 12px var(--shadow);z-index:1001;padding:0;" role="dialog" aria-label="Notifications panel">
                    <div style="padding:0.75rem 1rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;">
                        <span class="font-bold text-sm">Notifications</span>
                        <button class="btn btn-outline btn-sm" onclick="markAllRead()">Mark all read</button>
                    </div>
                    <div id="notifList" style="padding:0.5rem;"><div class="text-muted text-sm" style="padding:0.5rem;">Loading...</div></div>
                </div>
            </li>
        </ul>
    </nav>

    <!-- Toast container -->
    <div class="toast-container" id="toastContainer" aria-live="polite"></div>

    <main class="container">
        {% block content %}{% endblock %}
    </main>

    <script>
        function toggleNav() {
            var links = document.getElementById('navLinks');
            var btn = document.querySelector('.hamburger');
            links.classList.toggle('show');
            btn.setAttribute('aria-expanded', links.classList.contains('show'));
        }

        // ---- Toast System ----
        function showToast(message, type) {
            type = type || 'info';
            var container = document.getElementById('toastContainer');
            var toast = document.createElement('div');
            toast.className = 'toast toast-' + type;
            toast.textContent = message;
            toast.onclick = function() { toast.remove(); };
            container.appendChild(toast);
            setTimeout(function() {
                if (toast.parentNode) toast.remove();
            }, 5000);
        }

        // ---- Notifications ----
        var notifOpen = false;
        function toggleNotifications(e) {
            e.preventDefault();
            e.stopPropagation();
            notifOpen = !notifOpen;
            var panel = document.getElementById('notifPanel');
            var toggle = document.getElementById('notifToggle');
            panel.style.display = notifOpen ? 'block' : 'none';
            toggle.setAttribute('aria-expanded', notifOpen);
            if (notifOpen) loadNotifications();
        }

        function loadNotifications() {
            fetch('/api/notifications?limit=20')
                .then(function(r) { return r.json(); })
                .then(function(notifs) {
                    var list = document.getElementById('notifList');
                    if (!notifs || notifs.length === 0) {
                        list.innerHTML = '<div class="text-muted text-sm" style="padding:0.75rem;">No notifications</div>';
                        return;
                    }
                    list.innerHTML = notifs.map(function(n) {
                        var sevColor = n.severity === 'critical' ? 'var(--danger)' :
                                       n.severity === 'warning' ? '#fbbf24' : 'var(--accent)';
                        var readStyle = n.read ? 'opacity:0.5; background:var(--bg-dark);' : 'background:var(--bg-card);';
                        return '<div style="padding:0.75rem;border-bottom:1px solid var(--border);' + readStyle + '">' +
                            '<div class="flex items-center gap-2">' +
                            '<span style="width:6px;height:6px;border-radius:50%;background:' + sevColor + ';flex-shrink:0;" aria-hidden="true"></span>' +
                            '<span class="font-bold text-sm" style="flex:1;">' + (n.title || '') + '</span>' +
                            (n.read ? '<span style="font-size:0.65rem;color:var(--text-muted);border:1px solid var(--border);border-radius:4px;padding:1px 4px;">READ</span>' : '') +
                            '</div>' +
                            '<div class="text-xs text-muted" style="margin-top:2px;padding-left:14px;">' + (n.message || '') + '</div>' +
                            '<div class="text-xs text-muted" style="padding-left:14px;">' + (n.created_at || '') + '</div>' +
                        '</div>';
                    }).join('');
                })
                .catch(function() {
                    showToast('Failed to load notifications', 'error');
                });
        }

        function markAllRead() {
            fetch('/api/notifications/read-all', {method:'POST'}).then(function() {
                document.getElementById('notifBadge').style.display = 'none';
                loadNotifications();
                showToast('All notifications marked as read', 'success');
            });
        }

        function pollNotifCount() {
            fetch('/api/notifications/unread')
                .then(function(r) { return r.json(); })
                .then(function(d) {
                    var badge = document.getElementById('notifBadge');
                    if (d.count > 0) {
                        badge.textContent = d.count > 99 ? '99+' : d.count;
                        badge.style.display = 'inline-flex';
                    } else {
                        badge.style.display = 'none';
                    }
                })
                .catch(function() {});
        }

        // Close notification panel when clicking outside
        document.addEventListener('click', function(e) {
            var panel = document.getElementById('notifPanel');
            var toggle = document.getElementById('notifToggle');
            if (notifOpen && panel && !panel.contains(e.target) && !toggle.contains(e.target)) {
                notifOpen = false;
                panel.style.display = 'none';
                toggle.setAttribute('aria-expanded', 'false');
            }
        });

        // Poll for unread notifications every 60s
        pollNotifCount();
        setInterval(pollNotifCount, 60000);

        // ---- SSE helper with cleanup tracking ----
        var _activeEventSources = [];

        function startSSE(url, logEl, onResult) {
            var es = new EventSource(url);
            _activeEventSources.push(es);

            es.onmessage = function(e) {
                if (e.data === '[DONE]') {
                    _cleanupES(es);
                    if (logEl) logEl.innerHTML += '<div class="log-done">Done</div>';
                    return;
                }
                if (e.data === '[CANCELLED]') {
                    _cleanupES(es);
                    if (logEl) logEl.innerHTML += '<div class="log-warn">Cancelled</div>';
                    return;
                }
                if (e.data.startsWith('[RESULTS_JSON]')) {
                    var json = JSON.parse(e.data.substring(14));
                    if (onResult) onResult(json);
                    return;
                }
                if (logEl) {
                    logEl.innerHTML += '<div class="log-line">' + e.data + '</div>';
                    logEl.scrollTop = logEl.scrollHeight;
                }
            };
            es.onerror = function() {
                _cleanupES(es);
                if (logEl) logEl.innerHTML += '<div class="log-error">Connection lost</div>';
            };
            return es;
        }

        function _cleanupES(es) {
            es.close();
            var idx = _activeEventSources.indexOf(es);
            if (idx > -1) _activeEventSources.splice(idx, 1);
        }

        // Clean up all SSE connections on page unload
        window.addEventListener('beforeunload', function() {
            _activeEventSources.forEach(function(es) {
                try { es.close(); } catch(e) {}
            });
            _activeEventSources = [];
        });

        // ---- Debounce utility ----
        function debounce(fn, delay) {
            var timer;
            return function() {
                var args = arguments;
                var context = this;
                clearTimeout(timer);
                timer = setTimeout(function() { fn.apply(context, args); }, delay);
            };
        }
    </script>
    {% block scripts %}{% endblock %}
    <script>
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/static/sw.js').catch(function() {});
    }
    </script>
</body>
</html>
