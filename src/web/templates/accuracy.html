{% extends "base.html" %}
{% block content %}
<h1 class="page-title">Accuracy</h1>

<div class="card">
  <h2>Backtest Settings</h2>
  <form method="get" action="/accuracy">
    <input type="hidden" name="run" value="1" />
    <div class="form-group">
      <label for="home">Home Team (optional)</label>
      <select name="home_team_id" id="home">
        <option value="">Any</option>
        {% for t in teams %}
        <option value="{{ t.id }}" {% if home_team_id == t.id %}selected{% endif %}>
          {{ t.abbr }} - {{ t.name }}
        </option>
        {% endfor %}
      </select>
    </div>
    
    <div class="form-group">
      <label for="away">Away Team (optional)</label>
      <select name="away_team_id" id="away">
        <option value="">Any</option>
        {% for t in teams %}
        <option value="{{ t.id }}" {% if away_team_id == t.id %}selected{% endif %}>
          {{ t.abbr }} - {{ t.name }}
        </option>
        {% endfor %}
      </select>
    </div>
    
    <div class="form-group">
      <label for="injuries">Injury Adjustments</label>
      <select name="use_injuries" id="injuries">
        <option value="true" {% if use_injuries %}selected{% endif %}>On</option>
        <option value="false" {% if not use_injuries %}selected{% endif %}>Off</option>
      </select>
    </div>
    
    <button type="submit">Run Backtest</button>
  </form>
</div>

{% if progress %}
<div class="card">
  <h2>Progress</h2>
  <div class="log">
    {% for line in progress %}
    <div>{{ line }}</div>
    {% endfor %}
  </div>
</div>
{% endif %}

{% if error %}
<div class="error-box">{{ error }}</div>
{% endif %}

{% if results and results.total_games > 0 %}
<!-- Overall Accuracy -->
<div class="card">
  <h2>Overall Accuracy</h2>
  <div class="stats-grid">
    <div class="stat-item">
      <div class="stat-value">{{ results.total_games }}</div>
      <div class="stat-label">Games Analyzed</div>
    </div>
    <div class="stat-item">
      <div class="stat-value {% if results.overall_spread_accuracy >= 55 %}text-success{% elif results.overall_spread_accuracy < 50 %}text-danger{% else %}text-warning{% endif %}">
        {{ "%.1f"|format(results.overall_spread_accuracy) }}%
      </div>
      <div class="stat-label">Winner Correct</div>
    </div>
    <div class="stat-item">
      <div class="stat-value {% if results.overall_total_accuracy >= 55 %}text-success{% elif results.overall_total_accuracy < 50 %}text-danger{% else %}text-warning{% endif %}">
        {{ "%.1f"|format(results.overall_total_accuracy) }}%
      </div>
      <div class="stat-label">Total Within 10</div>
    </div>
    <div class="stat-item">
      <div class="stat-value">{{ "%.1f"|format(avg_spread_err) }}</div>
      <div class="stat-label">Avg Spread Error</div>
    </div>
    <div class="stat-item">
      <div class="stat-value">{{ "%.1f"|format(avg_total_err) }}</div>
      <div class="stat-label">Avg Total Error</div>
    </div>
  </div>
</div>

<!-- Team Accuracy Table -->
<div class="card">
  <h2>Accuracy by Team</h2>
  <div class="scroll-x">
    <table>
      <thead>
        <tr>
          <th>Team</th>
          <th>Record</th>
          <th>Games</th>
          <th>Spread %</th>
          <th>Avg Spread Err</th>
          <th>Total %</th>
          <th>Avg Total Err</th>
        </tr>
      </thead>
      <tbody>
        {% for team in results.team_accuracy.values()|list|sort(attribute='spread_accuracy', reverse=True) if team.games_analyzed > 0 %}
        <tr>
          <td>{{ team.team_abbr }}</td>
          <td>{{ team.wins }}-{{ team.losses }}</td>
          <td>{{ team.games_analyzed }}</td>
          <td class="{% if team.spread_accuracy >= 60 %}text-success{% elif team.spread_accuracy < 45 %}text-danger{% endif %}">
            {{ "%.1f"|format(team.spread_accuracy) }}%
          </td>
          <td>{{ "%.1f"|format(team.avg_spread_error) }}</td>
          <td class="{% if team.total_accuracy >= 60 %}text-success{% elif team.total_accuracy < 45 %}text-danger{% endif %}">
            {{ "%.1f"|format(team.total_accuracy) }}%
          </td>
          <td>{{ "%.1f"|format(team.avg_total_error) }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Recent Predictions vs Actual -->
<div class="card">
  <h2>Recent Predictions vs Actual</h2>
  <div class="scroll-x">
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Matchup</th>
          <th>Final</th>
          <th>Pred</th>
          <th>Actual</th>
          <th>OK?</th>
          <th>Pred Score</th>
          <th>Score Diff</th>
          <th>Pred Tot</th>
          <th>Act Tot</th>
          <th>Tot Diff</th>
          <th>Injuries</th>
        </tr>
      </thead>
      <tbody>
        {% for p in predictions %}
        <tr>
          <td>{{ p.game_date }}</td>
          <td>{{ p.matchup }}</td>
          <td>{{ p.final_score }}</td>
          <td>{{ p.pred_winner }}</td>
          <td>{{ p.actual_winner }}</td>
          <td class="{% if p.winner_correct %}text-success{% else %}text-danger{% endif %}">
            {{ 'Y' if p.winner_correct else 'N' }}
          </td>
          <td>{{ p.pred_score }}</td>
          <td>{{ p.score_diff }}</td>
          <td>{{ p.pred_total }}</td>
          <td>{{ p.actual_total }}</td>
          <td class="{% if p.total_diff|abs <= 10 %}text-success{% elif p.total_diff|abs <= 20 %}text-warning{% else %}text-danger{% endif %}">
            {{ "%+.0f"|format(p.total_diff) }}
          </td>
          <td class="{% if p.has_injuries %}text-danger{% endif %}">{{ p.injuries }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% elif not error and not progress %}
<div class="card">
  <div class="empty-state">
    <p>No results yet</p>
    <p class="text-muted">Run a backtest to see accuracy metrics</p>
  </div>
</div>
{% endif %}

<!-- Model Optimisation -->
<div class="card">
  <h2>Model Optimisation</h2>
  <p class="text-muted" style="margin-bottom: 12px;">
    Improve prediction accuracy by optimising model weights, building spread calibration,
    or analysing which features help the most.
  </p>
  <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px;">
    <button id="btn-optimize" onclick="startOptimize()">Optimize Weights</button>
    <button id="btn-calibrate" onclick="startCalibrate()">Build Calibration</button>
    <button id="btn-features" onclick="startFeatureImportance()">Feature Importance</button>
    <button id="btn-clear-weights" onclick="clearWeights()" style="background:#6b7280;">Reset Weights</button>
  </div>
  <div id="opt-log" class="log" style="max-height: 200px; overflow-y: auto; display: none;"></div>
  <div id="opt-results" style="display: none; margin-top: 12px;"></div>
</div>

<script>
function _disableOptButtons(disabled) {
  ['btn-optimize','btn-calibrate','btn-features','btn-clear-weights'].forEach(id => {
    document.getElementById(id).disabled = disabled;
  });
}

function _appendLog(msg) {
  const log = document.getElementById('opt-log');
  log.style.display = 'block';
  const div = document.createElement('div');
  div.textContent = msg;
  log.appendChild(div);
  log.scrollTop = log.scrollHeight;
}

function startOptimize() {
  _disableOptButtons(true);
  const log = document.getElementById('opt-log');
  log.innerHTML = '';
  log.style.display = 'block';
  document.getElementById('opt-results').style.display = 'none';
  _appendLog('Starting weight optimisation...');

  const es = new EventSource('/api/optimize');
  es.onmessage = function(e) {
    const msg = e.data;
    if (msg.startsWith('[DONE]')) {
      _appendLog(msg);
      es.close();
      _disableOptButtons(false);
      loadWeights();
    } else if (msg.startsWith('[ERROR]')) {
      _appendLog('ERROR: ' + msg);
      es.close();
      _disableOptButtons(false);
    } else {
      _appendLog(msg);
    }
  };
  es.onerror = function() { es.close(); _disableOptButtons(false); };
}

function startCalibrate() {
  _disableOptButtons(true);
  const log = document.getElementById('opt-log');
  log.innerHTML = '';
  log.style.display = 'block';
  document.getElementById('opt-results').style.display = 'none';
  _appendLog('Building residual calibration...');

  const results = [];
  const es = new EventSource('/api/calibrate');
  es.onmessage = function(e) {
    const msg = e.data;
    if (msg.startsWith('[DONE]')) {
      _appendLog(msg);
      es.close();
      _disableOptButtons(false);
      showCalibrationResults(results);
    } else if (msg.startsWith('[RESULT]')) {
      results.push(msg.replace('[RESULT] ', ''));
      _appendLog(msg);
    } else if (msg.startsWith('[ERROR]')) {
      _appendLog('ERROR: ' + msg);
      es.close();
      _disableOptButtons(false);
    } else {
      _appendLog(msg);
    }
  };
  es.onerror = function() { es.close(); _disableOptButtons(false); };
}

function startFeatureImportance() {
  _disableOptButtons(true);
  const log = document.getElementById('opt-log');
  log.innerHTML = '';
  log.style.display = 'block';
  document.getElementById('opt-results').style.display = 'none';
  _appendLog('Running feature importance analysis...');

  const results = [];
  const es = new EventSource('/api/feature-importance');
  es.onmessage = function(e) {
    const msg = e.data;
    if (msg.startsWith('[DONE]')) {
      _appendLog(msg);
      es.close();
      _disableOptButtons(false);
      showFeatureResults(results);
    } else if (msg.startsWith('[RESULT]')) {
      results.push(msg.replace('[RESULT] ', ''));
      _appendLog(msg);
    } else if (msg.startsWith('[ERROR]')) {
      _appendLog('ERROR: ' + msg);
      es.close();
      _disableOptButtons(false);
    } else {
      _appendLog(msg);
    }
  };
  es.onerror = function() { es.close(); _disableOptButtons(false); };
}

function clearWeights() {
  fetch('/api/weights/clear', {method: 'POST'}).then(r => r.json()).then(d => {
    _appendLog('Weights reset to defaults');
  });
}

function loadWeights() {
  fetch('/api/weights').then(r => r.json()).then(weights => {
    const container = document.getElementById('opt-results');
    container.style.display = 'block';
    let html = '<h3>Optimised Weights</h3><div class="scroll-x"><table><thead><tr><th>Weight</th><th>Value</th></tr></thead><tbody>';
    for (const [k, v] of Object.entries(weights)) {
      html += '<tr><td>' + k + '</td><td>' + Number(v).toFixed(4) + '</td></tr>';
    }
    html += '</tbody></table></div>';
    container.innerHTML = html;
  });
}

function showCalibrationResults(results) {
  const container = document.getElementById('opt-results');
  container.style.display = 'block';
  let html = '<h3>Calibration Bins</h3><div class="scroll-x"><table><thead><tr><th>Bin</th><th>Range</th><th>Avg Residual</th><th>Samples</th></tr></thead><tbody>';
  results.forEach(r => {
    const parts = {};
    r.split(',').forEach(p => { const [k,v] = p.split('='); parts[k.trim()] = v; });
    const cls = parseFloat(parts.residual) > 0 ? 'text-warning' : 'text-success';
    html += '<tr><td>' + (parts.bin||'') + '</td><td>' + (parts.range||'') + '</td><td class="' + cls + '">' + (parts.residual||'') + '</td><td>' + (parts.n||'') + '</td></tr>';
  });
  html += '</tbody></table></div>';
  container.innerHTML = html;
}

function showFeatureResults(results) {
  const container = document.getElementById('opt-results');
  container.style.display = 'block';
  let html = '<h3>Feature Importance</h3><div class="scroll-x"><table><thead><tr><th>Feature</th><th>Impact</th><th>Impact %</th><th>Verdict</th></tr></thead><tbody>';
  results.forEach(r => {
    const parts = {};
    r.split(',').forEach(p => { const [k,v] = p.split('='); parts[k.trim()] = v; });
    const verdict = parts.verdict || 'neutral';
    const cls = verdict === 'HELPS' ? 'text-success' : (verdict === 'HURTS' ? 'text-danger' : '');
    html += '<tr><td>' + (parts.feature||'') + '</td><td>' + (parts.impact||'') + '</td><td>' + (parts.impact_pct||'') + '</td><td class="' + cls + '">' + verdict + '</td></tr>';
  });
  html += '</tbody></table></div>';
  container.innerHTML = html;
}
</script>
{% endblock %}
