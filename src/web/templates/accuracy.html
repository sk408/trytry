{% extends "base.html" %}
{% block content %}
<h1 class="page-title">Accuracy</h1>

<div class="card">
  <h2>Backtest Settings</h2>
  <form method="get" action="/accuracy">
    <input type="hidden" name="run" value="1" />
    <div class="form-group">
      <label for="home">Home Team (optional)</label>
      <select name="home_team_id" id="home">
        <option value="">Any</option>
        {% for t in teams %}
        <option value="{{ t.id }}" {% if home_team_id == t.id %}selected{% endif %}>
          {{ t.abbr }} - {{ t.name }}
        </option>
        {% endfor %}
      </select>
    </div>
    
    <div class="form-group">
      <label for="away">Away Team (optional)</label>
      <select name="away_team_id" id="away">
        <option value="">Any</option>
        {% for t in teams %}
        <option value="{{ t.id }}" {% if away_team_id == t.id %}selected{% endif %}>
          {{ t.abbr }} - {{ t.name }}
        </option>
        {% endfor %}
      </select>
    </div>
    
    <div class="form-group">
      <label for="injuries">Injury Adjustments</label>
      <select name="use_injuries" id="injuries">
        <option value="true" {% if use_injuries %}selected{% endif %}>On</option>
        <option value="false" {% if not use_injuries %}selected{% endif %}>Off</option>
      </select>
    </div>
    
    <button type="submit">Run Backtest</button>
  </form>
</div>

{% if progress %}
<div class="card">
  <h2>Progress</h2>
  <div class="log">
    {% for line in progress %}
    <div>{{ line }}</div>
    {% endfor %}
  </div>
</div>
{% endif %}

{% if error %}
<div class="error-box">{{ error }}</div>
{% endif %}

{% if results and results.total_games > 0 %}
<!-- Overall Accuracy -->
<div class="card">
  <h2>Overall Accuracy</h2>
  <div class="stats-grid">
    <div class="stat-item">
      <div class="stat-value">{{ results.total_games }}</div>
      <div class="stat-label">Games Analyzed</div>
    </div>
    <div class="stat-item">
      <div class="stat-value {% if results.overall_spread_accuracy >= 55 %}text-success{% elif results.overall_spread_accuracy < 50 %}text-danger{% else %}text-warning{% endif %}">
        {{ "%.1f"|format(results.overall_spread_accuracy) }}%
      </div>
      <div class="stat-label">Winner Correct</div>
    </div>
    <div class="stat-item">
      <div class="stat-value {% if results.overall_total_accuracy >= 55 %}text-success{% elif results.overall_total_accuracy < 50 %}text-danger{% else %}text-warning{% endif %}">
        {{ "%.1f"|format(results.overall_total_accuracy) }}%
      </div>
      <div class="stat-label">Total Within 10</div>
    </div>
    <div class="stat-item">
      <div class="stat-value">{{ "%.1f"|format(avg_spread_err) }}</div>
      <div class="stat-label">Avg Spread Error</div>
    </div>
    <div class="stat-item">
      <div class="stat-value">{{ "%.1f"|format(avg_total_err) }}</div>
      <div class="stat-label">Avg Total Error</div>
    </div>
  </div>
</div>

<!-- Team Accuracy Table -->
<div class="card">
  <h2>Accuracy by Team</h2>
  <div class="scroll-x">
    <table>
      <thead>
        <tr>
          <th>Team</th>
          <th>Record</th>
          <th>Games</th>
          <th>Spread %</th>
          <th>Avg Spread Err</th>
          <th>Total %</th>
          <th>Avg Total Err</th>
        </tr>
      </thead>
      <tbody>
        {% for team in results.team_accuracy.values()|list|sort(attribute='spread_accuracy', reverse=True) if team.games_analyzed > 0 %}
        <tr>
          <td>{{ team.team_abbr }}</td>
          <td>{{ team.wins }}-{{ team.losses }}</td>
          <td>{{ team.games_analyzed }}</td>
          <td class="{% if team.spread_accuracy >= 60 %}text-success{% elif team.spread_accuracy < 45 %}text-danger{% endif %}">
            {{ "%.1f"|format(team.spread_accuracy) }}%
          </td>
          <td>{{ "%.1f"|format(team.avg_spread_error) }}</td>
          <td class="{% if team.total_accuracy >= 60 %}text-success{% elif team.total_accuracy < 45 %}text-danger{% endif %}">
            {{ "%.1f"|format(team.total_accuracy) }}%
          </td>
          <td>{{ "%.1f"|format(team.avg_total_error) }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Recent Predictions vs Actual -->
<div class="card">
  <h2>Recent Predictions vs Actual</h2>
  <div class="scroll-x">
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Matchup</th>
          <th>Final</th>
          <th>Pred</th>
          <th>Actual</th>
          <th>OK?</th>
          <th>Pred Score</th>
          <th>Score Diff</th>
          <th>Pred Tot</th>
          <th>Act Tot</th>
          <th>Tot Diff</th>
          <th>Injuries</th>
        </tr>
      </thead>
      <tbody>
        {% for p in predictions %}
        <tr>
          <td>{{ p.game_date }}</td>
          <td>{{ p.matchup }}</td>
          <td>{{ p.final_score }}</td>
          <td>{{ p.pred_winner }}</td>
          <td>{{ p.actual_winner }}</td>
          <td class="{% if p.winner_correct %}text-success{% else %}text-danger{% endif %}">
            {{ 'Y' if p.winner_correct else 'N' }}
          </td>
          <td>{{ p.pred_score }}</td>
          <td>{{ p.score_diff }}</td>
          <td>{{ p.pred_total }}</td>
          <td>{{ p.actual_total }}</td>
          <td class="{% if p.total_diff|abs <= 10 %}text-success{% elif p.total_diff|abs <= 20 %}text-warning{% else %}text-danger{% endif %}">
            {{ "%+.0f"|format(p.total_diff) }}
          </td>
          <td class="{% if p.has_injuries %}text-danger{% endif %}">{{ p.injuries }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% elif not error and not progress %}
<div class="card">
  <div class="empty-state">
    <p>No results yet</p>
    <p class="text-muted">Run a backtest to see accuracy metrics</p>
  </div>
</div>
{% endif %}
{% endblock %}
