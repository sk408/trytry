{% extends "base.html" %}
{% block content %}
<h1 class="page-title">Accuracy</h1>

<div class="card">
  <h2>Backtest Settings</h2>
  <form method="get" action="/accuracy">
    <div class="form-group">
      <label for="home">Home Team (optional)</label>
      <select name="home_team_id" id="home">
        <option value="">Any</option>
        {% for t in teams %}
        <option value="{{ t.id }}" {% if home_team_id == t.id %}selected{% endif %}>
          {{ t.abbr }} - {{ t.name }}
        </option>
        {% endfor %}
      </select>
    </div>
    
    <div class="form-group">
      <label for="away">Away Team (optional)</label>
      <select name="away_team_id" id="away">
        <option value="">Any</option>
        {% for t in teams %}
        <option value="{{ t.id }}" {% if away_team_id == t.id %}selected{% endif %}>
          {{ t.abbr }} - {{ t.name }}
        </option>
        {% endfor %}
      </select>
    </div>
    
    <div class="form-group">
      <label for="injuries">Injury Adjustments</label>
      <select name="use_injuries" id="injuries">
        <option value="true" {% if use_injuries %}selected{% endif %}>On</option>
        <option value="false" {% if not use_injuries %}selected{% endif %}>Off</option>
      </select>
    </div>
    
    <button type="submit">Run Backtest</button>
  </form>
</div>

{% if progress %}
<div class="card">
  <h2>Progress</h2>
  <div class="log">
    {% for line in progress %}
    <div>{{ line }}</div>
    {% endfor %}
  </div>
</div>
{% endif %}

{% if error %}
<div class="error-box">{{ error }}</div>
{% endif %}

{% if results and results.total_games > 0 %}
<div class="card">
  <h2>Results</h2>
  
  <div class="stats-grid">
    <div class="stat-item">
      <div class="stat-value">{{ results.total_games }}</div>
      <div class="stat-label">Games</div>
    </div>
    <div class="stat-item">
      <div class="stat-value">{{ "%.0f"|format(results.overall_spread_accuracy) }}%</div>
      <div class="stat-label">Winner</div>
    </div>
    <div class="stat-item">
      <div class="stat-value">{{ "%.0f"|format(results.overall_total_accuracy) }}%</div>
      <div class="stat-label">Total Â±10</div>
    </div>
  </div>
</div>

<div class="card">
  <h2>By Team (Top 10)</h2>
  <div class="scroll-x">
    <table>
      <thead>
        <tr>
          <th>Team</th>
          <th>Games</th>
          <th>Winner %</th>
          <th>Total %</th>
        </tr>
      </thead>
      <tbody>
        {% for team in results.team_accuracy.values()|list|sort(attribute='games_analyzed', reverse=True)[:10] %}
        <tr>
          <td>{{ team.team_abbr }}</td>
          <td>{{ team.games_analyzed }}</td>
          <td>{{ "%.0f"|format(team.spread_accuracy) }}%</td>
          <td>{{ "%.0f"|format(team.total_accuracy) }}%</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div class="card">
  <h2>Recent Predictions</h2>
  <div class="scroll-x">
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Game</th>
          <th>Pred</th>
          <th>Actual</th>
        </tr>
      </thead>
      <tbody>
        {% for p in results.predictions[:20] %}
        <tr>
          <td>{{ p.game_date }}</td>
          <td>{{ p.away_abbr }}@{{ p.home_abbr }}</td>
          <td>{{ "%.0f"|format(p.predicted_spread) }} / {{ "%.0f"|format(p.predicted_total) }}</td>
          <td>{{ "%.0f"|format(p.actual_spread) }} / {{ "%.0f"|format(p.actual_total) }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% elif not error and not progress %}
<div class="card">
  <div class="empty-state">
    <p>No results yet</p>
    <p class="text-muted">Run a backtest to see accuracy metrics</p>
  </div>
</div>
{% endif %}
{% endblock %}
