{% extends "base.html" %}
{% block content %}
<h1 class="page-title">Accuracy</h1>

<div class="card">
  <h2>Backtest Settings</h2>
  <form method="get" action="/accuracy">
    <input type="hidden" name="run" value="1" />
    <div class="form-group">
      <label for="home">Home Team (optional)</label>
      <select name="home_team_id" id="home">
        <option value="">Any</option>
        {% for t in teams %}
        <option value="{{ t.id }}" {% if home_team_id == t.id %}selected{% endif %}>
          {{ t.abbr }} - {{ t.name }}
        </option>
        {% endfor %}
      </select>
    </div>
    
    <div class="form-group">
      <label for="away">Away Team (optional)</label>
      <select name="away_team_id" id="away">
        <option value="">Any</option>
        {% for t in teams %}
        <option value="{{ t.id }}" {% if away_team_id == t.id %}selected{% endif %}>
          {{ t.abbr }} - {{ t.name }}
        </option>
        {% endfor %}
      </select>
    </div>
    
    <div class="form-group">
      <label for="injuries">Injury Adjustments</label>
      <select name="use_injuries" id="injuries">
        <option value="true" {% if use_injuries %}selected{% endif %}>On</option>
        <option value="false" {% if not use_injuries %}selected{% endif %}>Off</option>
      </select>
    </div>

    <div class="form-group" style="display: flex; align-items: center; gap: 8px;">
      <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; margin: 0;">
        <input type="checkbox" id="use-cache" name="use_cache" value="1" checked
               style="width: 16px; height: 16px;">
        Use cached results
      </label>
      <span id="cache-age" style="color: #94a3b8; font-size: 12px;"></span>
    </div>

    <div class="form-group">
      <label for="workers">Workers</label>
      <input type="number" id="workers" name="max_workers" value="4" min="1" max="16" step="1"
             title="Number of parallel threads. More = faster but more CPU. 4 is a good default."
             style="width: 60px;">
    </div>
    
    <button type="submit">Run Backtest</button>
  </form>
</div>

{% if progress %}
<div class="card">
  <h2>Progress</h2>
  <div class="log">
    {% for line in progress %}
    <div>{{ line }}</div>
    {% endfor %}
  </div>
</div>
{% endif %}

{% if error %}
<div class="error-box">{{ error }}</div>
{% endif %}

{% if results and results.total_games > 0 %}
<!-- Overall Accuracy -->
<div class="card">
  <h2>Overall Accuracy</h2>
  <div class="stats-grid">
    <div class="stat-item">
      <div class="stat-value">{{ results.total_games }}</div>
      <div class="stat-label">Games Analyzed</div>
    </div>
    <div class="stat-item">
      <div class="stat-value {% if results.overall_spread_accuracy >= 55 %}text-success{% elif results.overall_spread_accuracy < 50 %}text-danger{% else %}text-warning{% endif %}">
        {{ "%.1f"|format(results.overall_spread_accuracy) }}%
      </div>
      <div class="stat-label">Winner Correct</div>
    </div>
    <div class="stat-item">
      <div class="stat-value {% if results.overall_total_accuracy >= 55 %}text-success{% elif results.overall_total_accuracy < 50 %}text-danger{% else %}text-warning{% endif %}">
        {{ "%.1f"|format(results.overall_total_accuracy) }}%
      </div>
      <div class="stat-label">Total Within 10</div>
    </div>
    <div class="stat-item">
      <div class="stat-value">{{ "%.1f"|format(avg_spread_err) }}</div>
      <div class="stat-label">Avg Spread Error</div>
    </div>
    <div class="stat-item">
      <div class="stat-value">{{ "%.1f"|format(avg_total_err) }}</div>
      <div class="stat-label">Avg Total Error</div>
    </div>
  </div>
</div>

<!-- Team Accuracy Table -->
<div class="card">
  <h2>Accuracy by Team</h2>
  <div class="scroll-x">
    <table>
      <thead>
        <tr>
          <th>Team</th>
          <th>Record</th>
          <th>Games</th>
          <th>Spread %</th>
          <th>Avg Spread Err</th>
          <th>Total %</th>
          <th>Avg Total Err</th>
        </tr>
      </thead>
      <tbody>
        {% for team in results.team_accuracy.values()|list|sort(attribute='spread_accuracy', reverse=True) if team.games_analyzed > 0 %}
        <tr>
          <td>{{ team.team_abbr }}</td>
          <td>{{ team.wins }}-{{ team.losses }}</td>
          <td>{{ team.games_analyzed }}</td>
          <td class="{% if team.spread_accuracy >= 60 %}text-success{% elif team.spread_accuracy < 45 %}text-danger{% endif %}">
            {{ "%.1f"|format(team.spread_accuracy) }}%
          </td>
          <td>{{ "%.1f"|format(team.avg_spread_error) }}</td>
          <td class="{% if team.total_accuracy >= 60 %}text-success{% elif team.total_accuracy < 45 %}text-danger{% endif %}">
            {{ "%.1f"|format(team.total_accuracy) }}%
          </td>
          <td>{{ "%.1f"|format(team.avg_total_error) }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Recent Predictions vs Actual -->
<div class="card">
  <h2>Recent Predictions vs Actual</h2>
  <div class="scroll-x">
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Matchup</th>
          <th>Final</th>
          <th>Pred</th>
          <th>Actual</th>
          <th>OK?</th>
          <th>Pred Score</th>
          <th>Score Diff</th>
          <th>Pred Tot</th>
          <th>Act Tot</th>
          <th>Tot Diff</th>
          <th>Injuries</th>
        </tr>
      </thead>
      <tbody>
        {% for p in predictions %}
        <tr>
          <td>{{ p.game_date }}</td>
          <td>{{ p.matchup }}</td>
          <td>{{ p.final_score }}</td>
          <td>{{ p.pred_winner }}</td>
          <td>{{ p.actual_winner }}</td>
          <td class="{% if p.winner_correct %}text-success{% else %}text-danger{% endif %}">
            {{ 'Y' if p.winner_correct else 'N' }}
          </td>
          <td>{{ p.pred_score }}</td>
          <td>{{ p.score_diff }}</td>
          <td>{{ p.pred_total }}</td>
          <td>{{ p.actual_total }}</td>
          <td class="{% if p.total_diff|abs <= 10 %}text-success{% elif p.total_diff|abs <= 20 %}text-warning{% else %}text-danger{% endif %}">
            {{ "%+.0f"|format(p.total_diff) }}
          </td>
          <td class="{% if p.has_injuries %}text-danger{% endif %}">{{ p.injuries }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% elif not error and not progress %}
<div class="card">
  <div class="empty-state">
    <p>No results yet</p>
    <p class="text-muted">Run a backtest to see accuracy metrics</p>
  </div>
</div>
{% endif %}

<!-- Model Optimisation -->
<div class="card">
  <h2>Model Optimisation</h2>
  <p class="text-muted" style="margin-bottom: 12px;">
    Improve prediction accuracy by optimising model weights, building spread calibration,
    or analysing which features help the most.
  </p>
  <div style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-bottom: 12px;">
    <button id="btn-optimize" onclick="startOptimize()">Optimize Weights</button>
    <label for="opt-trials" style="margin-left: 2px; font-size: 13px; color: #94a3b8;">Trials:</label>
    <input type="number" id="opt-trials" value="200" min="50" max="2000" step="50"
           title="Number of weight combinations to evaluate. More = better but slower. 200 default, 500+ for thorough."
           style="width: 72px; padding: 6px 8px; border: 1px solid #334155; border-radius: 6px;
                  background: #1e293b; color: #e2e8f0; font-size: 13px;">
    <button id="btn-calibrate" onclick="startCalibrate()">Build Calibration</button>
    <button id="btn-features" onclick="startFeatureImportance()">Feature Importance</button>
    <button id="btn-ml-features" onclick="startMLFeatureImportance()">ML Feature Importance</button>
    <button id="btn-team-refine" onclick="startTeamRefinement()">Per-Team Refinement</button>
    <button id="btn-fft" onclick="startFFTAnalysis()">Error Patterns (FFT)</button>
    <button id="btn-clear-weights" onclick="clearWeights()" style="background:#6b7280;">Reset Weights</button>
  </div>
  <div id="opt-log" class="log" style="max-height: 200px; overflow-y: auto; display: none;"></div>
  <div id="opt-results" style="display: none; margin-top: 12px;"></div>
</div>

<script>
function _disableOptButtons(disabled) {
  ['btn-optimize','btn-calibrate','btn-features','btn-ml-features','btn-team-refine','btn-fft','btn-clear-weights'].forEach(id => {
    document.getElementById(id).disabled = disabled;
  });
}

function _appendLog(msg) {
  const log = document.getElementById('opt-log');
  log.style.display = 'block';
  const div = document.createElement('div');
  div.textContent = msg;
  log.appendChild(div);
  log.scrollTop = log.scrollHeight;
}

function startOptimize() {
  _disableOptButtons(true);
  const log = document.getElementById('opt-log');
  log.innerHTML = '';
  log.style.display = 'block';
  document.getElementById('opt-results').style.display = 'none';
  _appendLog('Starting weight optimisation...');

  const trials = parseInt(document.getElementById('opt-trials').value) || 200;
  const es = new EventSource('/api/optimize?trials=' + trials);
  es.onmessage = function(e) {
    const msg = e.data;
    if (msg.startsWith('[DONE]')) {
      _appendLog(msg);
      es.close();
      _disableOptButtons(false);
      loadWeights();
    } else if (msg.startsWith('[ERROR]')) {
      _appendLog('ERROR: ' + msg);
      es.close();
      _disableOptButtons(false);
    } else {
      _appendLog(msg);
    }
  };
  es.onerror = function() { es.close(); _disableOptButtons(false); };
}

function startCalibrate() {
  _disableOptButtons(true);
  const log = document.getElementById('opt-log');
  log.innerHTML = '';
  log.style.display = 'block';
  document.getElementById('opt-results').style.display = 'none';
  _appendLog('Building residual calibration...');

  const results = [];
  const es = new EventSource('/api/calibrate');
  es.onmessage = function(e) {
    const msg = e.data;
    if (msg.startsWith('[DONE]')) {
      _appendLog(msg);
      es.close();
      _disableOptButtons(false);
      showCalibrationResults(results);
    } else if (msg.startsWith('[RESULT]')) {
      results.push(msg.replace('[RESULT] ', ''));
      _appendLog(msg);
    } else if (msg.startsWith('[ERROR]')) {
      _appendLog('ERROR: ' + msg);
      es.close();
      _disableOptButtons(false);
    } else {
      _appendLog(msg);
    }
  };
  es.onerror = function() { es.close(); _disableOptButtons(false); };
}

function startFeatureImportance() {
  _disableOptButtons(true);
  const log = document.getElementById('opt-log');
  log.innerHTML = '';
  log.style.display = 'block';
  document.getElementById('opt-results').style.display = 'none';
  _appendLog('Running feature importance analysis...');

  const results = [];
  const es = new EventSource('/api/feature-importance');
  es.onmessage = function(e) {
    const msg = e.data;
    if (msg.startsWith('[DONE]')) {
      _appendLog(msg);
      es.close();
      _disableOptButtons(false);
      showFeatureResults(results);
    } else if (msg.startsWith('[RESULT]')) {
      results.push(msg.replace('[RESULT] ', ''));
      _appendLog(msg);
    } else if (msg.startsWith('[ERROR]')) {
      _appendLog('ERROR: ' + msg);
      es.close();
      _disableOptButtons(false);
    } else {
      _appendLog(msg);
    }
  };
  es.onerror = function() { es.close(); _disableOptButtons(false); };
}

function clearWeights() {
  fetch('/api/weights/clear', {method: 'POST'}).then(r => r.json()).then(d => {
    _appendLog('Weights reset to defaults');
  });
}

function loadWeights() {
  fetch('/api/weights').then(r => r.json()).then(weights => {
    const container = document.getElementById('opt-results');
    container.style.display = 'block';
    let html = '<h3>Optimised Weights</h3><div class="scroll-x"><table><thead><tr><th>Weight</th><th>Value</th></tr></thead><tbody>';
    for (const [k, v] of Object.entries(weights)) {
      html += '<tr><td>' + k + '</td><td>' + Number(v).toFixed(4) + '</td></tr>';
    }
    html += '</tbody></table></div>';
    container.innerHTML = html;
  });
}

function showCalibrationResults(results) {
  const container = document.getElementById('opt-results');
  container.style.display = 'block';
  let html = '<h3>Calibration Bins</h3><div class="scroll-x"><table><thead><tr><th>Bin</th><th>Range</th><th>Avg Residual</th><th>Samples</th></tr></thead><tbody>';
  results.forEach(r => {
    const parts = {};
    r.split(',').forEach(p => { const [k,v] = p.split('='); parts[k.trim()] = v; });
    const cls = parseFloat(parts.residual) > 0 ? 'text-warning' : 'text-success';
    html += '<tr><td>' + (parts.bin||'') + '</td><td>' + (parts.range||'') + '</td><td class="' + cls + '">' + (parts.residual||'') + '</td><td>' + (parts.n||'') + '</td></tr>';
  });
  html += '</tbody></table></div>';
  container.innerHTML = html;
}

function showFeatureResults(results) {
  const container = document.getElementById('opt-results');
  container.style.display = 'block';
  let html = '<h3>Feature Importance</h3><div class="scroll-x"><table><thead><tr><th>Feature</th><th>Impact</th><th>Impact %</th><th>Verdict</th></tr></thead><tbody>';
  results.forEach(r => {
    const parts = {};
    r.split(',').forEach(p => { const [k,v] = p.split('='); parts[k.trim()] = v; });
    const verdict = parts.verdict || 'neutral';
    const cls = verdict === 'HELPS' ? 'text-success' : (verdict === 'HURTS' ? 'text-danger' : '');
    html += '<tr><td>' + (parts.feature||'') + '</td><td>' + (parts.impact||'') + '</td><td>' + (parts.impact_pct||'') + '</td><td class="' + cls + '">' + verdict + '</td></tr>';
  });
  html += '</tbody></table></div>';
  container.innerHTML = html;
}

function startMLFeatureImportance() {
  _disableOptButtons(true);
  const log = document.getElementById('opt-log');
  log.innerHTML = '';
  log.style.display = 'block';
  document.getElementById('opt-results').style.display = 'none';
  _appendLog('Starting ML feature importance (XGBoost + SHAP)...');

  const results = [];
  const es = new EventSource('/api/ml-feature-importance');
  es.onmessage = function(e) {
    const msg = e.data;
    if (msg.startsWith('[DONE]')) {
      _appendLog(msg);
      es.close();
      _disableOptButtons(false);
      showMLFeatureResults(results);
    } else if (msg.startsWith('[RESULT]')) {
      results.push(msg.replace('[RESULT] ', ''));
      _appendLog(msg);
    } else if (msg.startsWith('[ERROR]')) {
      _appendLog('ERROR: ' + msg);
      es.close();
      _disableOptButtons(false);
    } else {
      _appendLog(msg);
    }
  };
  es.onerror = function() { es.close(); _disableOptButtons(false); };
}

function showMLFeatureResults(results) {
  const container = document.getElementById('opt-results');
  container.style.display = 'block';
  let html = '<h3>ML Feature Importance (SHAP)</h3><div class="scroll-x"><table><thead><tr><th>Feature</th><th>SHAP Importance</th><th>Direction</th></tr></thead><tbody>';
  results.forEach(r => {
    const parts = {};
    r.split(',').forEach(p => { const [k,v] = p.split('='); parts[k.trim()] = v; });
    const dir = parts.direction || 'mixed';
    const cls = dir === 'positive' ? 'text-success' : (dir === 'negative' ? 'text-danger' : '');
    html += '<tr><td>' + (parts.feature||'') + '</td><td>' + (parts.shap||'') + '</td><td class="' + cls + '">' + dir + '</td></tr>';
  });
  html += '</tbody></table></div>';
  container.innerHTML = html;
}

function startFFTAnalysis() {
  _disableOptButtons(true);
  const log = document.getElementById('opt-log');
  log.innerHTML = '';
  log.style.display = 'block';
  document.getElementById('opt-results').style.display = 'none';
  _appendLog('Starting FFT error pattern analysis...');

  const results = [];
  const es = new EventSource('/api/fft-analysis');
  es.onmessage = function(e) {
    const msg = e.data;
    if (msg.startsWith('[DONE]')) {
      _appendLog(msg);
      es.close();
      _disableOptButtons(false);
      showFFTResults(results);
    } else if (msg.startsWith('[RESULT]')) {
      results.push(msg.replace('[RESULT] ', ''));
      _appendLog(msg);
    } else if (msg.startsWith('[ERROR]')) {
      _appendLog('ERROR: ' + msg);
      es.close();
      _disableOptButtons(false);
    } else {
      _appendLog(msg);
    }
  };
  es.onerror = function() { es.close(); _disableOptButtons(false); };
}

function startTeamRefinement() {
  _disableOptButtons(true);
  const log = document.getElementById('opt-log');
  log.innerHTML = '';
  log.style.display = 'block';
  document.getElementById('opt-results').style.display = 'none';
  _appendLog('Starting per-team weight refinement...');

  const trials = parseInt(document.getElementById('opt-trials').value) || 100;
  const results = [];
  const es = new EventSource('/api/team-refinement?trials=' + trials);
  es.onmessage = function(e) {
    const msg = e.data;
    if (msg.startsWith('[DONE]')) {
      _appendLog(msg);
      es.close();
      _disableOptButtons(false);
      showTeamRefinementResults(results);
    } else if (msg.startsWith('[RESULT]')) {
      results.push(msg.replace('[RESULT] ', ''));
      _appendLog(msg);
    } else if (msg.startsWith('[ERROR]')) {
      _appendLog('ERROR: ' + msg);
      es.close();
      _disableOptButtons(false);
    } else {
      _appendLog(msg);
    }
  };
  es.onerror = function() { es.close(); _disableOptButtons(false); };
}

function showTeamRefinementResults(results) {
  const container = document.getElementById('opt-results');
  container.style.display = 'block';
  let html = '<h3>Per-Team Weight Refinement</h3>';
  html += '<div class="scroll-x"><table><thead><tr><th>Team</th><th>Decision</th><th>Global (holdout)</th><th>Per-Team (holdout)</th><th>Reason</th></tr></thead><tbody>';
  results.forEach(r => {
    const parts = {};
    r.split(',').forEach(p => { const [k,...v] = p.split('='); parts[k.trim()] = v.join('='); });
    const decision = parts.used_team === 'true' ? 'Per-Team' : 'Global';
    const cls = parts.used_team === 'true' ? 'text-success' : '';
    html += '<tr><td>' + (parts.abbr||'') + '</td><td class="' + cls + '">' + decision + '</td><td>' + (parts.global_holdout||'') + '</td><td>' + (parts.team_holdout||'') + '</td><td style="font-size:12px;">' + (parts.reason||'') + '</td></tr>';
  });
  html += '</tbody></table></div>';
  container.innerHTML = html;
}

function showFFTResults(results) {
  const container = document.getElementById('opt-results');
  container.style.display = 'block';
  let html = '<h3>Error Pattern Analysis (FFT)</h3>';
  if (results.length === 0 || (results.length === 1 && results[0].includes('No significant'))) {
    html += '<p class="text-success" style="font-weight:600;">No significant periodic error patterns detected — prediction errors are random (good!)</p>';
  } else {
    html += '<div class="scroll-x"><table><thead><tr><th>Pattern</th><th>Period (games)</th><th>Period (days)</th><th>Strength</th></tr></thead><tbody>';
    results.forEach(r => {
      const parts = {};
      r.split(',').forEach(p => { const [k,v] = p.split('='); parts[k.trim()] = v; });
      const mag = parseFloat(parts.magnitude || 0);
      const cls = mag > 0.7 ? 'text-danger' : (mag > 0.4 ? 'text-warning' : '');
      html += '<tr><td>' + (parts.description||'') + '</td><td>' + (parts.period_games||'') + '</td><td>' + (parts.period_days||'') + '</td><td class="' + cls + '">' + (parts.magnitude||'') + '</td></tr>';
    });
    html += '</tbody></table></div>';
  }
  container.innerHTML = html;
}

// ── Backtest cache age indicator ──
function updateCacheAge() {
  const home = document.getElementById('home').value || '';
  const away = document.getElementById('away').value || '';
  const inj = document.getElementById('injuries').value;
  const span = document.getElementById('cache-age');
  fetch('/api/backtest-cache-age?home_team_id=' + encodeURIComponent(home) +
        '&away_team_id=' + encodeURIComponent(away) +
        '&use_injuries=' + encodeURIComponent(inj))
    .then(r => r.json())
    .then(data => {
      const age = data.age_minutes;
      if (age == null) {
        span.textContent = '(no cache)';
      } else if (age < 1) {
        span.textContent = '(cached <1 min ago)';
      } else if (age < 60) {
        span.textContent = '(cached ' + Math.round(age) + ' min ago)';
      } else {
        span.textContent = '(cached ' + (age / 60).toFixed(1) + ' hr ago)';
      }
    })
    .catch(() => { span.textContent = ''; });
}
// Update on page load and whenever filters change
document.addEventListener('DOMContentLoaded', function() {
  updateCacheAge();
  document.getElementById('home').addEventListener('change', updateCacheAge);
  document.getElementById('away').addEventListener('change', updateCacheAge);
  document.getElementById('injuries').addEventListener('change', updateCacheAge);
});
</script>
{% endblock %}
