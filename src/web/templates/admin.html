{% extends "base.html" %}
{% set active = "admin" %}
{% block title %}Admin â€” NBA Predictor{% endblock %}

{% block content %}
<h1 class="section-header">Admin</h1>

<div class="card mb-4">
    <div class="card-header">Database</div>
    <div class="grid-2">
        <div>
            <p class="text-sm text-secondary">Path</p>
            <p class="font-mono text-sm">{{ db_path }}</p>
        </div>
        <div>
            <p class="text-sm text-secondary">Size</p>
            <p class="font-bold">{{ '%.2f'|format(db_size / 1024 / 1024) }} MB</p>
        </div>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">Pipeline Settings</div>
    <div class="grid-2" style="gap: 1rem;">
        <div>
            <label class="text-sm text-secondary" for="syncFreshness">Sync Freshness (hours)</label>
            <input type="number" id="syncFreshness" min="1" max="168" value="{{ sync_freshness_hours }}"
                   class="form-input" style="width: 80px; margin-left: 8px;">
            <p class="text-sm text-secondary" style="margin-top: 4px;">Hours before game logs re-fetch</p>
        </div>
        <div>
            <label class="text-sm text-secondary" for="optLogInterval">Optimizer Log Interval</label>
            <input type="number" id="optLogInterval" min="1" max="3000" value="{{ optimizer_log_interval }}"
                   class="form-input" style="width: 80px; margin-left: 8px;">
            <p class="text-sm text-secondary" style="margin-top: 4px;">Log every N trials (new bests always logged)</p>
        </div>
    </div>
    <button class="btn btn-primary mt-3" onclick="saveSettings()">Save Settings</button>
</div>

<div class="card mb-4">
    <div class="card-header">Weights</div>
    <div class="btn-group">
        <button class="btn btn-outline" onclick="viewWeights()">View Current Weights</button>
        <button class="btn btn-danger" onclick="clearWeights()">Clear All Weights</button>
    </div>
    <pre id="weightsOutput" class="log-output mt-3 hidden" style="white-space: pre-wrap;"></pre>
</div>

<div class="card">
    <div class="card-header">Danger Zone</div>
    <form action="/admin/reset" method="post" 
          onsubmit="return confirm('This will DELETE all data. Are you sure?')">
        <button type="submit" class="btn btn-danger">Delete & Reinitialize Database</button>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
async function viewWeights() {
    const el = document.getElementById('weightsOutput');
    el.classList.remove('hidden');
    try {
        const r = await fetch('/api/weights');
        const data = await r.json();
        el.textContent = JSON.stringify(data, null, 2);
    } catch(e) {
        el.textContent = 'Error loading weights';
    }
}

async function clearWeights() {
    if (!confirm('Clear all global and per-team weights?')) return;
    await fetch('/api/weights/clear', {method: 'POST'});
    alert('Weights cleared');
}

async function saveSettings() {
    const data = {
        sync_freshness_hours: parseInt(document.getElementById('syncFreshness').value),
        optimizer_log_interval: parseInt(document.getElementById('optLogInterval').value),
    };
    try {
        const r = await fetch('/admin/settings', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data),
        });
        if (r.ok) alert('Settings saved');
        else alert('Error saving settings');
    } catch(e) {
        alert('Error: ' + e.message);
    }
}
</script>
{% endblock %}
