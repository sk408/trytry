{% extends "base.html" %}
{% block content %}
<h1 class="page-title">Autotune</h1>

<div class="card">
  <h2>Autotune Settings</h2>
  <p class="text-muted" style="margin-bottom:1rem;">
    Replays historical games using actual player data to find consistent per-team prediction biases. Corrections are then applied to future predictions.
  </p>
  <form method="get" action="/autotune">
    <input type="hidden" name="run" value="1" />

    <div class="form-group">
      <label for="team">Team</label>
      <select name="team_id" id="team">
        <option value="">All Teams</option>
        {% for t in teams %}
        <option value="{{ t.id }}" {% if team_id == t.id %}selected{% endif %}>
          {{ t.abbr }} - {{ t.name }}
        </option>
        {% endfor %}
      </select>
    </div>

    <div class="form-group">
      <label for="strength">
        Correction Strength: <strong id="strength-val">{{ "%.0f"|format(strength * 100) }}%</strong>
      </label>
      <input type="range" name="strength" id="strength"
             min="0" max="1" step="0.05" value="{{ strength }}"
             oninput="document.getElementById('strength-val').textContent = Math.round(this.value*100)+'%'" />
      <small class="text-muted">100% = apply full correction, 50% = half correction</small>
    </div>

    <div class="form-group">
      <label for="min_threshold">Minimum Error Threshold (pts)</label>
      <input type="number" name="min_threshold" id="min_threshold"
             min="0" max="10" step="0.5" value="{{ min_threshold }}" />
      <small class="text-muted">Only apply corrections if average error exceeds this</small>
    </div>

    <button type="submit">Run Autotune</button>
  </form>
</div>

{% if progress %}
<div class="card">
  <h2>Progress</h2>
  <div class="log">
    {% for line in progress %}
    <div>{{ line }}</div>
    {% endfor %}
  </div>
</div>
{% endif %}

{% if error %}
<div class="error-box">{{ error }}</div>
{% endif %}

{% if results %}
<div class="card">
  <h2>Autotune Results</h2>
  <div class="scroll-x">
    <table>
      <thead>
        <tr>
          <th>Team</th>
          <th>Games</th>
          <th>Home Correction</th>
          <th>Away Correction</th>
          <th>Avg Spread Err</th>
          <th>Avg Total Err</th>
        </tr>
      </thead>
      <tbody>
        {% for r in results %}
        <tr>
          <td>{{ r.team_id }}</td>
          <td>{{ r.games_analyzed }}</td>
          <td class="{% if r.home_pts_correction > 0 %}text-success{% elif r.home_pts_correction < 0 %}text-danger{% endif %}">
            {{ "%+.1f"|format(r.home_pts_correction) }}
          </td>
          <td class="{% if r.away_pts_correction > 0 %}text-success{% elif r.away_pts_correction < 0 %}text-danger{% endif %}">
            {{ "%+.1f"|format(r.away_pts_correction) }}
          </td>
          <td>{{ "%.1f"|format(r.avg_spread_error_before) }}</td>
          <td>{{ "%.1f"|format(r.avg_total_error_before) }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endif %}

<!-- Current Tunings (always shown) -->
<div class="card">
  <h2>Current Tunings</h2>
  {% if current_tunings %}
  <div style="margin-bottom:1rem;">
    <form method="post" action="/autotune/clear" style="display:inline;">
      <button type="submit" class="btn-danger" onclick="return confirm('Clear ALL tuning data?')">Clear All</button>
    </form>
  </div>
  <div class="scroll-x">
    <table>
      <thead>
        <tr>
          <th>Team</th>
          <th>Home Correction</th>
          <th>Away Correction</th>
          <th>Games</th>
          <th>Avg Spread Err</th>
          <th>Avg Total Err</th>
          <th>Last Tuned</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for t in current_tunings %}
        <tr>
          <td><strong>{{ t.abbr }}</strong> {{ t.name }}</td>
          <td class="{% if t.home_pts_correction > 0 %}text-success{% elif t.home_pts_correction < 0 %}text-danger{% endif %}">
            {{ "%+.1f"|format(t.home_pts_correction) }}
          </td>
          <td class="{% if t.away_pts_correction > 0 %}text-success{% elif t.away_pts_correction < 0 %}text-danger{% endif %}">
            {{ "%+.1f"|format(t.away_pts_correction) }}
          </td>
          <td>{{ t.games_analyzed }}</td>
          <td>{{ "%.1f"|format(t.avg_spread_error_before) }}</td>
          <td>{{ "%.1f"|format(t.avg_total_error_before) }}</td>
          <td class="text-muted">{{ t.last_tuned_at[:16] if t.last_tuned_at else "-" }}</td>
          <td>
            <form method="post" action="/autotune/clear" style="display:inline;">
              <input type="hidden" name="team_id" value="{{ t.team_id }}" />
              <button type="submit" class="btn-sm btn-danger" onclick="return confirm('Clear tuning for {{ t.abbr }}?')">Clear</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <div class="empty-state">
    <p>No tuning data yet</p>
    <p class="text-muted">Run autotune to generate per-team corrections</p>
  </div>
  {% endif %}
</div>
{% endblock %}
