{% extends "base.html" %}
{% block content %}
<div class="page-header">
  <h1 class="page-title">Autotune Predictions</h1>
</div>

<!-- Team Selector -->
<div class="card">
  <h2>Select Team</h2>
  <form method="get" action="/autotune">
    <div class="form-row">
      <div class="form-group">
        <label for="team">Team</label>
        <select name="team_id" id="team">
          <option value="" {% if not team_id %}selected{% endif %}>All Teams (Global)</option>
          {% for t in teams %}
          <option value="{{ t.id }}" {% if team_id == t.id %}selected{% endif %}>
            {{ t.abbr }} - {{ t.name }}
          </option>
          {% endfor %}
        </select>
      </div>
    </div>
    <button type="submit">Load Weights</button>
  </form>
</div>

<!-- Actions -->
<div class="card">
  <h2>Actions</h2>
  <div class="form-row" style="gap: 0.75rem;">
    <button id="btnTune" onclick="runAutotune('tune')">
      Tune {{ "Team" if team_id else "Global" }} Weights
    </button>
    {% if has_overrides %}
    <button id="btnReset" onclick="runAutotune('reset')" style="background: var(--danger, #ef4444);">
      Reset to Defaults
    </button>
    {% endif %}
  </div>
  <div id="progress" style="display:none; margin-top: 1rem;">
    <div class="stat-label">Progress</div>
    <pre id="log" style="max-height: 300px; overflow-y: auto; padding: 0.75rem; background: var(--card-bg, #1e293b); border-radius: 6px; font-size: 0.85rem; white-space: pre-wrap;"></pre>
  </div>
</div>

<!-- Last Tune Metrics -->
{% if tune_metrics %}
<div class="card">
  <h2>Last Tune Results</h2>
  <p class="text-muted">Tuned at: {{ tune_metrics.tuned_at }}</p>
  <div class="stats-grid">
    <div class="stat-item">
      <div class="stat-value">{{ "%.2f"|format(tune_metrics.spread_before) }}</div>
      <div class="stat-label">Spread Error (Before)</div>
    </div>
    <div class="stat-item">
      <div class="stat-value">{{ "%.2f"|format(tune_metrics.spread_after) }}</div>
      <div class="stat-label">Spread Error (After)</div>
      <div class="stat-sub">
        {% set sdiff = tune_metrics.spread_after - tune_metrics.spread_before %}
        {% if sdiff < 0 %}
          Improved by {{ "%.2f"|format(-sdiff) }}
        {% elif sdiff > 0 %}
          Worsened by {{ "%.2f"|format(sdiff) }}
        {% else %}
          No change
        {% endif %}
      </div>
    </div>
    <div class="stat-item">
      <div class="stat-value">{{ "%.2f"|format(tune_metrics.total_before) }}</div>
      <div class="stat-label">Total Error (Before)</div>
    </div>
    <div class="stat-item">
      <div class="stat-value">{{ "%.2f"|format(tune_metrics.total_after) }}</div>
      <div class="stat-label">Total Error (After)</div>
      <div class="stat-sub">
        {% set tdiff = tune_metrics.total_after - tune_metrics.total_before %}
        {% if tdiff < 0 %}
          Improved by {{ "%.2f"|format(-tdiff) }}
        {% elif tdiff > 0 %}
          Worsened by {{ "%.2f"|format(tdiff) }}
        {% else %}
          No change
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Current Weights Table -->
<div class="card">
  <h2>Prediction Weights</h2>
  <p class="text-muted">
    {% if team_id %}Per-team overrides for this team. Tuned values highlighted.
    {% else %}Global weights. Tuned values highlighted.{% endif %}
  </p>
  <div class="scroll-x">
    <table>
      <thead>
        <tr>
          <th>Weight</th>
          <th>Default</th>
          <th>Effective</th>
          <th>Range</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        {% for w in weights %}
        <tr>
          <td><strong>{{ w.key }}</strong></td>
          <td>{{ "%.4f"|format(w.default) }}</td>
          <td{% if w.is_tuned %} style="color: var(--accent, #38bdf8); font-weight: 600;"{% endif %}>
            {{ "%.4f"|format(w.effective) }}
          </td>
          <td class="text-muted">{{ "%.2f"|format(w.bounds_lo) }} - {{ "%.2f"|format(w.bounds_hi) }}</td>
          <td>
            {% if w.is_tuned %}
              {% set delta = w.effective - w.default %}
              Tuned ({{ "%+.4f"|format(delta) }})
            {% else %}
              Default
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
function runAutotune(action) {
  const teamSelect = document.getElementById('team');
  const teamId = teamSelect.value;
  const progressDiv = document.getElementById('progress');
  const logPre = document.getElementById('log');
  const btnTune = document.getElementById('btnTune');
  const btnReset = document.getElementById('btnReset');

  // Show progress, disable buttons
  progressDiv.style.display = 'block';
  logPre.textContent = '';
  btnTune.disabled = true;
  if (btnReset) btnReset.disabled = true;

  let url = '/api/autotune?action=' + action;
  if (teamId) url += '&team_id=' + teamId;

  const source = new EventSource(url);

  source.onmessage = function(event) {
    const msg = event.data;
    logPre.textContent += msg + '\n';
    logPre.scrollTop = logPre.scrollHeight;

    if (msg.startsWith('[DONE]') || msg.startsWith('[ERROR]')) {
      source.close();
      btnTune.disabled = false;
      if (btnReset) btnReset.disabled = false;

      // Reload page after short delay to show updated weights
      if (msg.startsWith('[DONE]')) {
        logPre.textContent += '\nReloading page...\n';
        setTimeout(function() {
          window.location.reload();
        }, 1500);
      }
    }
  };

  source.onerror = function() {
    source.close();
    logPre.textContent += '\n[Connection closed]\n';
    btnTune.disabled = false;
    if (btnReset) btnReset.disabled = false;
  };
}
</script>
{% endblock %}
