{% extends "base.html" %}
{% block content %}
<h1 class="page-title">Dashboard</h1>

<!-- Stat Cards -->
<div class="stats-grid">
  <div class="stat-item" data-accent="blue">
    <div class="stat-value">{{ stats.teams }}</div>
    <div class="stat-label">Teams</div>
  </div>
  <div class="stat-item" data-accent="green">
    <div class="stat-value">{{ stats.players }}</div>
    <div class="stat-label">Players</div>
  </div>
  <div class="stat-item" data-accent="amber">
    <div class="stat-value">{{ "{:,}".format(stats.game_logs) }}</div>
    <div class="stat-label">Game Logs</div>
  </div>
  <div class="stat-item" data-accent="red">
    <div class="stat-value">{{ stats.injured }}</div>
    <div class="stat-label">Injured</div>
  </div>
</div>

<div class="card">
  <div class="status" id="status">{{ status }}</div>
  
  <div class="actions">
    <button type="button" onclick="runSync('/api/sync/data', 'Syncing data...')" id="btn-sync">
      Sync Data
    </button>
    <button type="button" onclick="runSync('/api/sync/injuries', 'Syncing injuries...')" id="btn-injuries">
      Sync Injuries
    </button>
    <button type="button" onclick="runSync('/api/sync/injury-history', 'Building history...')" id="btn-history">
      Build Injury History
    </button>
    <button type="button" onclick="runSync('/api/sync/team-metrics', 'Syncing team metrics...')" id="btn-team-metrics">
      Sync Team Metrics
    </button>
    <button type="button" onclick="runSync('/api/sync/player-impact', 'Syncing player impact...')" id="btn-player-impact">
      Sync Player Impact
    </button>
    <button type="button" onclick="runSync('/api/sync/images', 'Syncing images...')" id="btn-images" class="secondary">
      Sync Images
    </button>
    <button type="button" onclick="cancelSync()" id="btn-stop" class="danger" style="display:none;">
      Stop Sync
    </button>
  </div>
  
  <div class="log" id="log-container">
    {% if logs %}
      {% for line in logs %}
        <div>{{ line }}</div>
      {% endfor %}
    {% endif %}
  </div>
</div>

<script>
let _currentEventSource = null;

function runSync(endpoint, startMsg) {
  const statusEl = document.getElementById('status');
  const logEl = document.getElementById('log-container');
  const syncButtons = document.querySelectorAll('.actions button:not(#btn-stop)');
  const stopBtn = document.getElementById('btn-stop');
  
  syncButtons.forEach(btn => btn.disabled = true);
  stopBtn.style.display = '';
  stopBtn.disabled = false;
  logEl.innerHTML = '';
  logEl.style.display = 'block';
  statusEl.textContent = startMsg;
  statusEl.className = 'status';
  
  const eventSource = new EventSource(endpoint);
  _currentEventSource = eventSource;
  
  eventSource.onmessage = function(event) {
    const msg = event.data;
    const line = document.createElement('div');
    line.textContent = msg;
    
    if (msg.startsWith('[DONE]')) {
      line.className = 'text-success';
      statusEl.textContent = msg.replace('[DONE] ', '');
      statusEl.className = 'status success';
    } else if (msg.startsWith('[CANCELLED]')) {
      line.className = 'text-warning';
      statusEl.textContent = msg.replace('[CANCELLED] ', '');
      statusEl.className = 'status warning';
    } else if (msg.startsWith('[ERROR]')) {
      line.className = 'text-danger';
      statusEl.textContent = msg.replace('[ERROR] ', '');
      statusEl.className = 'status error';
    }
    
    logEl.appendChild(line);
    logEl.scrollTop = logEl.scrollHeight;
  };
  
  eventSource.onerror = function() {
    eventSource.close();
    _currentEventSource = null;
    syncButtons.forEach(btn => btn.disabled = false);
    stopBtn.style.display = 'none';
  };
}

function cancelSync() {
  const stopBtn = document.getElementById('btn-stop');
  stopBtn.disabled = true;
  stopBtn.textContent = 'Stopping...';
  
  fetch('/api/sync/cancel', { method: 'POST' })
    .then(() => {
      document.getElementById('status').textContent = 'Cancelling after current step...';
    })
    .catch(err => {
      console.error('Cancel failed:', err);
      stopBtn.disabled = false;
      stopBtn.textContent = 'Stop Sync';
    });
}
</script>
{% endblock %}
