{% extends "base.html" %}
{% block content %}
<h1 class="page-title">Dashboard</h1>

<div class="card">
  <div class="status" id="status">{{ status }}</div>
  
  <div class="actions">
    <button type="button" onclick="runSync('/api/sync/data', 'Syncing next 3 days...')" id="btn-sync">
      Sync 3 Days
    </button>
    <button type="button" onclick="runSync('/api/sync/season', 'Syncing full season (this takes a while)...')" id="btn-season">
      Sync Full Season
    </button>
    <button type="button" onclick="runSync('/api/sync/injuries', 'Syncing injuries...')" id="btn-injuries">
      Sync Injuries
    </button>
    <button type="button" onclick="runSync('/api/sync/injury-history', 'Building history...')" id="btn-history">
      Build Injury History
    </button>
  </div>
  
  <p class="text-muted" style="font-size: 0.8rem; margin-top: 8px;">
    <strong>Sync 3 Days:</strong> Fetches teams/rosters for today + next 2 days + last 7 days of stats<br>
    <strong>Sync Full Season:</strong> Fetches entire season's game stats (~120 days, may take 10+ minutes)
  </p>
  
  <div class="log" id="log-container">
    {% if logs %}
      {% for line in logs %}
        <div>{{ line }}</div>
      {% endfor %}
    {% endif %}
  </div>
</div>

<script>
function runSync(endpoint, startMsg) {
  const statusEl = document.getElementById('status');
  const logEl = document.getElementById('log-container');
  const buttons = document.querySelectorAll('.actions button');
  
  buttons.forEach(btn => btn.disabled = true);
  logEl.innerHTML = '';
  logEl.style.display = 'block';
  statusEl.textContent = startMsg;
  statusEl.className = 'status';
  
  const eventSource = new EventSource(endpoint);
  
  eventSource.onmessage = function(event) {
    const msg = event.data;
    const line = document.createElement('div');
    line.textContent = msg;
    
    if (msg.startsWith('[DONE]')) {
      line.className = 'text-success';
      statusEl.textContent = msg.replace('[DONE] ', '');
      statusEl.className = 'status success';
    } else if (msg.startsWith('[ERROR]')) {
      line.className = 'text-danger';
      statusEl.textContent = msg.replace('[ERROR] ', '');
      statusEl.className = 'status error';
    }
    
    logEl.appendChild(line);
    logEl.scrollTop = logEl.scrollHeight;
  };
  
  eventSource.onerror = function() {
    eventSource.close();
    buttons.forEach(btn => btn.disabled = false);
  };
}
</script>
{% endblock %}
