{% extends "base.html" %}
{% set active = "dashboard" %}
{% block title %}Dashboard — NBA Predictor{% endblock %}

{% block content %}
<h1 class="section-header">Dashboard</h1>

<div class="card-grid mb-4">
    <div class="stat-card">
        <div class="stat-value">{{ teams }}</div>
        <div class="stat-label">Teams</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ players }}</div>
        <div class="stat-label">Players</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ game_logs }}</div>
        <div class="stat-label">Game Logs</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ injured }}</div>
        <div class="stat-label">Injured</div>
    </div>
</div>

<div class="card">
    <div class="card-header">Settings</div>
    <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.5rem 0;">
        <div>
            <div style="font-weight: 600; font-size: 1rem;">OLED Dark Mode</div>
            <div style="font-size: 0.8rem; color: var(--text-muted);">Uses pure black backgrounds to save battery on OLED screens</div>
        </div>
        <label style="position: relative; display: inline-block; width: 50px; height: 26px;">
            <input type="checkbox" id="oledToggle" style="opacity: 0; width: 0; height: 0;" onchange="toggleOledMode(this)">
            <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--bg-input); border: 1px solid var(--border); transition: .3s; border-radius: 26px;">
                <span id="oledSlider" style="position: absolute; content: ''; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: var(--text-muted); transition: .3s; border-radius: 50%;"></span>
            </span>
        </label>
    </div>
</div>

<div class="card">
    <div class="card-header">Data Sync</div>
    <div class="btn-group mb-3">
        <button class="btn btn-primary" onclick="runSync('/api/sync/data')">Full Sync</button>
        <button class="btn btn-warning" onclick="runSync('/api/sync/data?force=true')" title="Bypass freshness checks">Force Sync</button>
        <button class="btn btn-outline" onclick="runSync('/api/sync/injuries')">Injuries</button>
        <button class="btn btn-outline" onclick="runSync('/api/sync/injury-history')">Injury History</button>
        <button class="btn btn-outline" onclick="runSync('/api/sync/team-metrics')">Team Metrics</button>
        <button class="btn btn-outline" onclick="runSync('/api/sync/player-impact')">Player Impact</button>
        <button class="btn btn-outline" onclick="runSync('/api/sync/images')">Images</button>
        <button class="btn btn-danger btn-sm" onclick="cancelSync()">Stop</button>
    </div>
    <div class="log-output" id="syncLog"></div>
</div>

<div class="card">
    <div class="card-header">Pipeline</div>
    <div class="btn-group mb-3">
        <button class="btn btn-success" onclick="runPipeline()">Run Full Pipeline</button>
        <button class="btn btn-danger btn-sm" onclick="cancelPipeline()">Stop</button>
    </div>
    <div class="log-output" id="pipelineLog" style="display:none;"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentES = null;
let pipelineES = null;

// Initialize OLED toggle
document.addEventListener('DOMContentLoaded', () => {
    const oledToggle = document.getElementById('oledToggle');
    const oledSlider = document.getElementById('oledSlider');
    if (localStorage.getItem('oledMode') === 'true') {
        oledToggle.checked = true;
        oledSlider.style.transform = 'translateX(24px)';
        oledSlider.style.backgroundColor = 'var(--accent)';
    }
});

function toggleOledMode(el) {
    const slider = document.getElementById('oledSlider');
    if (el.checked) {
        localStorage.setItem('oledMode', 'true');
        document.body.classList.add('oled-mode');
        slider.style.transform = 'translateX(24px)';
        slider.style.backgroundColor = 'var(--accent)';
    } else {
        localStorage.setItem('oledMode', 'false');
        document.body.classList.remove('oled-mode');
        slider.style.transform = 'translateX(0)';
        slider.style.backgroundColor = 'var(--text-muted)';
    }
}

function classifyMsg(msg) {
    const lower = msg.toLowerCase();
    if (lower.includes('error') || lower.startsWith('err')) return 'log-error';
    if (lower.includes('warning') || lower.includes('warn')) return 'log-warn';
    if (lower.includes('success') || lower.includes('complete') || lower.includes('✓') || lower.includes('done')) return 'log-success';
    if (lower.includes('syncing') || lower.includes('fetching') || lower.includes('loading') || lower.includes('processing')) return 'log-progress';
    return 'log-line';
}

function startStyledSSE(url, logEl, onResult) {
    const es = new EventSource(url);
    es.onmessage = function(e) {
        if (e.data === '[DONE]') {
            es.close();
            if (logEl) logEl.innerHTML += '<div class="log-done">✓ Done</div>';
            return;
        }
        if (e.data === '[CANCELLED]') {
            es.close();
            if (logEl) logEl.innerHTML += '<div class="log-warn">⚠ Cancelled</div>';
            return;
        }
        if (e.data.startsWith('[RESULTS_JSON]')) {
            const json = JSON.parse(e.data.substring(14));
            if (onResult) onResult(json);
            return;
        }
        if (logEl) {
            const cls = classifyMsg(e.data);
            logEl.innerHTML += '<div class="' + cls + '">' + e.data + '</div>';
            logEl.scrollTop = logEl.scrollHeight;
        }
    };
    es.onerror = function() {
        es.close();
        if (logEl) logEl.innerHTML += '<div class="log-error">Connection lost</div>';
    };
    return es;
}

var _syncRunning = false;
var _pipelineRunning = false;

function runSync(url) {
    if (_syncRunning) {
        showToast('Sync already in progress', 'warning');
        return;
    }
    _syncRunning = true;
    if (currentES) currentES.close();
    var log = document.getElementById('syncLog');
    log.innerHTML = '';
    currentES = startStyledSSE(url, log, function() {
        _syncRunning = false;
        showToast('Sync complete', 'success');
    });
    // Also handle completion via [DONE]
    var origMsg = currentES.onmessage;
    currentES.onmessage = function(e) {
        origMsg.call(this, e);
        if (e.data === '[DONE]' || e.data === '[CANCELLED]') {
            _syncRunning = false;
            if (e.data === '[DONE]') showToast('Sync complete', 'success');
        }
    };
    var origErr = currentES.onerror;
    currentES.onerror = function() {
        _syncRunning = false;
        origErr.call(this);
        showToast('Sync connection lost', 'error');
    };
}

function runPipeline() {
    if (_pipelineRunning) {
        showToast('Pipeline already running', 'warning');
        return;
    }
    _pipelineRunning = true;
    if (pipelineES) pipelineES.close();
    var log = document.getElementById('pipelineLog');
    log.style.display = 'block';
    log.innerHTML = '';
    pipelineES = startStyledSSE('/api/full-pipeline', log);
    var origMsg = pipelineES.onmessage;
    pipelineES.onmessage = function(e) {
        origMsg.call(this, e);
        if (e.data === '[DONE]' || e.data === '[CANCELLED]') {
            _pipelineRunning = false;
            if (e.data === '[DONE]') showToast('Pipeline complete', 'success');
        }
    };
    var origErr = pipelineES.onerror;
    pipelineES.onerror = function() {
        _pipelineRunning = false;
        origErr.call(this);
        showToast('Pipeline connection lost', 'error');
    };
}

function cancelSync() {
    fetch('/api/sync/cancel', {method: 'POST'});
    if (currentES) currentES.close();
    _syncRunning = false;
    showToast('Sync cancelled', 'warning');
}
function cancelPipeline() {
    fetch('/api/pipeline/cancel', {method: 'POST'});
    if (pipelineES) pipelineES.close();
    _pipelineRunning = false;
    showToast('Pipeline cancelled', 'warning');
}
</script>
{% endblock %}
