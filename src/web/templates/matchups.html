{% extends "base.html" %}
{% block content %}
<div class="page-header">
  <h1 class="page-title">Matchups</h1>
  {% if game_start_iso %}
  <div id="countdown" class="countdown" data-start="{{ game_start_iso }}">
    <span class="countdown-label">Starts in:</span>
    <span class="countdown-time">--:--:--</span>
  </div>
  {% endif %}
</div>

<div class="card">
  <h2>Analyze Matchup</h2>
  <form method="get" action="/matchups">
    <div class="form-row">
      <div class="form-group">
        <label for="home">Home Team</label>
        <select name="home_team_id" id="home">
          {% for t in teams %}
          <option value="{{ t.id }}" {% if home_team_id == t.id %}selected{% endif %}>
            {{ t.abbr }} - {{ t.name }}
          </option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group">
        <label for="away">Away Team</label>
        <select name="away_team_id" id="away">
          {% for t in teams %}
          <option value="{{ t.id }}" {% if away_team_id == t.id %}selected{% endif %}>
            {{ t.abbr }} - {{ t.name }}
          </option>
          {% endfor %}
        </select>
      </div>
    </div>
    <button type="submit">Analyze Matchup</button>
  </form>
</div>

{% if error %}
<div class="error-box">{{ error }}</div>
{% endif %}

{% if prediction %}
<!-- Prediction Summary -->
<div class="card">
  <h2>Prediction Summary</h2>
  <div class="stats-grid">
    <div class="stat-item">
      <div class="stat-value">{{ "%+.1f"|format(prediction.predicted_spread) }}</div>
      <div class="stat-label">Spread (Home)</div>
    </div>
    <div class="stat-item">
      <div class="stat-value">{{ "%.1f"|format(prediction.predicted_total) }}</div>
      <div class="stat-label">Over/Under</div>
    </div>
    <div class="stat-item">
      <div class="stat-value">{{ "%.1f"|format(prediction.home_projected) }}</div>
      <div class="stat-label">Home Projected</div>
    </div>
    <div class="stat-item">
      <div class="stat-value">{{ "%.1f"|format(prediction.away_projected) }}</div>
      <div class="stat-label">Away Projected</div>
    </div>
  </div>

  <!-- Injury Impact -->
  {% if home_injury or away_injury %}
  <h3>Injury Impact</h3>
  <div class="injury-summary">
    {% if home_injury %}
    <div class="injury-item {{ home_injury.status }}">
      <strong>{{ home_stats.team_abbr }}:</strong> 
      {{ home_injury.text }}
      {% if home_injury.lost_ppg > 0 %}
        (-{{ "%.1f"|format(home_injury.lost_ppg) }} PPG
        {%- if home_injury.lost_rpg > 0 %}, -{{ "%.1f"|format(home_injury.lost_rpg) }} RPG{% endif %}
        {%- if home_injury.lost_apg > 0 %}, -{{ "%.1f"|format(home_injury.lost_apg) }} APG{% endif %})
      {% endif %}
    </div>
    {% endif %}
    {% if away_injury %}
    <div class="injury-item {{ away_injury.status }}">
      <strong>{{ away_stats.team_abbr }}:</strong>
      {{ away_injury.text }}
      {% if away_injury.lost_ppg > 0 %}
        (-{{ "%.1f"|format(away_injury.lost_ppg) }} PPG
        {%- if away_injury.lost_rpg > 0 %}, -{{ "%.1f"|format(away_injury.lost_rpg) }} RPG{% endif %}
        {%- if away_injury.lost_apg > 0 %}, -{{ "%.1f"|format(away_injury.lost_apg) }} APG{% endif %})
      {% endif %}
    </div>
    {% endif %}
  </div>
  {% endif %}
</div>

<!-- Efficiency Comparison -->
{% if home_stats and away_stats %}
<div class="card">
  <h2>Efficiency Comparison</h2>
  <div class="scroll-x">
    <table>
      <thead>
        <tr>
          <th>Metric</th>
          <th>{{ home_stats.team_abbr }} (Home)</th>
          <th>{{ away_stats.team_abbr }} (Away)</th>
          <th>Edge</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><strong>Offensive Rating</strong></td>
          <td>{{ "%.1f"|format(home_stats.offensive_rating) }}</td>
          <td>{{ "%.1f"|format(away_stats.offensive_rating) }}</td>
          <td>{{ home_stats.team_abbr if home_stats.offensive_rating > away_stats.offensive_rating else away_stats.team_abbr }}</td>
        </tr>
        <tr>
          <td><strong>Defensive Rating</strong></td>
          <td>{{ "%.1f"|format(home_stats.defensive_rating) }}</td>
          <td>{{ "%.1f"|format(away_stats.defensive_rating) }}</td>
          <td>{{ home_stats.team_abbr if home_stats.defensive_rating < away_stats.defensive_rating else away_stats.team_abbr }}</td>
        </tr>
        <tr>
          <td><strong>Net Rating</strong></td>
          <td>{{ "%+.1f"|format(home_stats.net_rating) }}</td>
          <td>{{ "%+.1f"|format(away_stats.net_rating) }}</td>
          <td>{{ home_stats.team_abbr if home_stats.net_rating > away_stats.net_rating else away_stats.team_abbr }}</td>
        </tr>
        <tr>
          <td><strong>Pace</strong></td>
          <td>{{ "%.1f"|format(home_stats.pace) }}</td>
          <td>{{ "%.1f"|format(away_stats.pace) }}</td>
          <td>{{ "%.1f"|format((home_stats.pace + away_stats.pace) / 2) }} avg</td>
        </tr>
        <tr>
          <td><strong>True Shooting %</strong></td>
          <td>{{ "%.1f"|format(home_stats.team_ts_pct) }}%</td>
          <td>{{ "%.1f"|format(away_stats.team_ts_pct) }}%</td>
          <td>{{ home_stats.team_abbr if home_stats.team_ts_pct > away_stats.team_ts_pct else away_stats.team_abbr }}</td>
        </tr>
        <tr>
          <td><strong>Turnover Margin</strong></td>
          <td>{{ "%+.1f"|format(home_stats.turnover_margin) }}</td>
          <td>{{ "%+.1f"|format(away_stats.turnover_margin) }}</td>
          <td>{{ home_stats.team_abbr if home_stats.turnover_margin > away_stats.turnover_margin else away_stats.team_abbr }}</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Rebounding & Assists Matchup -->
<div class="card">
  <h2>Rebounding &amp; Assists Matchup</h2>
  <div class="stats-grid">
    <div class="stat-item">
      <div class="stat-value">{{ "%.1f"|format(home_stats.total_rpg) }}</div>
      <div class="stat-label">{{ home_stats.team_abbr }} RPG</div>
    </div>
    <div class="stat-item">
      <div class="stat-value">{{ "%.1f"|format(away_stats.total_rpg) }}</div>
      <div class="stat-label">{{ away_stats.team_abbr }} RPG</div>
    </div>
    <div class="stat-item">
      <div class="stat-value">{{ "%+.1f"|format(home_stats.total_rpg - away_stats.total_rpg) }}</div>
      <div class="stat-label">Rebound Diff</div>
    </div>
    <div class="stat-item">
      <div class="stat-value">{{ "%.1f"|format(home_stats.total_apg) }}</div>
      <div class="stat-label">{{ home_stats.team_abbr }} APG</div>
    </div>
    <div class="stat-item">
      <div class="stat-value">{{ "%.1f"|format(away_stats.total_apg) }}</div>
      <div class="stat-label">{{ away_stats.team_abbr }} APG</div>
    </div>
    <div class="stat-item">
      <div class="stat-value">{{ "%+.1f"|format(home_stats.total_apg - away_stats.total_apg) }}</div>
      <div class="stat-label">Assist Diff</div>
    </div>
  </div>
</div>

<!-- Recent Form & Strength of Schedule -->
<div class="card">
  <h2>Recent Form &amp; Schedule Strength</h2>
  <div class="stats-grid">
    <div class="stat-item">
      <div class="stat-value">{{ "%.1f"|format(home_stats.recent_ppg) }}</div>
      <div class="stat-label">{{ home_stats.team_abbr }} Last 5 PPG</div>
      <div class="stat-sub">
        {% if home_stats.recent_ppg > home_stats.total_ppg %}
          Trending Up (+{{ "%.1f"|format(home_stats.recent_ppg - home_stats.total_ppg) }})
        {% elif home_stats.recent_ppg < home_stats.total_ppg %}
          Trending Down ({{ "%.1f"|format(home_stats.recent_ppg - home_stats.total_ppg) }})
        {% else %}
          Steady
        {% endif %}
      </div>
    </div>
    <div class="stat-item">
      <div class="stat-value">{{ "%.1f"|format(away_stats.recent_ppg) }}</div>
      <div class="stat-label">{{ away_stats.team_abbr }} Last 5 PPG</div>
      <div class="stat-sub">
        {% if away_stats.recent_ppg > away_stats.total_ppg %}
          Trending Up (+{{ "%.1f"|format(away_stats.recent_ppg - away_stats.total_ppg) }})
        {% elif away_stats.recent_ppg < away_stats.total_ppg %}
          Trending Down ({{ "%.1f"|format(away_stats.recent_ppg - away_stats.total_ppg) }})
        {% else %}
          Steady
        {% endif %}
      </div>
    </div>
    <div class="stat-item">
      <div class="stat-value">{{ "%+.1f"|format(home_stats.sos) }}</div>
      <div class="stat-label">{{ home_stats.team_abbr }} SOS</div>
      <div class="stat-sub">
        {% if home_stats.sos > 2 %}Strong schedule
        {% elif home_stats.sos < -2 %}Weak schedule
        {% else %}Average schedule{% endif %}
      </div>
    </div>
    <div class="stat-item">
      <div class="stat-value">{{ "%+.1f"|format(away_stats.sos) }}</div>
      <div class="stat-label">{{ away_stats.team_abbr }} SOS</div>
      <div class="stat-sub">
        {% if away_stats.sos > 2 %}Strong schedule
        {% elif away_stats.sos < -2 %}Weak schedule
        {% else %}Average schedule{% endif %}
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Historical Performance -->
{% if backtest %}
<div class="card">
  <h2>Historical Performance</h2>
  <div class="stats-grid">
    <div class="stat-item">
      <div class="stat-value">{{ backtest.home_record.wins }}-{{ backtest.home_record.losses }}</div>
      <div class="stat-label">{{ backtest.home_abbr }} at Home</div>
      <div class="stat-sub">Avg {{ "%.1f"|format(backtest.home_record.avg_pts) }} pts</div>
    </div>
    <div class="stat-item">
      <div class="stat-value">{{ backtest.away_record.wins }}-{{ backtest.away_record.losses }}</div>
      <div class="stat-label">{{ backtest.away_abbr }} on Road</div>
      <div class="stat-sub">Avg {{ "%.1f"|format(backtest.away_record.avg_pts) }} pts</div>
    </div>
  </div>

  {% if backtest.h2h_games %}
  <h3>Head-to-Head This Season</h3>
  <div class="scroll-x">
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Score</th>
          <th>Winner</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody>
        {% for g in backtest.h2h_games %}
        <tr>
          <td>{{ g.date }}</td>
          <td>{{ g.away_score }}-{{ g.home_score }}</td>
          <td>{{ g.winner }}</td>
          <td>{{ g.home_score + g.away_score }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <p class="text-muted">No head-to-head games this season</p>
  {% endif %}
</div>
{% endif %}

<!-- Home Team Players -->
{% if home_players %}
<div class="card">
  <h2>{{ home_stats.team_abbr }} Players (Home)</h2>
  <div class="scroll-x">
    <table>
      <thead>
        <tr>
          <th>Player</th>
          <th>Pos</th>
          <th>PPG</th>
          <th>RPG</th>
          <th>APG</th>
          <th>MPG</th>
          <th>Home</th>
          <th>Away</th>
          <th>vs Opp</th>
          <th>Proj</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        {% for p in home_players %}
        <tr class="{{ 'text-danger' if p.is_injured else '' }}">
          <td>{{ p.name }}</td>
          <td>{{ p.position }}</td>
          <td>{{ "%.1f"|format(p.ppg) }}</td>
          <td>{{ "%.1f"|format(p.rpg) }}</td>
          <td>{{ "%.1f"|format(p.apg) }}</td>
          <td>{{ "%.1f"|format(p.mpg) }}</td>
          <td>{{ "%.1f"|format(p.ppg_home) }}</td>
          <td>{{ "%.1f"|format(p.ppg_away) }}</td>
          <td>{{ "%.1f"|format(p.ppg_vs_opp) if p.ppg_vs_opp else '--' }}</td>
          <td>{{ "%.1f"|format(p.projected) }}</td>
          <td>{{ 'INJ' if p.is_injured else 'OK' }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endif %}

<!-- Away Team Players -->
{% if away_players %}
<div class="card">
  <h2>{{ away_stats.team_abbr }} Players (Away)</h2>
  <div class="scroll-x">
    <table>
      <thead>
        <tr>
          <th>Player</th>
          <th>Pos</th>
          <th>PPG</th>
          <th>RPG</th>
          <th>APG</th>
          <th>MPG</th>
          <th>Home</th>
          <th>Away</th>
          <th>vs Opp</th>
          <th>Proj</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        {% for p in away_players %}
        <tr class="{{ 'text-danger' if p.is_injured else '' }}">
          <td>{{ p.name }}</td>
          <td>{{ p.position }}</td>
          <td>{{ "%.1f"|format(p.ppg) }}</td>
          <td>{{ "%.1f"|format(p.rpg) }}</td>
          <td>{{ "%.1f"|format(p.apg) }}</td>
          <td>{{ "%.1f"|format(p.mpg) }}</td>
          <td>{{ "%.1f"|format(p.ppg_home) }}</td>
          <td>{{ "%.1f"|format(p.ppg_away) }}</td>
          <td>{{ "%.1f"|format(p.ppg_vs_opp) if p.ppg_vs_opp else '--' }}</td>
          <td>{{ "%.1f"|format(p.projected) }}</td>
          <td>{{ 'INJ' if p.is_injured else 'OK' }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endif %}
{% endif %}

<!-- Upcoming Games -->
<div class="card">
  <h2>Upcoming Games</h2>
  <p class="text-muted">Tap a game to analyze</p>
  {% if games %}
  <div class="games-list">
    {% for g in games[:100] %}
    <a href="/matchups?home_team_id={{ g.home_team_id }}&away_team_id={{ g.away_team_id }}" 
       class="game-row {% if home_team_id == g.home_team_id and away_team_id == g.away_team_id %}active{% endif %}">
      <span class="game-date">{{ g.game_date }}</span>
      <span class="game-teams">
        <span class="away">{{ g.away_abbr }}</span>
        <span class="at">@</span>
        <span class="home">{{ g.home_abbr }}</span>
      </span>
    </a>
    {% endfor %}
  </div>
  {% else %}
  <div class="empty-state">
    <p>No upcoming games</p>
    <p class="text-muted">Run sync from Dashboard</p>
  </div>
  {% endif %}
</div>

{% if game_start_iso %}
<script>
(function() {
  const countdownEl = document.getElementById('countdown');
  if (!countdownEl) return;
  
  const startTime = new Date(countdownEl.dataset.start);
  const timeEl = countdownEl.querySelector('.countdown-time');
  const labelEl = countdownEl.querySelector('.countdown-label');
  
  function updateCountdown() {
    const now = new Date();
    const diff = startTime - now;
    
    if (diff <= 0) {
      labelEl.textContent = '';
      timeEl.textContent = 'LIVE';
      timeEl.classList.add('live');
      return;
    }
    
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    const secs = Math.floor((diff % (1000 * 60)) / 1000);
    
    let timeStr = '';
    if (days > 0) {
      timeStr = days + 'd ' + hours + 'h ' + mins + 'm';
    } else if (hours > 0) {
      timeStr = hours + 'h ' + mins + 'm ' + secs + 's';
    } else {
      timeStr = mins + 'm ' + secs + 's';
    }
    
    timeEl.textContent = timeStr;
  }
  
  updateCountdown();
  setInterval(updateCountdown, 1000);
})();
</script>
{% endif %}
{% endblock %}
